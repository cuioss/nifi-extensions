= NiFi JWT Authentication Processor
:toc:
:toclevels: 2

image:https://github.com/cuioss/nifi-extensions/actions/workflows/maven.yml/badge.svg[Java CI with Maven,link=https://github.com/cuioss/nifi-extensions/actions/workflows/maven.yml]
image:https://github.com/cuioss/nifi-extensions/actions/workflows/e2e-tests.yml/badge.svg[End-to-End Tests,link=https://github.com/cuioss/nifi-extensions/actions/workflows/e2e-tests.yml]
image:https://github.com/cuioss/nifi-extensions/actions/workflows/integration-tests.yml/badge.svg[Integration Tests,link=https://github.com/cuioss/nifi-extensions/actions/workflows/integration-tests.yml]

image:https://img.shields.io/badge/Apache%20NiFi-2.7.2-1f6aa5[Apache NiFi,link=https://nifi.apache.org/]
image:https://img.shields.io/badge/Java-21-ed8b00[Java 21,link=https://openjdk.org/projects/jdk/21/]
image:http://img.shields.io/:license-apache-blue.svg[License,link=http://www.apache.org/licenses/LICENSE-2.0.html]
image:https://img.shields.io/maven-central/v/de.cuioss.nifi/nifi-extensions.svg?label=Maven%20Central["Maven Central", link="https://search.maven.org/artifact/de.cuioss.nifi/nifi-extensions"]

https://sonarcloud.io/summary/new_code?id=cuioss_nifi-extensions[image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_nifi-extensions&metric=alert_status[Quality Gate Status]]
image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_nifi-extensions&metric=ncloc[Lines of Code,link=https://sonarcloud.io/summary/new_code?id=cuioss_nifi-extensions]
image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_nifi-extensions&metric=coverage[Coverage,link=https://sonarcloud.io/summary/new_code?id=cuioss_nifi-extensions]

== What is it?

A custom https://nifi.apache.org/[Apache NiFi] processor that validates JWT tokens against multiple identity providers in a single flow. It validates JWT signatures, checks expiration and audience claims, and supports multiple identity providers (e.g. Keycloak, Entra ID, Auth0) simultaneously -- with automatic JWKS key rotation and caching.

== The Problem

NiFi flows that consume REST APIs or process webhook payloads often receive JWT-authenticated requests. Out of the box, NiFi has no processor to validate these tokens. This forces teams to either:

* write custom scripts inside `ExecuteScript` processors with no key rotation or caching,
* call an external validation service, adding latency and a point of failure, or
* skip token validation entirely and trust the upstream reverse proxy.

== The Solution

This processor drops into any NiFi flow as a single node. It reads the JWT from a FlowFile attribute, validates it against one or more JWKS endpoints via a shared Controller Service, and writes the token claims as FlowFile attributes -- ready for downstream routing and processing.

image::doc/plantuml/jwt-token-flow.png[JWT Token Processing Flow]

== Installation

You need **two NAR files** (NiFi Archives):

* **`nifi-cuioss-api-nar`** -- Controller Service API interfaces (required by NiFi 2.x classloader separation)
* **`nifi-cuioss-nar`** -- Processors, Controller Service implementation, configuration UI, and all dependencies

NiFi 2.x requires that Controller Service API interfaces reside in a separate NAR from their implementations. Both NARs must be deployed together.

=== From a Release

. Download both `nifi-cuioss-api-nar-<version>.nar` and `nifi-cuioss-nar-<version>.nar` from https://github.com/cuioss/nifi-extensions/releases[GitHub Releases] or https://search.maven.org/artifact/de.cuioss.nifi/nifi-cuioss-nar[Maven Central].
. Copy both NARs into your NiFi extensions directory:
+
[source,bash]
----
cp nifi-cuioss-api-nar-*.nar nifi-cuioss-nar-*.nar $NIFI_HOME/extensions/
----
. Restart NiFi (or wait for NiFi's auto-detection if configured).
. The processor **MultiIssuerJWTTokenAuthenticator** appears in the "Add Processor" dialog under the tags `jwt`, `oauth`, `authentication`.

=== From Source

[source,bash]
----
git clone https://github.com/cuioss/nifi-extensions.git
cd nifi-extensions
./mvnw clean install -DskipTests
cp nifi-cuioss-api-nar/target/nifi-cuioss-api-nar-*.nar \
   nifi-cuioss-nar/target/nifi-cuioss-nar-*.nar \
   $NIFI_HOME/extensions/
----

=== Docker / Kubernetes

Mount or copy both NARs into the container's extensions directory:

[source,yaml]
----
# Docker Compose example
services:
  nifi:
    image: apache/nifi:2.7.2
    volumes:
      - ./nars/:/opt/nifi/nifi-current/extensions/:ro
----

The `nars/` directory must contain both `nifi-cuioss-api-nar-<version>.nar` and `nifi-cuioss-nar-<version>.nar`.

== Configuration

The processor can be configured through three methods (in order of precedence):

. **Static configuration files** -- for automated / container deployments
. **Environment variables** -- for container orchestration (Kubernetes, Docker)
. **NiFi UI** -- interactive configuration with built-in JWKS validation and token testing

See the link:doc/guides/QuickStart.adoc[Quick Start Guide] for a step-by-step walkthrough covering processor properties, issuer configuration, relationships, output attributes, static files, and environment variables.

=== Working Example: Integration Test Flow

The integration tests include a complete NiFi flow definition that demonstrates the processor in action with a real Keycloak identity provider.
The flow is defined in link:integration-testing/src/main/docker/nifi/conf/flow.json[flow.json] and implements a JWT authentication gateway:

* **HandleHttpRequest** accepts incoming HTTP on port 7777
* **MultiIssuerJWTTokenAuthenticator** validates the JWT and checks roles
* Authorized requests (HTTP 200) and rejected requests (HTTP 401) are routed through separate paths
* Response bodies contain the `jwt.*` attributes as JSON for inspection

The authenticator is configured with one Keycloak issuer:

[source]
----
issuer.keycloak.jwks-url = http://keycloak:8080/realms/oauth_integration_tests/protocol/openid-connect/certs
issuer.keycloak.issuer    = http://keycloak:8080/realms/oauth_integration_tests
issuer.keycloak.required-roles = read
----

To run the full integration test suite locally:

[source,bash]
----
./mvnw verify -Pintegration-tests
----

See link:integration-testing/doc/flow-pipeline.adoc[Flow Pipeline Design] for the complete pipeline architecture and test scenarios.

== Components

[cols="1,3"]
|===
|Module |Purpose

|link:nifi-cuioss-api/[nifi-cuioss-api]
|Controller Service API interfaces (`JwtIssuerConfigService`, `JwtAuthenticationConfig`)

|link:nifi-cuioss-api-nar/[nifi-cuioss-api-nar]
|NiFi Archive (NAR) for the API -- required by NiFi 2.x classloader separation

|link:nifi-cuioss-common/[nifi-cuioss-common]
|Shared JWT infrastructure: Controller Service implementation, configuration, utilities

|link:nifi-cuioss-processors/README.md[nifi-cuioss-processors]
|JWT processor implementation

|link:nifi-cuioss-ui/[nifi-cuioss-ui]
|Custom NiFi UI with JWKS validation, token verification, and metrics tabs

|link:nifi-cuioss-nar/[nifi-cuioss-nar]
|NiFi Archive (NAR) -- the main deployable artifact bundling processors + UI

|link:integration-testing/README.adoc[integration-testing]
|Docker-based test environment (NiFi + Keycloak)

|link:e-2-e-playwright/README.adoc[e-2-e-playwright]
|Playwright E2E and WCAG accessibility tests
|===

== Documentation

=== Specifications

* link:doc/Requirements.adoc[Requirements]
* link:doc/Specification.adoc[Specification]
* link:doc/specification/configuration.adoc[Configuration Reference]
* link:doc/specification/configuration-static.adoc[Static Configuration & Container Deployment]
* link:doc/specification/configuration-ui.adoc[UI Configuration]
* link:doc/specification/security.adoc[Security]
* link:doc/specification/token-validation.adoc[Token Validation]
* link:doc/specification/technical-components.adoc[Technical Components]

=== Guides

* link:doc/guides/QuickStart.adoc[Quick Start Guide] -- get running in under 5 minutes
* link:doc/guides/IssuerConfigPropertiesGuide.adoc[Issuer Configuration Walkthrough] -- step-by-step UI configuration with test environment and troubleshooting

=== Testing

* link:integration-testing/README.adoc[Integration Testing Environment] -- Docker setup with NiFi and Keycloak
* link:e-2-e-playwright/README.adoc[End-to-End Testing] -- Playwright tests for processor UI and WCAG compliance
* link:e-2-e-playwright/docs/accessibility-testing-guide.adoc[Accessibility Testing Guide]

=== Development

* link:doc/specification/error-handling.adoc[Error Handling]
* link:doc/specification/internationalization.adoc[Internationalization]
* link:doc/specification/observability.adoc[Observability & Metrics]
* link:doc/LogMessages.adoc[Log Messages Reference]

== Building

[source,bash]
----
./mvnw clean install                    # Full build with tests
./mvnw clean install -DskipTests        # Build without tests
----

=== Code Quality

[source,bash]
----
./mvnw -Ppre-commit clean install -DskipTests   # Pre-commit quality checks
./mvnw clean verify -Psonar                      # SonarQube analysis
----

This project follows centralized coding standards from https://github.com/cuioss/cui-llm-rules[cui-llm-rules] covering https://github.com/cuioss/cui-llm-rules/tree/main/standards/java[Java], https://github.com/cuioss/cui-llm-rules/tree/main/standards/javascript[JavaScript], https://github.com/cuioss/cui-llm-rules/tree/main/standards/testing[testing], and https://github.com/cuioss/cui-llm-rules/tree/main/standards/documentation[documentation].

=== Integration & E2E Tests

[source,bash]
----
# Start Docker test environment (NiFi + Keycloak)
./integration-testing/src/main/docker/run-and-deploy.sh

# Run integration tests via Maven
./mvnw verify -Pintegration-tests

# Run Playwright E2E tests directly
cd e-2-e-playwright && npm run playwright:test
----

See link:integration-testing/README.adoc[Integration Testing] and link:e-2-e-playwright/README.adoc[E2E Testing] for detailed instructions.
