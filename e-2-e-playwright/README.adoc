= NiFi Extensions End-to-End Playwright Tests
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

End-to-end tests for NiFi Extensions using the Playwright testing framework.
Tests validate JWT processor functionality, custom UI components, and WCAG accessibility in a live NiFi + Keycloak environment.

== Maven Coordinates

[source,xml]
----
<dependency>
    <groupId>de.cuioss.nifi</groupId>
    <artifactId>e-2-e-playwright</artifactId>
</dependency>
----

Packaging type is `pom` — this module is not consumed as a library dependency.

== Module Structure

[source]
----
e-2-e-playwright/
├── config/                    # Test configuration
│   ├── accessibility-config.js   # WCAG 2.1 Level AA axe-core rules
│   └── console-error-config.js   # Console error pattern definitions
├── fixtures/                  # Playwright test fixtures
│   ├── auth-fixtures.js          # Authentication fixtures
│   └── test-fixtures.js          # Consolidated fixtures (logging, a11y, processor)
├── pages/                     # Page Object Model
│   ├── LoginPage.js              # Login page interactions
│   ├── CanvasPage.js             # NiFi canvas interactions
│   └── index.js                  # Page fixtures and exports
├── tests/                     # Test specifications
│   ├── self-*.spec.js            # Self-tests (framework validation)
│   ├── 0x-*.spec.js              # Functional tests (processor features)
│   └── accessibility-*.spec.js   # WCAG compliance tests
├── utils/                     # Utility services
│   ├── auth-service.js           # API token-based authentication
│   ├── processor.js              # Processor discovery and verification
│   ├── processor-api-manager.js  # REST API-based processor management
│   ├── processor-setup-helper.js # Test setup/teardown helpers
│   ├── navigation-utils.js       # Page navigation and verification
│   ├── constants.js              # Selectors, credentials, URLs
│   ├── keycloak-token-service.js # Keycloak token acquisition
│   ├── accessibility-helper.js   # axe-playwright integration
│   ├── console-logger.js         # Browser console capture
│   ├── critical-error-detector.js# Critical error pattern matching
│   ├── shared-logger.js          # Structured logging utilities
│   └── test-error-handler.js     # Test error handling
├── scripts/                   # Utility scripts
│   ├── run-tests-with-precheck.js# Self-test gating before functional tests
│   ├── global-teardown.js        # Post-test cleanup
│   ├── selector-inspector.js     # Selector discovery tool
│   ├── verify-setup.js           # Environment verification
│   └── setup-accessibility-tests.js
├── docs/                      # Detailed documentation
├── playwright.config.js       # Playwright configuration
├── package.json               # npm configuration
└── pom.xml                    # Maven integration
----

== Test Categories

Tests are organized into three categories, executed in order:

=== Self-Tests (`self-*.spec.js`)

Framework validation tests that verify prerequisites before functional tests run.
Covers login, navigation, browser logging, critical error detection, and processor interaction.

=== Functional Tests (`0x-*.spec.js`)

Tests for specific JWT processor features: custom UI tabs, JWKS validation, token verification, metrics, and help content.

=== Accessibility Tests (`accessibility-*.spec.js`)

WCAG 2.1 Level AA compliance testing using axe-playwright.
See xref:docs/accessibility-testing-guide.adoc[Accessibility Testing Guide] for details.

== Prerequisites

Tests require a running NiFi + Keycloak environment:

1. *NiFi* accessible at `PLAYWRIGHT_BASE_URL` (default: `https://localhost:9095/nifi`)
2. *Keycloak* accessible at `PLAYWRIGHT_KEYCLOAK_URL` (default: `http://localhost:9080`)
3. *Test credentials* configured in `utils/constants.js` must be valid

=== Starting the Test Environment

[source,bash]
----
# Build NAR, start Keycloak + NiFi containers (first time or after stop)
./integration-testing/src/main/docker/run-and-deploy.sh

# Quick redeploy after code changes (preserves running containers)
./integration-testing/src/main/docker/redeploy-nifi.sh

# Stop all containers
./integration-testing/src/main/docker/stop-test-container.sh
----

The `run-and-deploy.sh` script builds the NAR file, starts Keycloak (with health check), then starts NiFi.
Once running, NiFi is available at `https://localhost:9095/nifi` and Keycloak at `http://localhost:9080`.

== Running Tests

=== Via Maven (recommended for CI)

Tests are *skipped by default*. The `integration-tests` profile enables them and manages Docker containers automatically:

[source,bash]
----
# Full integration test suite: starts containers → self-tests → functional → accessibility → stops containers
./mvnw clean verify -pl e-2-e-playwright -Pintegration-tests
----

Maven separates results into distinct directories:

* `target/results-selftests/` — self-test artifacts
* `target/results-functional-tests/` — functional test artifacts
* `target/results-accessibility-tests/` — accessibility test artifacts

=== Via npm (for development)

Requires a running NiFi + Keycloak environment.

[source,bash]
----
# All tests with self-test pre-check gating
npm test

# Direct Playwright execution
npm run playwright:test

# Headed mode (visible browser)
npm run playwright:test:headed

# Interactive UI mode
npm run playwright:test:ui
----

=== Targeted Test Execution

[source,bash]
----
# Self-tests only
npm run test:self

# JWT-related tests with pre-checks
npm run test:jwt

# Accessibility tests
npm run test:a11y              # Standard
npm run test:a11y:full         # With HTML report
npm run test:a11y:quick        # Quick WCAG check only

# Skip self-test pre-checks
npm run test:no-precheck
----

== Code Quality

[source,bash]
----
# ESLint
npm run lint                   # Check
npm run lint:fix               # Auto-fix
npm run lint:strict            # Strict mode (max 25 warnings)

# Prettier
npm run format:check           # Verify formatting
npm run format                 # Auto-format

# Log analysis
npm run analyze:console        # Basic console log analysis
npm run analyze:logs           # Enhanced log analysis
----

== Configuration

=== Playwright (`playwright.config.js`)

* *Browser*: Chromium only (enterprise standard, best Playwright support)
* *Reporters*: JSON (`target/test-results.json`), JUnit (`target/junit-results.xml`), list
* *Artifacts*: Trace, screenshots, and video are all `on` by default
* *Parallel*: `fullyParallel: true`, 1 worker locally, 2 in CI
* *Timeouts*: 60s test, 15s expect, 10s action, 30s navigation

=== Test Artifacts

All artifacts are stored under `target/`:

[cols="1,2"]
|===
|Path |Contents

|`target/test-results/`
|Test execution artifacts (traces, screenshots, videos)

|`target/test-results.json`
|JSON test results

|`target/junit-results.xml`
|JUnit XML results for CI

|`target/results-selftests/`
|Self-test artifacts (Maven integration-tests profile)

|`target/results-functional-tests/`
|Functional test artifacts (Maven integration-tests profile)

|`target/results-accessibility-tests/`
|Accessibility test artifacts (Maven integration-tests profile)
|===

All artifacts are cleaned by `mvn clean`.

== Environment Variables

[cols="2,3,2"]
|===
|Variable |Description |Default

|`PLAYWRIGHT_BASE_URL`
|NiFi base URL
|`https://localhost:9095/nifi`

|`PLAYWRIGHT_KEYCLOAK_URL`
|Keycloak URL
|`http://localhost:9080`

|`E2E_TIMEOUT`
|Test timeout in seconds
|`60`

|`E2E_EXPECT_TIMEOUT`
|Assertion timeout in seconds
|`15`

|`PLAYWRIGHT_TRACE`
|Trace recording (`off`, `on`, `retain-on-failure`)
|`on`

|`PLAYWRIGHT_SCREENSHOT`
|Screenshot capture (`off`, `on`, `only-on-failure`)
|`on`

|`PLAYWRIGHT_VIDEO`
|Video recording (`off`, `on`, `retain-on-failure`)
|`on`

|`PLAYWRIGHT_OUTPUT_DIR`
|Base output directory
|`target/`

|`TEST_RESULTS_DIR`
|Test results directory
|`target/test-results`

|`PLAYWRIGHT_REPORT_DIR`
|Report output directory
|`target/playwright-report`

|`CI`
|CI environment flag (affects workers, `forbidOnly`)
|(unset)
|===

== Architecture

=== Page Object Model

Tests use Page Objects (`pages/LoginPage.js`, `pages/CanvasPage.js`) available as Playwright fixtures:

[source,javascript]
----
import { test, expect, LoginPage, CanvasPage } from '../pages/index.js';

test('Authentication flow', async ({ loginPage, canvasPage }) => {
  await loginPage.login();
  await loginPage.verifyLoginSuccess();
  await canvasPage.verifyCanvasLoaded();
});
----

=== Test Fixtures

Fixtures in `fixtures/test-fixtures.js` provide automatic:

* Authentication setup
* Browser console log capture and file storage
* Critical error detection
* Accessibility helper injection
* Processor API manager

=== Processor Management

Two approaches for working with processors:

* *UI-based* (`utils/processor.js`) — Discover and verify processors on the canvas
* *API-based* (`utils/processor-api-manager.js`) — Manage processors via NiFi REST API (add, remove, start, stop)

See xref:docs/processor-api-manager-guide.adoc[Processor API Manager Guide] for details.

== Scope and Limitations

=== Supported Operations

* Authentication (Keycloak OAuth, API token-based)
* Canvas navigation and page verification
* Processor discovery, status checking, and property inspection
* Processor lifecycle via REST API (`ProcessorApiManager`)
* WCAG 2.1 Level AA accessibility testing
* Browser console log analysis

=== UI Automation Limitations

Due to NiFi's Angular Material UI complexity:

* Drag-and-drop operations are unreliable (use API-based management instead)
* Right-click context menus are inconsistent
* Complex multi-step UI workflows may not work reliably

== Related Documentation

=== Project Documentation

* xref:docs/accessibility-testing-guide.adoc[Accessibility Testing Guide] — WCAG compliance testing with axe-playwright
* xref:docs/processor-api-manager-guide.adoc[Processor API Manager Guide] — REST API-based processor management
* xref:docs/roundtrip-testing.adoc[Roundtrip Testing Guide] — Development workflow: modify, deploy, test, analyze
* xref:docs/nifi-ui-structure.adoc[NiFi UI Structure Guide] — NiFi UI selectors and authentication flow
* xref:docs/implementation-guide.adoc[Implementation Guide] — Test architecture and patterns

=== External Resources

* https://playwright.dev/docs/intro[Playwright Documentation]
* https://nifi.apache.org/docs.html[Apache NiFi Documentation]
* https://github.com/abhinaba-ghosh/axe-playwright[axe-playwright Documentation]
