= ProcessorApiManager - API-Based Processor Management Guide

== Overview

The `ProcessorApiManager` utility provides reliable, API-based management of the MultiIssuerJWTTokenAuthenticator processor on the NiFi canvas via the NiFi REST API, replacing UI-based interactions.

== Key Components

=== ProcessorApiManager (`utils/processor-api-manager.js`)

Core methods:

* *`ensureProcessorOnCanvas()`* — Ensures processor is on canvas (adds if missing). Throws on failure.
* *`verifyMultiIssuerJWTTokenAuthenticatorIsDeployed()`* — Checks if the processor type is available
* *`verifyMultiIssuerJWTTokenAuthenticatorIsOnCanvas()`* — Checks if the processor is on the canvas
* *`addMultiIssuerJWTTokenAuthenticatorOnCanvas(position)`* — Adds the processor at specified position
* *`removeMultiIssuerJWTTokenAuthenticatorFromCanvas()`* — Removes the processor from the canvas
* *`startProcessor()`* / *`stopProcessor()`* — Start/stop the processor

=== Setup Helper (`utils/processor-setup-helper.js`)

Simplified functions for test setup/teardown:

* *`setupMultiIssuerJWTAuthenticator(page, options)`* — Returns `true`/`false` (does not throw)
* *`cleanupMultiIssuerJWTAuthenticator(page)`* — Removes processor after tests
* *`verifyProcessorStatus(page)`* — Gets detailed processor status

== Usage Examples

=== Basic Usage

[source,javascript]
----
import { test, expect } from '@playwright/test';
import { ProcessorApiManager } from '../utils/processor-api-manager.js';
import { AuthService } from '../utils/auth-service.js';

test('My test that needs the processor', async ({ page }) => {
  const authService = new AuthService(page);
  await authService.ensureReady();

  const processorManager = new ProcessorApiManager(page);
  await processorManager.ensureProcessorOnCanvas();

  // Your test logic here...
});
----

=== Using the Setup Helper

[source,javascript]
----
import { test } from '@playwright/test';
import { setupMultiIssuerJWTAuthenticator } from '../utils/processor-setup-helper.js';

test.beforeEach(async ({ page }) => {
  const authService = new AuthService(page);
  await authService.ensureReady();

  const ready = await setupMultiIssuerJWTAuthenticator(page);
  if (!ready) {
    test.skip('Processor setup failed');
  }
});
----

NOTE: `setupMultiIssuerJWTAuthenticator()` returns `true`/`false` and does not throw.
`ProcessorApiManager.ensureProcessorOnCanvas()` throws on failure.

== API Endpoints Used

* `GET /nifi-api/flow/processor-types` — List available processor types
* `GET /nifi-api/process-groups/{id}/processors` — List processors on canvas
* `POST /nifi-api/process-groups/{id}/processors` — Add processor to canvas
* `DELETE /nifi-api/processors/{id}` — Remove processor from canvas
* `PUT /nifi-api/processors/{id}/run-status` — Start/stop processor
* `GET /nifi-api/processors/{id}` — Get processor details

== Troubleshooting

=== Processor Not Deployed
If `verifyMultiIssuerJWTTokenAuthenticatorIsDeployed()` returns false:

1. Ensure the processor NAR file is installed in NiFi
2. Restart NiFi after installing the NAR
3. Check NiFi logs for deployment errors

=== Authentication Issues (401/403)
1. Ensure proper authentication before API calls
2. Check that the token is being passed correctly
3. Verify user has permissions to manage processors

=== Self-Test

[source,bash]
----
npm test -- self-processor-api-manager.spec.js
----
