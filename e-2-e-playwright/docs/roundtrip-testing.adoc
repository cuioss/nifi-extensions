= UI Roundtrip Testing Guide
:toc: left
:toclevels: 2
:toc-title: Contents
:sectnums:
:source-highlighter: highlight.js

== Overview

Roundtrip testing workflow: modify code → deploy → test → analyze → repeat.

== Quick Start

[source,bash]
----
# Deploy changes
./integration-testing/src/main/docker/redeploy-nifi.sh

# Run test
cd e-2-e-playwright && npm run playwright:test -- tests/[test-file].spec.js

# Check results
ls -la target/test-results/*/
----

== Workflow Steps

=== 1. Make Code Changes

* UI components: `nifi-cuioss-ui/src/main/webapp/js/`
* Styles: `nifi-cuioss-ui/src/main/webapp/css/`
* HTML: `nifi-cuioss-ui/src/main/webapp/index.html`
* Backend: `nifi-cuioss-processors/src/main/java/`

=== 2. Build and Deploy

[source,bash]
----
# Initial start (first time or after stop)
./integration-testing/src/main/docker/run-and-deploy.sh

# Quick redeploy (preserves running container)
./integration-testing/src/main/docker/redeploy-nifi.sh

# Full restart (if container issues)
./integration-testing/src/main/docker/stop-test-container.sh
./integration-testing/src/main/docker/run-and-deploy.sh
----

=== 3. Run Tests

==== Maven Orchestration (Recommended)

The test suite is orchestrated by Maven with proper fail-fast behavior and separate result directories:

[source,bash]
----
# Run full integration test suite (self-tests → functional → accessibility)
./mvnw -pl e-2-e-playwright -Pintegration-tests clean verify

# Run specific test executions using Maven @ syntax:

# Start containers only
./mvnw -pl e-2-e-playwright exec:exec@start-containers

# Run only self-tests (assumes containers are running)
./mvnw -pl e-2-e-playwright exec:exec@run-selftests

# Run only functional tests (assumes containers are running)
./mvnw -pl e-2-e-playwright exec:exec@run-functional-tests

# Run only accessibility tests (assumes containers are running)
./mvnw -pl e-2-e-playwright exec:exec@run-accessibility-tests

# Stop containers only
./mvnw -pl e-2-e-playwright exec:exec@stop-containers

# Test results will be in separate directories:
# - target/results-selftests/       (self-test results)
# - target/results-functional-tests/ (functional test results)  
# - target/results-accessibility-tests/ (accessibility test results)
----

The Maven orchestration:

* Starts containers (NiFi and Keycloak) once
* Runs tests in order: self-tests → functional → accessibility
* Fails fast - if one test phase fails, subsequent phases don't run
* Stops containers after all tests complete
* Preserves all test artifacts in separate directories

==== Direct Test Execution (for development)

[source,bash]
----
# Single test
npm run playwright:test -- tests/specific-test.spec.js

# All tests
npm run playwright:test

# With UI (for debugging)
npm run playwright:test -- --ui

# Self-tests only
npm run test:self
----

==== Test Commands

* `mvnw -pl e-2-e-playwright -Pintegration-tests verify` - Run full test suite via Maven
* `npm run test` - Runs tests with self-test pre-checks (Playwright orchestration)
* `npm run test:self` - Runs only self-tests
* `npm run test:jwt` - Runs JWT-related tests with pre-checks
* `npm run test:all` - Runs all tests with pre-checks
* `npm run test:no-precheck` - Runs tests without pre-checks

==== Pre-check Validation

Self-tests validate:

* NiFi accessibility and login functionality
* Navigation patterns
* Critical error detection
* Browser console logging
* Processor interaction capabilities

If self-tests fail, the subsequent test phases won't run and you'll see clear error messages about what needs to be fixed.

=== 4. Analyze Failures

Test artifacts are stored in separate directories per test phase:

* `target/results-selftests/` - Self-test artifacts
* `target/results-functional-tests/` - Functional test artifacts
* `target/results-accessibility-tests/` - Accessibility test artifacts

Each directory contains:

* `test-results/` - Test execution artifacts
  * `console-logs.log` - Browser console output
  * `test-failed-*.png` - Failure screenshots
  * `video.webm` - Test execution recording
  * `trace.zip` - Detailed execution trace
* `playwright-report/` - HTML report

[source,bash]
----
# Find errors in specific test phase
grep -n "ERROR" target/results-functional-tests/test-results/*/console-logs.log

# View screenshot from failed functional test
open target/results-functional-tests/test-results/*/test-failed-*.png

# Analyze trace from accessibility test
npx playwright show-trace target/results-accessibility-tests/test-results/*/trace.zip

# Open HTML report for functional tests
npx playwright show-report target/results-functional-tests/playwright-report
----

=== 5. Fix and Repeat

Based on failure analysis:

* JavaScript errors → Fix in source files
* Missing elements → Update selectors or wait conditions
* 404 errors → Fix resource paths
* Timing issues → Add appropriate waits

Repeat steps 1-4 until tests pass.

== Common Issues

|===
| Issue | Solution

| WebJar 404s
| Fix paths in index.html (remove extra prefixes)

| MIME type errors  
| Check resource paths and server configuration

| Element not found
| Verify selector matches rendered HTML

| Timeout errors
| Add waits or increase timeout values

| Console errors
| Check browser console logs for JavaScript errors
|===

== Debug Techniques

**Disable strict error checking**:
[source,javascript]
----
await setupStrictErrorDetection(page, testInfo, false);
----

**Interactive debugging**:
[source,javascript]
----
await page.pause(); // Opens Playwright Inspector
----

**Capture intermediate state**:
[source,javascript]
----
await page.screenshot({ path: 'debug.png' });
----

== Build Commands

[source,bash]
----
# Build everything
./mvnw clean install -DskipTests

# Build specific module
./mvnw clean install -pl nifi-cuioss-ui -DskipTests

# Full build with tests
./mvnw clean verify
----

== Success Criteria

✓ All tests pass consistently  
✓ No console errors in browser  
✓ UI elements render correctly  
✓ Expected functionality works  

== Postconditions

Before committing changes, run final validation:

[source,bash]
----
# 1. Build entire project
./mvnw clean install

# 2. Run all E2E tests
./mvnw -B --no-transfer-progress clean verify -pl e-2-e-playwright -Pintegration-tests

# 3. If both pass → commit
git add .
git commit -m "feat: Description of changes"
----

Both commands must exit with code 0 before committing.