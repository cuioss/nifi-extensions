= UI Roundtrip Testing Guide
:toc: left
:toclevels: 2
:toc-title: Contents
:sectnums:
:source-highlighter: highlight.js

== Overview

Roundtrip testing workflow: modify code → deploy → test → analyze → repeat.

== Quick Start

[source,bash]
----
# Deploy changes
./integration-testing/src/main/docker/redeploy-nifi.sh

# Run test
cd e-2-e-playwright && npm run playwright:test -- tests/[test-file].spec.js

# Check results
ls -la target/test-results/*/
----

== Workflow Steps

=== 1. Make Code Changes

* UI components: `nifi-cuioss-ui/src/main/webapp/js/`
* Styles: `nifi-cuioss-ui/src/main/webapp/css/`
* HTML: `nifi-cuioss-ui/src/main/webapp/index.html`
* Backend: `nifi-cuioss-processors/src/main/java/`

=== 2. Build and Deploy

Use the deployment scripts in `integration-testing/src/main/docker/`:

[source,bash]
----
# Initial start (first time or after stop)
./integration-testing/src/main/docker/run-and-deploy.sh

# Quick redeploy (preserves running container)
./integration-testing/src/main/docker/redeploy-nifi.sh

# Full restart (if container issues)
./integration-testing/src/main/docker/stop-test-container.sh
./integration-testing/src/main/docker/run-and-deploy.sh
----

See `CLAUDE.md` "Docker E2E Deployment" section or the `/deploy` skill for the full deployment runbook.

=== 3. Run Tests

==== Maven Orchestration (Recommended)

[source,bash]
----
# Run full integration test suite (self-tests → functional → accessibility)
./mvnw -pl e-2-e-playwright -Pintegration-tests clean verify
----

Maven starts containers, runs tests in order (self-tests → functional → accessibility) with fail-fast behavior, and stops containers afterward.
Test results are stored in separate directories per phase under `target/`.

==== Direct Test Execution (for development)

[source,bash]
----
# Single test
npm run playwright:test -- tests/specific-test.spec.js

# All tests
npm run playwright:test

# With UI (for debugging)
npm run playwright:test -- --ui

# Self-tests only
npm run test:self
----

=== 4. Analyze Failures

Test artifacts are stored in separate directories per test phase:

* `target/results-selftests/` - Self-test artifacts
* `target/results-functional-tests/` - Functional test artifacts
* `target/results-accessibility-tests/` - Accessibility test artifacts

Each directory contains:

* `test-results/` - Execution artifacts (console-logs.log, screenshots, video, trace.zip)
* `playwright-report/` - HTML report

[source,bash]
----
# Find errors in specific test phase
grep -n "ERROR" target/results-functional-tests/test-results/*/console-logs.log

# View screenshot from failed test
open target/results-functional-tests/test-results/*/test-failed-*.png

# Analyze trace
npx playwright show-trace target/results-accessibility-tests/test-results/*/trace.zip
----

=== 5. Fix and Repeat

Based on failure analysis:

* JavaScript errors → Fix in source files
* Missing elements → Update selectors or wait conditions
* 404 errors → Fix resource paths
* Timing issues → Add appropriate waits

Repeat steps 1-4 until tests pass.

== Common Issues

|===
| Issue | Solution

| WebJar 404s
| Fix paths in index.html (remove extra prefixes)

| Element not found
| Verify selector matches rendered HTML

| Timeout errors
| Add waits or increase timeout values

| Port conflicts
| Stop existing containers: `cd integration-testing/src/main/docker && docker compose down -v`
|===

== Debug Techniques

**Interactive debugging**:
[source,javascript]
----
await page.pause(); // Opens Playwright Inspector
----

**Capture intermediate state**:
[source,javascript]
----
await page.screenshot({ path: 'debug.png' });
----

== Postconditions

Before committing, run full validation:

[source,bash]
----
# 1. Build entire project
./mvnw clean install

# 2. Run all E2E tests
./mvnw -B --no-transfer-progress clean verify -pl e-2-e-playwright -Pintegration-tests

# 3. If both pass → commit
----

Both commands must exit with code 0 before committing.
