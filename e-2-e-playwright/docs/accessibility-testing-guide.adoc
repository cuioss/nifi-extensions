= Accessibility Testing Guide
:toc: left
:toclevels: 2
:source-highlighter: highlight.js

== Overview

WCAG 2.1 Level AA compliance testing for the NiFi JWT Authenticator UI using `@axe-core/playwright` and custom checks.

=== Prerequisites

**CRITICAL**: Accessibility tests require a running NiFi instance with the JWT processor on the canvas.

1. NiFi running at https://localhost:9095/nifi
2. MultiIssuerJWTTokenAuthenticator on the canvas
3. Valid authentication credentials

=== Running Tests

[source,bash]
----
# Quick WCAG compliance check
npm run test:a11y:quick

# Full accessibility test suite
npm run test:a11y

# Generate HTML report
npm run test:a11y:full
----

Tests use a fail-fast approach — they terminate with clear error messages if NiFi or the processor is unavailable.

== Tested Components

[cols="1,2,3"]
|===
|Component |Selector |Requirements

|Tab Navigation
|`.jwt-tabs-header`
|Keyboard navigation, focus indicators, ARIA labels

|Configuration Form
|`#issuer-config`
|Form labels, required indicators, error messages

|Token Verifier
|`#token-verification`
|Textarea labels, result display, error handling

|Metrics Display
|`#metrics`
|Table headers, data labels, chart alternatives

|Help Content
|`.help-tab`
|Heading structure, link text, content structure
|===

== Writing Accessibility Tests

[source,javascript]
----
import { accessibilityTest, expect } from '../fixtures/test-fixtures.js';

accessibilityTest('Component accessibility', async ({ page, accessibilityHelper }) => {
  await page.goto('/nifi');
  await page.waitForLoadState('networkidle');

  const results = await accessibilityHelper.runWCAGCheck();
  expect(results.passed).toBe(true);
});
----

For component-specific checks:

[source,javascript]
----
accessibilityTest('Form accessibility', async ({ page, accessibilityHelper }) => {
  const result = await accessibilityHelper.checkComponent(
    '#issuer-config',
    'Configuration Form'
  );
  expect(result.passed).toBe(true);
});
----

== WCAG 2.1 Level AA Requirements

The framework checks these categories via axe-core (`wcag2aa`, `wcag21aa`, `best-practice` tags):

* **Perceivable** — Color contrast (4.5:1 minimum), alt text, color-independent information
* **Operable** — Keyboard navigation, visible focus indicators, no seizure-inducing content
* **Understandable** — Form labels, error identification, consistent navigation
* **Robust** — Valid markup, proper ARIA usage, screen reader compatibility

== Known Issues Management

[source,javascript]
----
export const KNOWN_ISSUES = {
  skipRules: [],          // Rule IDs to skip temporarily
  skipElements: [],       // CSS selectors to exclude
  expectedViolations: []  // Documented acceptable violations with reasons
};
----

== Maven Integration

Accessibility tests run via `exec-maven-plugin` in the `integration-test` phase when the `integration-tests` profile is active. They execute after self-tests and functional tests, with fail-fast behavior.

[source,bash]
----
# Full suite via Maven (starts containers, runs all phases, stops containers)
./mvnw -pl e-2-e-playwright -Pintegration-tests clean verify
----

== Troubleshooting

=== NiFi Service Not Available
----
CRITICAL FAILURE: NiFi service is not available at https://localhost:9095/nifi
----
Start NiFi: `./integration-testing/src/main/docker/run-and-deploy.sh`

=== JWT Processor Not Found
----
CRITICAL FAILURE: MultiIssuerJWTTokenAuthenticator processor not found on canvas!
----
The processor must be on the canvas. Tests using `processorManager` fixture handle this automatically.

=== Common Fixes

|===
| Issue | Fix

| Color contrast failures
| Ensure 4.5:1 ratio; run `npm run test:a11y -- --grep "color contrast"`

| Missing focus indicators
| Add `outline: 2px solid #0066cc; outline-offset: 2px` on `:focus`

| Form label issues
| Use `<label for="id">` or `aria-label` on every input
|===

== Resources

* https://www.w3.org/WAI/WCAG21/quickref/[WCAG 2.1 Quick Reference]
* https://github.com/dequelabs/axe-core-npm/tree/develop/packages/playwright[@axe-core/playwright Documentation]
* https://playwright.dev/docs/accessibility-testing[Playwright Accessibility Testing]
* https://www.w3.org/WAI/ARIA/apg/[ARIA Authoring Practices Guide]
