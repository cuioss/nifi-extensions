= Test Implementation Guide
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

How to write, organize, and debug Playwright tests for this module.

== Architecture Overview

[source]
----
e-2-e-playwright/
├── tests/                        # Test specifications
│   ├── self-*.spec.js           # Self-tests (framework validation)
│   ├── 0x-*.spec.js             # Functional tests (processor features)
│   └── accessibility-*.spec.js  # WCAG compliance tests
├── fixtures/                     # Playwright test fixtures (setup/teardown)
│   ├── auth-fixtures.js         # Authentication fixture
│   └── test-fixtures.js         # Consolidated: logging, a11y, processor
├── utils/                        # Service utilities and scripts
│   ├── auth-service.js          # API token-based authentication
│   ├── processor.js             # Processor discovery/verification
│   ├── processor-api-manager.js # NiFi REST API processor management
│   ├── processor-setup-helper.js# Test setup/teardown helpers
│   ├── navigation-utils.js      # Page navigation
│   ├── constants.js             # Selectors, credentials, URLs
│   ├── keycloak-token-service.js# Keycloak token acquisition
│   ├── accessibility-helper.js  # @axe-core/playwright integration
│   ├── critical-error-detector.js# Critical error pattern matching
│   ├── test-logger.js           # Unified per-test logging via testInfo.attach()
│   └── run-tests-with-precheck.js# Self-test gating before functional tests
└── docs/                         # Detailed documentation
----

== Writing Tests

=== Using Consolidated Fixtures (recommended)

The `test-fixtures.js` provides extended fixtures with automatic console logging and error detection:

[source,javascript]
----
import { test, expect } from '../fixtures/test-fixtures.js';

test('Test with full instrumentation', async ({ page, processorManager }) => {
  // Console logs are captured automatically
  // Critical errors are detected automatically
  // Browser logs are saved to files after each test
  // processorManager provides ProcessorApiManager instance
});
----

For accessibility testing with the `accessibilityHelper` fixture, use the `accessibilityTest` export:

[source,javascript]
----
import { accessibilityTest, expect } from '../fixtures/test-fixtures.js';

accessibilityTest('Accessibility check', async ({ page, accessibilityHelper }) => {
  // accessibilityHelper is only available via accessibilityTest, not test
  const results = await accessibilityHelper.runWCAGCheck();
});
----

=== Using the Processor API Manager

For tests that need processor lifecycle control:

[source,javascript]
----
import { test, expect } from '@playwright/test';
import { ProcessorApiManager } from '../utils/processor-api-manager.js';
import { AuthService } from '../utils/auth-service.js';

test('Processor management via API', async ({ page }) => {
  const authService = new AuthService(page);
  await authService.ensureReady();

  const manager = new ProcessorApiManager(page);
  await manager.ensureProcessorOnCanvas();

  // Test logic...
});
----

== Test Organization

=== Naming Convention

* `self-*.spec.js` — Framework validation (prefixed `self-`)
* `0x-*.spec.js` — Functional tests (numbered for execution order)
* `accessibility-*.spec.js` — WCAG compliance tests

=== Test Categories

[cols="1,2,3"]
|===
|Category |Purpose |Example

|Self-tests
|Validate testing infrastructure
|`self-login.spec.js`, `self-navigation.spec.js`

|Functional
|Test processor features
|`01-verify-configuration-tab.spec.js`

|Accessibility
|WCAG 2.1 Level AA compliance
|`accessibility-wcag-compliance.spec.js`
|===

=== Execution Order

When run via Maven (`-Pintegration-tests`), tests execute in order:

1. Self-tests — if these fail, subsequent phases are skipped
2. Functional tests
3. Accessibility tests

When using `npm test`, the `run-tests-with-precheck.js` script gates functional tests behind self-test success.

== Authentication

NiFi uses API token-based authentication (not form-based login):

[source,javascript]
----
// AuthService handles CSRF token + API token flow
const authService = new AuthService(page);
await authService.login();

// Or use auth-fixtures.js for automatic setup
import { test } from '../fixtures/auth-fixtures.js';
test('Authenticated test', async ({ authenticatedPage }) => {
  // Already authenticated
});
----

The authentication flow:

1. Navigate to NiFi to obtain CSRF token from cookies
2. POST to `/nifi-api/access/token` with credentials
3. Set JWT token for subsequent requests
4. Navigate to main canvas and verify

== Browser Configuration

Chromium only, with these launch arguments:

* `--disable-web-security` — cross-origin for testing
* `--no-sandbox` — CI compatibility
* `--ignore-certificate-errors` — self-signed certs in dev

== Debugging

=== Interactive Mode

[source,bash]
----
# Playwright UI mode
npm run playwright:test:ui

# Headed mode (visible browser)
npm run playwright:test:headed

# Single test file
npx playwright test tests/specific-test.spec.js
----

=== In-Test Debugging

[source,javascript]
----
// Pause execution and open Playwright Inspector
await page.pause();

// Capture intermediate state
await page.screenshot({ path: 'target/test-results/debug.png' });
----

=== Test Artifacts

After test runs, inspect:

* *Traces*: `npx playwright show-trace target/test-results/*/trace.zip`
* *Screenshots*: `target/test-results/screenshots/`
* *Videos*: `target/test-results/videos/`
* *Console logs*: Saved automatically by test fixtures to `target/logs/`

=== Container Logs

[source,bash]
----
# NiFi logs
docker compose -f integration-testing/src/main/docker/docker-compose.yml logs nifi

# Keycloak logs
docker compose -f integration-testing/src/main/docker/docker-compose.yml logs keycloak
----

== Common Failure Patterns

[cols="1,2"]
|===
|Pattern |Resolution

|`Timeout waiting for selector`
|Verify selector matches rendered HTML; increase timeout

|`Element is not visible`
|Add explicit wait for visibility before interaction

|`Navigation timeout exceeded`
|Check NiFi startup status; increase `navigationTimeout`

|`API login failed: 401`
|Verify Keycloak is running; check credentials in `constants.js`

|Flaky test results
|Add proper wait conditions; use `page.waitForLoadState('networkidle')`
|===

== Related Documentation

* xref:../README.adoc[E2E Playwright Tests] — Module overview, npm scripts, env vars
* xref:nifi-ui-structure.adoc[NiFi UI Structure Guide] — Selectors and authentication flow
* xref:processor-api-manager-guide.adoc[Processor API Manager Guide] — REST API processor management
* xref:accessibility-testing-guide.adoc[Accessibility Testing Guide] — WCAG compliance testing
* xref:roundtrip-testing.adoc[Roundtrip Testing Guide] — Development workflow
