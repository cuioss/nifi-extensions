= Implementation Plan: NiFi JWT Authenticator Missing Features
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

== Overview

This document outlines the implementation plan for completing the NiFi JWT Authenticator.

Last updated: 2025-07-28 (Branch: feature/p1-core-functionality)

=== Current Status

* ✅ *Phase 0*: Test Infrastructure - COMPLETED
* ✅ *Phase 1*: Core Functionality - COMPLETED (except YAML support - removed from scope)
* ✅ *Phase 2*: UI Enhancement - COMPLETED
  ** ✅ E2E test infrastructure complete
  ** ✅ REST API endpoints implemented (backend)
  ** ✅ UI components connected to REST endpoints
  ** ✅ Authentication implemented with API keys
  ** ✅ All frontend tests passing
  ** ✅ E2E test navigation pattern fixed (Right-click → Advanced menu)
  ** ✅ All E2E tests updated to use verified navigation utilities
  ** ⚠️ E2E test 07-verify-token-verification-api.spec.js remains skipped (deployment constraints)
* ❌ *Phase 3*: Observability - NOT STARTED
* ❌ *Phase 4*: Advanced Features - NOT STARTED
* ❌ *Phase 5*: Documentation & Polish - NOT STARTED

=== Completed Tasks

* Test infrastructure fixed (DynamicPropertyTestHelper)
* Authorization implementation (scope/role validation)
* Flow file attributes (jwt.scopes, jwt.roles, jwt.authorized)
* All 62 processor tests passing
* E2E test infrastructure improved (test error handler utility)
* Created E2E tests for all Phase 2 UI features (7 test files)
* Fixed ESLint warnings (reduced from 68 to 13, below 25 limit)
* Modernized E2E test structure with 2025 best practices
* Implemented service-oriented test architecture (AuthService, ConsoleLogger, CriticalErrorDetector)
* *COMPLETED (2025-01-27)*: Phase 2 UI Enhancement:
  ** Created shared IssuerConfigurationParser
  ** Implemented JwtVerificationServlet, JwksValidationServlet, MetricsServlet
  ** Added ApiKeyAuthenticationFilter for security
  ** Created supporting services (JwtValidationService, ProcessorConfigReader)
  ** Connected all UI components to REST endpoints
  ** Implemented authentication in apiClient.js
  ** Fixed jQuery compatibility issues (cash-dom)
  ** Fixed all frontend test failures
  ** Added E2E test mode support in servlets
  ** All builds pass successfully
* *COMPLETED (2025-07-28)*: E2E Test Navigation and Cleanup:
  ** Fixed E2E test navigation pattern (Right-click → Advanced menu → iframe)
  ** Updated all tests to use `setupAuthAwareErrorDetection` instead of `setupStrictErrorDetection`
  ** Implemented ProcessorService utility with verified navigation pattern
  ** Cleaned up processor.js - removed 275 lines of unused code (41% reduction)
  ** Removed completely unused utilities (accessibility-helper.js, test-orchestrator.js)
  ** Cleaned up console-logger.js - removed 628 lines (71% reduction)
  ** Total cleanup: ~1,025 lines of unused code removed across utilities

== E2E Test Navigation Pattern (CRITICAL)

=== Correct Navigation Flow
The custom UI is accessed through the NiFi processor's Advanced menu, NOT through a dialog tab:

1. Find the MultiIssuerJWTTokenAuthenticator processor on canvas
2. Right-click on the processor
3. Select "Advanced" from context menu
4. Custom UI loads in an iframe
5. Navigate tabs within the iframe

=== Verified Utility Pattern
All E2E tests must use this pattern:
```javascript
const processor = await processorService.findJwtAuthenticator({
    failIfNotFound: true
});
await processorService.openAdvancedUI(processor);
const customUIFrame = await processorService.getAdvancedUIFrame();
await processorService.clickTab(customUIFrame, "TabName");
```

This pattern is verified by `self-processor-advanced.spec.js`.

== Remaining Tasks

=== Phase 2.5: E2E Test Verification and Stability (P1)

==== Current State
* [x] All E2E tests updated to use correct navigation pattern
* [x] Tests use `setupAuthAwareErrorDetection` to avoid false positives
* [x] ProcessorService utility provides consistent navigation methods
* [ ] Some tests may still have flaky selectors or timing issues
* [ ] Test 07 remains skipped due to deployment path constraints

==== Next Steps
* [ ] Run full E2E test suite and fix any remaining failures
* [ ] Stabilize flaky tests with better wait conditions
* [ ] Add retry logic for intermittent failures
* [ ] Consider enabling test 07 with proper deployment configuration
* [ ] Add visual regression tests for UI components

=== Phase 3: Observability (P2)

==== 3.1 Metrics Implementation
* [ ] Create `NifiSecurityEventRegistry` class
* [ ] Bridge SecurityEventCounter to NiFi metrics
* [ ] Implement Prometheus formatting
* [ ] Add metrics endpoints

==== 3.2 UI Metrics Display
* [ ] Display validation success/failure rates
* [ ] Show issuer-specific metrics
* [ ] Add real-time updates

==== 3.3 Monitoring Templates
* [ ] Create JWT validation dashboard
* [ ] Add issuer-specific panels
* [ ] Create alert rules

=== Phase 4: Advanced Features (P3)

==== 4.1 Advanced cui-jwt-validation Integration
* [ ] Replace direct JWKS loading with JwksLoader
* [ ] Implement JwksLoaderFactory usage
* [ ] Add HttpJwksLoaderConfig support

==== 4.2 Integration Testing
* [ ] Create Docker Compose setup
* [ ] Add Keycloak integration
* [ ] Implement integration test suite
* [ ] Fix broken link in integration-testing/README.adoc:186

==== 4.3 E2E Test Completion
* [ ] Implement issuer configuration tests
* [ ] Add token verification flow tests
* [ ] Create JWKS validation tests
* [ ] Add metrics verification tests

=== Phase 5: Documentation & Polish (P4)

==== 5.1 Internationalization
* [ ] Complete all German translations
* [ ] Add I18nKeys constants class
* [ ] Create i18n completeness tests

==== 5.2 Integration Patterns
* [ ] Create API Gateway pattern example
* [ ] Add service-to-service auth example
* [ ] Create multi-tenant routing example

==== 5.3 Security Hardening
* [ ] Add algorithm whitelist configuration
* [ ] Implement algorithm validation
* [ ] Add security configuration options

==== 5.4 Build Configuration
* [ ] Resolve Maven enforcer workaround in nifi-cuioss-nar/pom.xml:31
* [ ] Remove `<enforcer.skip>true</enforcer.skip>` if possible

==== 5.5 Accessibility
* [ ] Integrate accessibility-helper.js into E2E tests
* [ ] Add WCAG compliance checks to critical user journeys
* [ ] Create accessibility test reports

== Implementation Order

1. Phase 2.5 (E2E Test Verification)
2. Phase 3 (Observability)
3. Phase 4 (Advanced Features)
4. Phase 5 (Documentation & Polish)

== Success Criteria

1. All P1 features implemented and tested
2. Authorization checking functional for all issuers
3. Custom UI providing enhanced user experience
4. Metrics collection and monitoring operational
5. 80%+ test coverage for new code
6. Documentation complete and up-to-date
7. E2E tests stable and passing consistently

== Technical Architecture Summary

=== E2E Test Infrastructure
The E2E test suite uses a service-oriented architecture with:

1. **Core Services**:
   - `ProcessorService` - Handles processor navigation and interaction
   - `AuthService` - Manages authentication flow
   - `ConsoleLogger` - Captures browser console logs
   - `CriticalErrorDetector` - Monitors for critical errors

2. **Navigation Pattern**:
   - All tests use the verified Right-click → Advanced menu pattern
   - Tests operate within iframe context for custom UI
   - No direct navigation to custom UI URLs

3. **Error Detection**:
   - `setupAuthAwareErrorDetection` - Standard for most tests
   - `setupStrictErrorDetection` - Only for self-tests
   - Automatic critical error detection and reporting

=== Code Cleanup Summary (2025-07-28)

1. **Removed Unused Files**:
   - `accessibility-helper.js` - No usage, should be integrated later
   - `test-orchestrator.js` - Functionality provided by npm scripts

2. **Cleaned Up Utilities**:
   - `processor.js` - Reduced from 663 to 388 lines (41% reduction)
   - `console-logger.js` - Reduced from 878 to 250 lines (71% reduction)
   - `shared-logger.js` - Removed unused logger exports
   - Total: ~1,025 lines of unused code removed

3. **Remaining Utilities**:
   - All remaining code is actively used in tests
   - Clear separation between self-test and production utilities
   - Better maintainability with focused, single-purpose utilities

== JWT REST API Implementation Details

=== Implementation Status (2025-01-27)

This section captures the implementation details for the JWT REST API endpoints that were created to support the custom UI components.

==== Completed Implementation
1. **Backend REST API Endpoints**:
   - `/nifi-api/processors/jwt/verify-token` - Token verification with claims extraction
   - `/nifi-api/processors/jwt/validate-jwks` - JWKS validation (URL, file, content)
   - `/nifi-api/processors/jwt/metrics` - Security metrics endpoint
   - Added dual servlet mappings for E2E test compatibility (`/api/token/*`)

2. **Core Services Created**:
   - `IssuerConfigurationParser` - Shared configuration parsing logic between processor and servlets
   - `JwtValidationService` - Token validation using cui-jwt-validation library
   - `ProcessorConfigReader` - Fetches processor config via NiFi REST API
   - `ApiKeyAuthenticationFilter` - Per-processor API key authentication
   - Added E2E test mode support (processorId-less validation for testing)

3. **Frontend UI Integration**:
   - `apiClient.js` - Added authentication support with processorId and API key
   - Connected Token Verification tab to REST endpoint
   - Connected JWKS Validation to REST endpoint
   - Connected Metrics tab to REST endpoint
   - Fixed jQuery compatibility issues (replaced data/removeData with WeakMap)

==== Technical Architecture Decisions

1. **Configuration Access Strategy**: Used REST API approach where servlets call NiFi's REST API to fetch processor configuration. This provides clean separation and works with NiFi's security model.

2. **Jakarta EE 10 Compliance**: All servlets use `jakarta.servlet.*` packages (not `javax.servlet.*`) for NiFi 2.4.0 compatibility.

3. **Shared Configuration Parser**: Created `IssuerConfigurationParser` to ensure both the processor and REST endpoints use identical configuration parsing logic, eliminating code duplication.

4. **API Key Authentication**: Each processor instance gets its own API key generated on startup using `SecureRandom` with 256 bits of entropy. Keys are stored in memory only and regenerated on processor restart.

==== Implementation Module Structure
```
nifi-cuioss-ui/
├── src/main/java/de/cuioss/nifi/ui/
│   ├── servlets/
│   │   ├── JwtVerificationServlet.java
│   │   ├── JwksValidationServlet.java
│   │   ├── MetricsServlet.java
│   │   └── ApiKeyAuthenticationFilter.java
│   ├── service/
│   │   └── JwtValidationService.java
│   └── util/
│       └── ProcessorConfigReader.java
```

==== E2E Test Mode Implementation

For E2E testing, the endpoints support operation without a processorId when accessed via `/api/token/*` paths:
- Performs basic JWT parsing without signature verification
- Extracts claims without full validation
- Returns simulated metrics
- Bypasses API key authentication

This mode is only available in test environments.

==== Known Limitations

1. **E2E Test Path Mismatch**: Test `07-verify-token-verification-api.spec.js` remains skipped because it expects endpoints at `/api/token/verify` but actual endpoints are at `/nifi-cuioss-ui/api/token/verify`. This requires special deployment configuration not available in standard E2E test environment.

2. **Pending Testing Tasks**:
   - Unit tests for servlets using RestAssured
   - Integration tests with actual NiFi instance
   - Full E2E test coverage once deployment issues are resolved