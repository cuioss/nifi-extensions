= Implementation Plan: NiFi JWT Authenticator Missing Features
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

== Overview

This document outlines the implementation plan for completing the NiFi JWT Authenticator based on gaps identified between the specifications and current implementation.

Last updated: 2025-07-25

== Pre-1.0 Development Rules (TOP PRIORITY)

* *Version*: 1.0-SNAPSHOT (pre-1.0)
* *Rule*: Breaking changes are allowed and encouraged for better API design
* *Approach*: Fail-secure by default, explicit configuration required
* *No backward compatibility requirements*: Existing configurations may break

== Completion Steps for Each Task

Each implementation task must pass these three builds before commit:

1. *Pre-commit build*: `./mvnw -Ppre-commit clean install -DskipTests`
2. *Full build with tests*: `./mvnw clean install`
3. *E2E integration tests*: `./mvnw -B --no-transfer-progress clean verify -pl e-2-e-playwright -Pintegration-tests`

Commit after each task only if all three builds succeed.

== Priority Classifications

* *P0 (Blocker)*: Critical issues preventing development/testing
* *P1 (Critical)*: Core functionality required for basic operation
* *P2 (High)*: Important features for production readiness
* *P3 (Medium)*: Enhanced functionality and user experience
* *P4 (Low)*: Nice-to-have features

== Phase 0: Critical Test Infrastructure Issue (P0 - BLOCKER)

=== 0.1 Fix Unit Test Framework for Dynamic Properties [HIGH PRIORITY]

==== Problem Description
* *Issue*: All processor unit tests fail with "At least one issuer configuration must be provided"
* *Root Cause*: NiFi TestRunner's ProcessContext doesn't properly handle dynamic properties
* *Impact*: Cannot run unit tests for processors using dynamic properties
* *Details*:
  - Dynamic properties set via `testRunner.setProperty(ISSUER_PREFIX + "...")` are not available in `context.getProperties().keySet()`
  - The `loadUIConfigurations()` method cannot iterate over dynamic properties in test environment
  - This is NOT a cui-jwt-validation library issue - it's a TestRunner limitation

==== Proposed Solutions
* *Option 1*: Create MockProcessContext that properly returns dynamic properties [SELECTED FOR IMPLEMENTATION]
* *Option 2*: Refactor property loading to support test environment
* *Option 3*: Create integration test approach bypassing TestRunner
* *Option 4*: Inject configurations directly for testing

==== Selected Solution: Option 1 - Create Reusable MockProcessContext Module

===== Overview
Create a dedicated test support module (`nifi-cuioss-test-support`) containing a reusable MockProcessContext implementation that properly handles dynamic properties for all processor tests.

===== Module Structure
```
nifi-cuioss-test-support/
├── pom.xml
└── src/
    ├── main/
    │   └── java/
    │       └── com/
    │           └── cuioss/
    │               └── nifi/
    │                   └── test/
    │                       ├── MockProcessContext.java
    │                       ├── MockPropertyValue.java
    │                       └── ProcessContextBuilder.java
    └── test/
        └── java/
            └── com/
                └── cuioss/
                    └── nifi/
                        └── test/
                            └── MockProcessContextTest.java
```

===== Core Components

1. *MockProcessContext*:
   - Implements Apache NiFi's ProcessContext interface
   - Stores static and dynamic properties in separate maps
   - Handles property retrieval with proper PropertyValue wrapping
   - Supports expression language evaluation
   - Thread-safe for concurrent testing

2. *MockPropertyValue*:
   - Implements PropertyValue interface
   - Handles type conversions (String, Integer, Long, Boolean, etc.)
   - Supports expression language evaluation
   - Provides default value handling

3. *ProcessContextBuilder*:
   - Fluent builder for easy test setup
   - Add static properties with descriptors
   - Add dynamic properties with custom prefixes
   - Configure expression language support
   - Set component ID and name

===== Key Features
* Full support for dynamic properties with prefix-based filtering
* Expression language evaluation (optional)
* Property validation
* Default value handling
* Immutable after build for thread safety
* Compatible with existing TestRunner infrastructure

===== Integration Benefits
* Replace verbose Mockito setup with simple builder pattern
* Reusable across all processor tests
* Consistent behavior for property handling
* Better test maintainability
* Reduced boilerplate code

===== Implementation Steps (COMPLETED)
1. Created new module `nifi-cuioss-test-support`
2. Created DynamicPropertyTestHelper utility class
3. Documented two approaches for testing with dynamic properties:
   - Using MockProcessContext directly from nifi-mock
   - Creating testable processor wrappers
4. Added comprehensive documentation and examples
5. Updated parent pom.xml to include new module

===== Implementation Notes
Instead of creating custom MockProcessContext and MockPropertyValue implementations, we leveraged the existing `org.apache.nifi.util.MockProcessContext` from the `nifi-mock` library. This approach:
- Reduces code duplication
- Ensures compatibility with NiFi's testing framework
- Provides a simpler solution that focuses on documenting the workaround

The test-support module now provides:
- Helper utilities for setting dynamic properties
- Documentation of the TestRunner limitation
- Example code showing how to properly test processors with dynamic properties

==== Tasks
* *Location*: Test infrastructure
* *Tasks*:
  - [x] Analyze TestRunner dynamic property handling - COMPLETED 2025-07-25
  - [x] Implement Option 1: Create test support module - COMPLETED 2025-07-25
  - [x] Document testing approach for dynamic properties - COMPLETED 2025-07-25
  - [x] Update all failing tests to use new approach - COMPLETED 2025-07-25
  - [x] Ensure all unit tests pass - COMPLETED 2025-07-25 (All 62 tests passing)
* *Dependencies*: None
* *Blocking*: All other development work
* *Status*: COMPLETED - All processor tests now handle dynamic properties correctly using MockProcessContext override pattern

== Phase 1: Core Functionality (P1) [PARTIALLY COMPLETED - 2025-07-25]

=== 1.1 Authorization Implementation [COMPLETED]

==== Scope and Role Checking
* *Location*: `MultiIssuerJwtAuthenticator.java`
* *Tasks*:
  - [x] Add scope validation in `onTrigger()` method
  - [x] Add role validation in `onTrigger()` method
  - [x] Create `AuthorizationValidator` utility class
  - [x] Add per-issuer authorization configuration support
* *Dependencies*: None

==== Flow File Attributes
* *Location*: `MultiIssuerJwtAuthenticator.java`
* *Tasks*:
  - [x] Add missing attributes: `jwt.scopes`, `jwt.roles`, `jwt.authorized`
  - [x] Update attribute documentation
* *Dependencies*: Authorization implementation

=== 1.2 YAML Configuration Support [REMOVED - User Request]

==== ConfigurationManager Enhancement
* *Location*: `ConfigurationManager.java:169`
* *Tasks*:
  - [ ] Implement YAML parsing using SnakeYAML (TODO from line 169) - *REMOVED per user request*
  - [ ] Add YAML to IssuerConfig conversion - *REMOVED per user request*
  - [ ] Add tests for YAML configuration - *REMOVED per user request*
* *Dependencies*: SnakeYAML library - *NOT ADDED per user request*
* *Note*: YAML support removed from implementation scope per user request on 2025-07-25

=== 1.3 Test Implementation [BLOCKED BY PHASE 0]

==== Unit Tests
* *Location*: `MultiIssuerJwtAuthenticatorTest.java`
* *Tasks*:
  - [x] Implement token validation tests (code written but tests fail)
  - [x] Add multi-issuer test scenarios (code written but tests fail)
  - [x] Add error handling tests (code written but tests fail)
  - [x] Add authorization tests (code written but tests fail)
* *Dependencies*: Phase 0 - Test Infrastructure Fix
* *Status*: Implementation complete but all tests fail due to TestRunner dynamic property issue

== Phase 2: UI Enhancement (P2)

=== 2.1 Custom UI Components

==== UI Customizer Implementation
* *Location*: `META-INF/nifi-processor-customizers/`
* *Tasks*:
  - [ ] Create `MultiIssuerJwtAuthenticatorCustomizer.js`
  - [ ] Implement JWKS Validation Button
  - [ ] Add Token Verification Tab
  - [ ] Add Metrics Tab
  - [ ] Add Help Tab
* *Dependencies*: Frontend JavaScript knowledge

==== REST Endpoint
* *Location*: New REST controller
* *Tasks*:
  - [ ] Create `/api/token/verify` endpoint
  - [ ] Implement token verification logic
  - [ ] Add security controls
  - [ ] Create response DTOs
* *Dependencies*: NiFi REST API framework

=== 2.2 Validation Enhancements

==== JWKS Validation
* *Location*: Configuration UI
* *Tasks*:
  - [ ] Add URL validation for JWKS endpoints (TODO from configuration-ui.adoc:249)
  - [ ] Add file existence validation (TODO from configuration-ui.adoc:256)
  - [ ] Implement validation button backend
  - [ ] Add validation result display
* *Dependencies*: UI Customizer

== Phase 3: Observability (P2)

=== 3.1 Metrics Implementation

==== SecurityEventRegistry
* *Location*: New package `de.cuioss.nifi.processors.auth.metrics`
* *Tasks*:
  - [ ] Create `NifiSecurityEventRegistry` class
  - [ ] Bridge SecurityEventCounter to NiFi metrics
  - [ ] Implement Prometheus formatting
  - [ ] Add metrics endpoints
* *Dependencies*: cui-jwt-validation metrics

==== UI Metrics Display
* *Location*: Metrics Tab in UI
* *Tasks*:
  - [ ] Display validation success/failure rates
  - [ ] Show issuer-specific metrics
  - [ ] Add real-time updates
  - [ ] Create metric charts
* *Dependencies*: SecurityEventRegistry, UI Customizer

=== 3.2 Monitoring Templates

==== Grafana Dashboards
* *Location*: `doc/monitoring/`
* *Tasks*:
  - [ ] Create JWT validation dashboard
  - [ ] Add issuer-specific panels
  - [ ] Create alert rules
  - [ ] Document dashboard usage
* *Dependencies*: Metrics implementation

== Phase 4: Advanced Features (P3)

=== 4.1 Advanced cui-jwt-validation Integration

==== JwksLoader Implementation
* *Location*: `MultiIssuerJwtAuthenticator.java`
* *Tasks*:
  - [ ] Replace direct JWKS loading with JwksLoader
  - [ ] Implement JwksLoaderFactory usage
  - [ ] Add HttpJwksLoaderConfig support
  - [ ] Update configuration handling
* *Dependencies*: cui-jwt-validation library

=== 4.2 Integration Testing

==== Docker-based Tests
* *Location*: `integration-testing/`
* *Tasks*:
  - [ ] Create Docker Compose setup
  - [ ] Add Keycloak integration
  - [ ] Implement integration test suite
  - [ ] Add CI/CD integration
  - [ ] Fix broken link to plan.adoc in integration-testing/README.adoc:186
* *Dependencies*: Docker, Keycloak

=== 4.3 E2E Test Completion

==== Playwright Tests
* *Location*: `e-2-e-playwright/tests/`
* *Tasks*:
  - [ ] Implement issuer configuration tests
  - [ ] Add token verification flow tests
  - [ ] Create JWKS validation tests
  - [ ] Add metrics verification tests
* *Dependencies*: UI implementation

==== E2E Testing Roadmap (from end-to-end-testing.adoc:254)
* *Phase 1: Setup and Infrastructure*:
  - [ ] Set up test environment
  - [ ] Configure Playwright
  - [ ] Create basic page objects
  - [ ] Implement authentication helpers
* *Phase 2: Basic Test Implementation*:
  - [ ] Login/logout tests
  - [ ] Basic navigation tests
  - [ ] Simple processor configuration tests
  - [ ] Basic error handling tests
* *Phase 3: Advanced Test Implementation*:
  - [ ] Complex processor configuration tests
  - [ ] Multi-step workflows
  - [ ] Error recovery scenarios
  - [ ] Performance testing basics
* *Phase 4: Maintenance and Expansion*:
  - [ ] Test maintenance procedures
  - [ ] Adding new test cases
  - [ ] Performance optimization
  - [ ] Integration with CI/CD

== Phase 5: Documentation & Polish (P4)

=== 5.1 Internationalization

==== German Translations
* *Location*: `Messages_de.properties`
* *Tasks*:
  - [ ] Complete all German translations
  - [ ] Add I18nKeys constants class
  - [ ] Create i18n completeness tests
  - [ ] Update documentation
* *Dependencies*: None

=== 5.2 Integration Patterns

==== Example Flows
* *Location*: `doc/examples/`
* *Tasks*:
  - [ ] Create API Gateway pattern example
  - [ ] Add service-to-service auth example
  - [ ] Create multi-tenant routing example
  - [ ] Add template files
* *Dependencies*: Core functionality complete

=== 5.3 Security Hardening

==== Algorithm Restrictions
* *Location*: `MultiIssuerJwtAuthenticator.java`
* *Tasks*:
  - [ ] Add algorithm whitelist configuration
  - [ ] Implement algorithm validation
  - [ ] Add security configuration options
  - [ ] Update documentation
* *Dependencies*: None

=== 5.4 Build Configuration

==== Maven Enforcer Fix
* *Location*: `nifi-cuioss-nar/pom.xml:31`
* *Tasks*:
  - [ ] Investigate and resolve Maven enforcer workaround (FIXME)
  - [ ] Remove `<enforcer.skip>true</enforcer.skip>` if possible
  - [ ] Document proper build configuration
* *Dependencies*: None

== Implementation Order

=== Phase 0 (Blocker - Test Infrastructure)
* Fix dynamic property handling in tests
* Ensure all unit tests can run

=== Phase 1 (Core Functionality)
* Authorization implementation
* ~~YAML configuration~~ (removed)
* Basic test coverage

=== Phase 2 (UI Enhancement)
* Custom UI components
* REST endpoints
* Validation features

=== Phase 3 (Observability)
* Metrics implementation
* Monitoring setup
* Dashboard creation

=== Phase 4 (Advanced Features)
* Advanced library integration
* Integration testing
* E2E test completion

=== Phase 5 (Documentation & Polish)
* Internationalization
* Integration patterns
* Security hardening
* Build configuration fixes

== Risk Mitigation

=== Technical Risks
1. *NiFi API Limitations*: Research NiFi custom UI capabilities early
2. *Library Compatibility*: Test cui-jwt-validation advanced features in isolation
3. *Performance Impact*: Implement metrics collection with minimal overhead

=== Schedule Risks
1. *Dependencies*: Prioritize core functionality to unblock other phases
2. *Testing*: Allocate buffer time for test implementation
3. *Integration*: Plan for potential integration challenges with external systems

== Success Criteria

1. All P1 features implemented and tested
2. Authorization checking functional for all issuers
3. Custom UI providing enhanced user experience
4. Metrics collection and monitoring operational
5. 80%+ test coverage for new code
6. Documentation complete and up-to-date

== Next Steps

1. Review and approve implementation plan
2. Set up development environment
3. Create feature branches for each phase
4. Begin Phase 1 implementation
5. Schedule weekly progress reviews