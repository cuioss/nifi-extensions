= D2. Implement `cash-dom` as jQuery Replacement
:toc:
:toclevels: 4

*Priority:* High

*Description:* Replace jQuery with `cash-dom` (a lightweight jQuery alternative) across the application. This migration aims to reduce bundle size, modernize event handling and DOM manipulation, and improve overall maintainability.

*Rationale:* jQuery adds significant weight to our bundle (~30KB minified and gzipped) and ties us to an older paradigm of web development.

== Task Details

=== Context and Problem Statement

Our application currently depends on jQuery for DOM manipulation, event handling, and AJAX requests. This dependency adds significant weight to our bundle and ties us to an older paradigm of web development. The strategy is to replace jQuery entirely with `cash-dom` to streamline our frontend dependencies.

=== Chosen Solution: `cash-dom` as the Primary jQuery Replacement

The chosen solution is to utilize `cash-dom` (hereafter referred to as `cash`) as the direct replacement for jQuery. This approach offers a balance of modernizing our codebase while retaining a familiar API for DOM manipulation and event handling where needed.

*Benefits of using `cash`:*
* Lightweight alternative to jQuery (~8KB vs ~30KB minified and gzipped).
* jQuery-compatible API simplifies migration for many use cases.
* Actively maintained and modern.

*Previous Approach Note:* While some parts of the application were previously refactored to use Vanilla JS (custom DOM utilities or direct browser APIs), the current strategy is to prioritize `cash` for consistency and to leverage its optimized functionalities. Vanilla JS will only be used for tasks where `cash` does not offer a clear advantage or is not applicable (e.g., highly specific performance-critical operations not covered by `cash`'s API). Custom Vanilla JS DOM utility libraries (like the previous `utils/dom.js`) will be phased out in favor of `cash` equivalents.

=== Implementation Plan

==== Phase 1: Replace jQuery AJAX with Fetch API

[x] *Completed:* jQuery AJAX calls (`$.ajax`) were replaced with a Fetch API-based solution (`utils/ajax.js`). A compatibility wrapper (`compatAjax`) was provided to ease the transition for existing code structure. This phase is considered complete.

==== Phase 2: Replace jQuery UI Dependencies

[x] *Completed:* jQuery UI dependencies, specifically tooltips, were addressed by introducing Tippy.js. Utility modules for Tippy.js integration were created as per Task D1. This phase is considered complete. Further integration of Tippy.js with `cash` may be required (see Actionable Tasks).

==== Phase 3: Create DOM Utility Module

*Superseded by `cash`-first strategy:* This phase initially involved creating a custom DOM utility module (`utils/dom.js`) with Vanilla JS functions mirroring some jQuery APIs. With the decision to use `cash` as the primary jQuery replacement, this custom module is largely redundant. The functionalities provided by `dom.js` should be replaced by `cash` equivalents. The `utils/dom.js` file will be reviewed for deprecation or a significantly reduced scope.

==== Phase 4: Migrate to Cash (jQuery Alternative)

1. [x] Install Cash:

[source,bash]
----
npm install cash-dom
----

2. [-] Create a compatibility wrapper:
(See `utils/jquery-compat.js`). This wrapper's role may be re-evaluated as part of using `cash` directly (see Actionable Tasks).

3. [-] Replace jQuery imports:
This was done as an initial step. Further work will involve ensuring `cash` is used optimally.

==== Phase 5: Previous Vanilla JS Refactoring (Now Superseded by `cash`-first Strategy)

*Superseded by `cash`-first strategy:* This phase documented the refactoring of several JavaScript files to use Vanilla JS or custom DOM utilities. Given the updated strategy to prioritize `cash` as the jQuery replacement, these Vanilla JS implementations will be reviewed and refactored to use `cash` where `cash` provides equivalent or better functionality. The goal is to maintain consistency and leverage `cash`'s capabilities. See 'Actionable Tasks for `cash` Migration' for next steps.

==== Phase 6: Remove jQuery and Related Artifacts

[x] *Completed:* jQuery has been removed from the project's direct dependencies (`package.json` and `pom.xml` WebJars). `cash-dom` is now the established jQuery alternative. Any remaining jQuery-related artifacts or utility functions not aligned with the `cash`-first strategy will be addressed in the 'Actionable Tasks'.

== Actionable Tasks for `cash` Migration

This section outlines the remaining tasks to fully migrate from jQuery to `cash-dom` (`cash`) and ensure the application is stable and tests are passing.

=== Core Migration and Refactoring
* [ ] *Review and Refactor Existing Vanilla JS to `cash`*:
      Identify areas where `utils/dom.js` or direct Vanilla JS (from previous Phase 5) was used for DOM manipulation or event handling.
      Refactor these implementations to use `cash` where `cash` provides equivalent or more concise functionality.
      *Sub-tasks (example, expand as needed during review):*
      * [ ] Review `main.js` for Vanilla JS that can be converted to `cash`.
      * [ ] Review `components/issuerConfigEditor.js` for Vanilla JS that can be converted to `cash`.
      * [ ] Review `components/jwksValidator.js` for Vanilla JS that can be converted to `cash`.
      * [ ] Review `components/tokenVerifier.js` for Vanilla JS that can be converted to `cash`.
      * [ ] Evaluate `utils/dom.js`: Determine if it can be fully deprecated or if any specific utilities not covered by `cash` are still essential.
* [ ] *Remove Indirection (Use `cash` Directly)*:
      Once the primary refactoring to `cash` is done and the test bed is stable, review components that use `jquery-compat.js`.
      Update them to import `cash` directly from `'cash-dom'` where possible.
      Evaluate if `utils/jquery-compat.js` is still needed or if its specific additions (like the placeholder tooltip) should be integrated elsewhere (e.g., specific Tippy.js initialization module) or handled differently.

=== Testing and Stability
* [ ] *Ensure all Tests Pass*:
      After any refactoring to `cash`, run all tests using `./mvnw clean install` from the project root.
      Fix any test failures, which may involve updating test setups, mocks, or assertions to align with `cash` behavior.
* [ ] *Enable Disabled/Pending Tests*:
      Systematically review and re-enable any tests that were disabled or marked as pending during previous refactoring phases.
      *Sub-tasks (expand as tests are identified):*
      * [ ] Address test failures in `issuerConfigEditor.test.js` (currently noted as having failures related to dependencies/internal logic).
      * [ ] Review `main.real.test.js` for any `cash`-related adjustments needed, especially for event triggering.
      * [ ] Identify and list other skipped/disabled tests and create actionable items for each.

=== Integration and Cleanup
* [ ] *Integrate Tippy.js properly with `cash` (if necessary)*:
      The `jquery-compat.js` file contains a placeholder for `cash.fn.tooltip`.
      Ensure that Tippy.js (introduced in Phase 2) is correctly invoked if any components rely on a `$.fn.tooltip`-like interface via `cash`. This might involve creating a specific `cash` plugin for Tippy.js or ensuring components call Tippy.js initialization directly.
* [ ] *Final Verification*:
      Perform a full `./mvnw clean install` to ensure the build is stable and all tests pass.
* [ ] *Documentation Update*:
      Ensure this document (`TODO-jquery-replacement.adoc`) is fully updated to reflect the completion of all tasks.

== References

* https://github.com/fabiospampinato/cash[Cash - A tiny jQuery alternative]
* https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API[Fetch API - MDN Web Docs]
