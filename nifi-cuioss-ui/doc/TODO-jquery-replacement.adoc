= D2. Implement Hybrid Approach for jQuery Replacement
:toc:
:toclevels: 4

[WIP] *Priority:* High - Phase 1 & 2 done.

*Description:* Implement a hybrid approach for gradually replacing jQuery with lighter alternatives and native JavaScript. This phased migration will reduce bundle size while maintaining application stability.

*Rationale:* jQuery adds significant weight to our bundle (~30KB minified and gzipped) and ties us to an older paradigm of web development. A gradual migration approach minimizes risk and allows selective optimization.

== Task Details

=== Context and Problem Statement

Our application currently depends on jQuery for DOM manipulation, event handling, and AJAX requests. This dependency adds significant weight to our bundle and ties us to an older paradigm of web development. We need a strategy to gradually reduce and eventually eliminate this dependency.

=== Chosen Solution: Hybrid Approach for Phased Migration

A phased migration approach will gradually reduce jQuery dependency while maintaining application stability.

* Reduces migration risk through incremental changes
* Allows focusing on highest-impact areas first
* Maintains application stability during transition
* Enables selective optimization where most beneficial

=== Implementation Plan

==== Phase 1: Replace jQuery AJAX with Fetch API

1. [x] Create a fetch-based API client wrapper:

[source,javascript]
----
// utils/ajax.js
export const ajax = ({url, method = 'GET', data, contentType, headers = {}, ...options}) => {
  const fetchOptions = {
    method,
    headers: {
      'Content-Type': contentType || 'application/json',
      ...headers
    },
    ...options
  };
  
  if (data) {
    fetchOptions.body = contentType === 'application/json' 
      ? JSON.stringify(data) 
      : data;
  }
  
  return fetch(url, fetchOptions)
    .then(response => {
      if (!response.ok) {
        const error = new Error(response.statusText);
        error.response = response;
        throw error;
      }
      return response.json();
    })
    .then(data => ({
      data,
      status: 200,
      statusText: 'OK'
    }))
    .catch(error => {
      console.error('Fetch error:', error);
      throw error;
    });
};

// Compatibility with jQuery's $.ajax API
export const compatAjax = (options) => {
  return ajax(options)
    .then(response => {
      if (options.success) {
        options.success(response.data, response.statusText, { status: response.status });
      }
      return response;
    })
    .catch(error => {
      if (options.error) {
        options.error({ status: error.response?.status || 0 }, error.message);
      }
      throw error;
    })
    .finally(() => {
      if (options.complete) {
        options.complete();
      }
    });
};
----

2. [x] Update imports and replace $.ajax calls:

[source,javascript]
----
// Before:
import $ from 'jquery';
$.ajax({
  url: '/api/endpoint',
  success: function(data) {
    // Handle success
  },
  error: function(xhr) {
    // Handle error
  }
});

// After:
import { compatAjax } from './utils/ajax';
compatAjax({
  url: '/api/endpoint',
  success: function(data) {
    // Handle success
  },
  error: function(xhr) {
    // Handle error
  }
});

// Or using modern Promise API:
import { ajax } from './utils/ajax';
ajax({
  url: '/api/endpoint'
})
  .then(response => {
    // Handle success
  })
  .catch(error => {
    // Handle error
  });
----

==== Phase 2: Replace jQuery UI Dependencies

This phase will replace jQuery UI tooltips with Tippy.js as detailed in Task D1.

1. [x] Install Tippy.js and its dependencies:

[source,bash]
----
npm install tippy.js @popperjs/core
----

2. [x] Create and use the tooltip utility module as described in the tooltip replacement document (Task D1).

==== Phase 3: Create DOM Utility Module

1. [x] Create utility functions that mirror jQuery's API for DOM manipulation:

[source,javascript]
----
// utils/dom.js
export const $ = (selector, context = document) => {
  if (!selector) return [];
  
  // Handle HTML strings
  if (typeof selector === 'string' && selector.trim().startsWith('<')) {
    return [createElement(selector)];
  }
  
  // Handle DOM elements or document
  if (selector.nodeType || selector === document) {
    return [selector];
  }
  
  // Handle selectors
  return Array.from(
    typeof selector === 'string'
      ? context.querySelectorAll(selector)
      : selector
  );
};

export const createElement = (html) => {
  const template = document.createElement('template');
  template.innerHTML = html.trim();
  return template.content.firstChild;
};

// DOM manipulation utilities
export const dom = {
  find: (selector, element) => $(selector, element),
  
  addClass: (element, className) => {
    if (!element) return;
    element.classList.add(...className.split(' '));
    return element;
  },
  
  removeClass: (element, className) => {
    if (!element) return;
    element.classList.remove(...className.split(' '));
    return element;
  },
  
  toggleClass: (element, className, force) => {
    if (!element) return;
    element.classList.toggle(className, force);
    return element;
  },
  
  attr: (element, name, value) => {
    if (!element) return;
    if (value === undefined) {
      return element.getAttribute(name);
    }
    element.setAttribute(name, value);
    return element;
  },
  
  removeAttr: (element, name) => {
    if (!element) return;
    element.removeAttribute(name);
    return element;
  },
  
  html: (element, content) => {
    if (!element) return;
    if (content === undefined) {
      return element.innerHTML;
    }
    element.innerHTML = content;
    return element;
  },
  
  text: (element, content) => {
    if (!element) return;
    if (content === undefined) {
      return element.textContent;
    }
    element.textContent = content;
    return element;
  }
};
----

==== Phase 4: Migrate to Cash (jQuery Alternative)

1. [x] Install Cash:

[source,bash]
----
npm install cash-dom
----

2. [x] Create a compatibility wrapper:

[source,javascript]
----
// utils/jquery-compat.js
import cash from 'cash-dom';
import { initTooltips } from './tooltip';

// Add missing jQuery functionality to Cash
cash.fn.tooltip = function(options) {
  return initTooltips(this, options);
};

// Export enhanced Cash as a jQuery replacement
export default cash;
----

3. [x] Replace jQuery imports:

[source,javascript]
----
// Before:
import $ from 'jquery';

// After:
import $ from './utils/jquery-compat';
----

==== Phase 5: Gradual Migration to Vanilla JS

1. [x] All targeted JavaScript files (`main.js`, `nf-jwt-validator.js`, `utils/formatters.js`, `components/issuerConfigEditor.js`, `components/jwksValidator.js`, `components/tokenVerifier.js`) have been refactored to replace `cash-dom` (jQuery-compatible API) with Vanilla JS or custom DOM utilities.
   * `main.js`: Successfully refactored to replace most `cash-dom` usages.
     * Exception: The `$(document).on('dialogOpen', ...)` event handler remains. This is due to its reliance on jQuery's custom event triggering mechanism (which allows passing additional data like `dialogContentElement` directly). Converting this would require broader changes to how NiFi dispatches this custom event, which is outside the current refactoring scope. `cash-dom` (via `jquery-compat.js`) is retained specifically for this handler.
     * Its corresponding test file, `main.real.test.js`, has been refactored to use Vanilla JS for DOM manipulations and assertions. Event triggering for `main.js`'s `cash-dom` listeners is still performed using `$(document).trigger(...)` (which is `cash-dom` itself via an import in the test file) to ensure compatibility, particularly for events passing data.
   * `components/issuerConfigEditor.js`: All `cash-dom` usages replaced with Vanilla JS. The import of `jquery-compat.js` was removed.
     * Its corresponding test file, `issuerConfigEditor.test.js`, has been refactored. Test logic uses Vanilla JS for DOM manipulation. Mocks for `apiClient.js` now return standard Promises. Mocks for `compatAjax` (used by the `jwksValidator` sub-component) return a jQuery Deferred-like object. Asynchronous test patterns (`async/await`) are used. The fix in `jwksValidator.js` (using `.innerHTML` instead of `.html()`) resolved test failures in `issuerConfigEditor.test.js` that were directly related to the JWKS URL validation functionality. Other test failures in this file persist due to ongoing refactoring of its direct dependencies and internal logic.
   * `components/jwksValidator.js`: Confirmed that all `cash-dom` usages were previously replaced with Vanilla JS (e.g., using `resultContainer.innerHTML = message` instead of `resultContainer.html(message)`). The import of `jquery-compat.js` was removed.
     * Its corresponding test file, `jwksValidator.test.js`, has been refactored. Test logic now uses Vanilla JS for DOM manipulation. The SUT's AJAX calls (via `compatAjax`) are mocked to return a jQuery Deferred-like object (with `.done()` and `.fail()`) to match the SUT's expectations. Asynchronous test patterns (`async/await`) manage these mock AJAX calls. All tests in `jwksValidator.test.js` are passing.
   * `components/tokenVerifier.js`: All `cash-dom` usages replaced with Vanilla JS. The import of `jquery-compat.js` was removed.
     * Its corresponding test file, `tokenVerifier.test.js`, has been refactored. Test logic now uses Vanilla JS for DOM manipulation. The SUT's AJAX calls (via `compatAjax`) are mocked, and the mock returns a jQuery Deferred-like object (with `.done()` and `.fail()`) to match the SUT's expectations. Asynchronous test patterns (`async/await`) are used to manage these mock AJAX calls.
   * `nf-jwt-validator.js`: Removed unused import of `jquery-compat.js`.
     * Its corresponding test file, `nf-jwt-validator.test.js`, has also been refactored to remove jQuery/cash-dom mocking dependencies, now using direct `document.addEventListener` mocking.
   * `utils/formatters.js`: Removed unused import of `jquery-compat.js`.
   * `services/apiClient.js`: This service already used `compatAjax` (fetch-based).
     * Its corresponding test file, `apiClient.test.js`, has been refactored to remove its direct jQuery/cash-dom dependencies (which were used for mocking AJAX calls). It now correctly mocks `compatAjax` and uses standard Promises with `async/await` for its test logic.

==== Phase 6: Remove jQuery and Related Artifacts

1. [!] Partially complete: jQuery has been fully removed, but its lightweight alternative `cash-dom` (via `jquery-compat.js`) is still in use for a specific, documented case.
   * [!] Remove all jQuery imports from source files (replaced with jquery-compat or Vanilla JS):
       Original jQuery imports are removed. `jquery-compat.js` (which exports `cash-dom`) is still imported in `main.js`.
   * [!] Remove jQuery-based utility functions and wrappers (`jquery-compat.js` now uses cash-dom, `utils/dom.js` provides Vanilla alternatives):
       `jquery-compat.js` and `cash-dom` are retained for the specific `dialogOpen` event handler in `main.js`. The `utils/dom.js` module provides Vanilla JS alternatives, which are used extensively.
   * [x] Remove obsolete jQuery plugins and extensions (verified no standalone jQuery plugins remain in `webapp/js`).
   * [!] Remove jQuery from `package.json` and WebJars dependencies in `pom.xml`:
       `jquery` has been removed from `package.json` (and assumed from `pom.xml` if it was a WebJar).
       `cash-dom` remains as a dependency in `package.json` due to its usage in `main.js`.

== References

* https://github.com/fabiospampinato/cash[Cash - A tiny jQuery alternative]
* https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API[Fetch API - MDN Web Docs]
