= UI Module Roundtrip Testing Guide
:toc:
:toclevels: 3
:sectnums:
:icons: font

== Overview

This document describes the mechanism for automatically testing and fixing UI modules in the NiFi CUI OSS project. The roundtrip testing approach provides a systematic way to identify, diagnose, and resolve UI-related issues through iterative testing and analysis.

== Roundtrip Testing Philosophy

Roundtrip testing is an iterative approach that combines:

* **Automated Test Execution**: Using Playwright to simulate user interactions
* **Real-time Browser Analysis**: Capturing console logs and browser behavior
* **Iterative Development**: Making incremental fixes based on test feedback
* **Comprehensive Validation**: Full build and integration testing after fixes

== Prerequisites

=== Environment Requirements

* Docker environment properly configured
* NiFi test container available and functional
* Playwright testing framework installed and configured
* Browser logs collection mechanism enabled (automatic in current setup)

=== Test Coverage Requirements

[IMPORTANT]
====
**Critical Prerequisite**: There must be a corresponding Playwright test for the feature under test available in the `e-2-e-playwright/tests/` directory.
====

Ensure the following test files exist for your UI feature:

* `self-test.spec.js` - Basic functionality verification
* `processor-deployment.spec.js` - Processor-specific UI testing
* Custom test files for specific UI components

=== Deployment Workflow Integration

[IMPORTANT]
====
**Critical Component**: The roundtrip testing process requires deploying production code changes to the test environment after each modification using the `copy-deployment.sh` script.
====

**Deployment Script Location**: `integration-testing/src/main/docker/copy-deployment.sh`

**What the deployment script does**:

* Builds the NAR file using Maven (`./mvnw package -DskipTests`)
* Copies the updated NAR to the deployment directory
* Makes production code changes immediately available for testing
* Ensures the test environment reflects the latest code modifications

**When to deploy**:

* After any change to UI files (`nifi-cuioss-ui/src/main/webapp/`)
* After modifying processor logic or configuration
* Before running Playwright tests to verify fixes
* Each iteration of the roundtrip testing cycle

== Roundtrip Testing Process

=== Phase 1: Environment Setup

==== 1. Start NiFi Test Environment

[source,bash]
----
# Start the test container environment
integration-testing/src/main/docker/run-and-deploy.sh
----

This command starts:

* NiFi instance on `https://localhost:9095`
* Keycloak identity provider on `https://localhost:9085`
* Required network and volume configurations

==== 2. Verify Environment Readiness

Wait for the environment to be fully operational:

* NiFi UI accessible at `https://localhost:9095/nifi`
* All required processors loaded and available
* Network connectivity established

=== Phase 2: Test Execution and Analysis

==== 3. Execute Targeted Playwright Test

[source,bash]
----
# Run specific test for the feature under investigation (from e-2-e-playwright directory)
cd e-2-e-playwright
npx playwright test tests/corresponding-test-spec.js
----

**Examples of test specifications**:

* `tests/processor-deployment.spec.js` - For processor UI issues
* `tests/self-test.spec.js` - For basic functionality verification
* `tests/*processor*.spec.js` - For all processor-related tests

==== 4. Analyze Browser Console Logs

**Log Location**: `e-2-e-playwright/target/test-results/`

Browser logs are automatically captured with the following naming pattern:
[source]
----
browser-logs-YYYY-MM-DDTHH-MM-SS-sssZ.json
----

**Log Analysis Steps**:

1. **Locate Latest Log File**:
+
[source,bash]
----
ls -la e-2-e-playwright/target/test-results/*.json | tail -1
----

2. **Review Log Content**:
+
[source,bash]
----
# View the latest log file
cat e-2-e-playwright/target/test-results/[test-name]/trace.json | jq '.'
----

3. **Key Analysis Points**:
+
* **Errors Array**: Look for JavaScript errors and exceptions
* **Warnings Array**: Check for configuration or compatibility warnings  
* **Info Array**: Review informational messages and timing data
* **Test Context**: Verify test name, spec name, and URL context

**Log Structure Reference**:
[source,json]
----
{
  "timestamp": "2025-06-24T...",
  "testName": "should load JWT validator UI",
  "specName": "04-processor-deployment.cy.js",
  "errors": ["Error messages..."],
  "warnings": ["Warning messages..."],
  "info": [{"type": "info", "message": "...", "timestamp": "..."}],
  "url": "https://localhost:9095/nifi/...",
  "userAgent": "Mozilla/5.0..."
}
----

=== Phase 3: Iterative Fix and Validation

==== 5. Implement Fixes Based on Analysis

**Common UI Issues and Solutions**:

* **Loading Indicator Hanging**: Check `hideLoadingIndicatorRobust()` function
* **Component Registration Failures**: Verify `registerComponents()` execution
* **CSS/Styling Issues**: Review `base.css` and component-specific styles
* **JavaScript Errors**: Check module imports and function definitions

**Key Files for UI Fixes**:

* `nifi-cuioss-ui/src/main/webapp/js/main.js` - Core UI logic
* `nifi-cuioss-ui/src/main/webapp/js/nf-jwt-validator.js` - JWT validator UI
* `nifi-cuioss-ui/src/main/webapp/css/modules/base.css` - Base styling

==== 6. Deploy Production Code Changes

[IMPORTANT]
====
**Critical Step**: After each production code change, the updated NAR file must be deployed to make changes available in the test environment.
====

[source,bash]
----
# Build and deploy updated NAR file to test environment
integration-testing/src/main/docker/copy-deployment.sh
----

**What this script does**:

* ✅ Builds the NAR file with `./mvnw package -DskipTests`
* ✅ Copies the updated NAR to the deployment location
* ✅ Makes production code changes available for testing
* ✅ Ensures test environment reflects latest modifications

**When to call this script**:

* After modifying any file in `nifi-cuioss-ui/src/main/webapp/`
* After changing processor logic or configuration
* Before running Playwright tests to verify fixes
* Each time you want to test production code changes

==== 7. Repeat Testing Cycle

After implementing fixes:

[source,bash]
----
# Deploy the changes to test environment
integration-testing/src/main/docker/copy-deployment.sh

# Re-run the same Playwright test (from e-2-e-playwright directory)
cd e-2-e-playwright
npx playwright test tests/corresponding-test-spec.js
----

**Continue this cycle until**:

* ✅ Tests pass without failures
* ✅ No critical errors in browser logs
* ✅ UI components load and function correctly

[NOTE]
====
**Deployment Reminder**: Remember to run `integration-testing/src/main/docker/copy-deployment.sh` after each code modification to ensure your changes are deployed to the test environment before running tests.
====

== Postcondition: Final Validation

=== Phase 4: Environment Cleanup and Verification

==== 7. Stop Test Environment

[source,bash]
----
# Stop the test container environment
integration-testing/src/main/docker/stop-test-container.sh
----

==== 8. Full Build Verification

[IMPORTANT]
====
**Both commands must pass successfully before considering the fix complete.**
====

**Step 1: Full Build Verification**
[source,bash]
----
# Execute full build verification
./mvnw clean verify
----

This command validates:

* ✅ Compilation of all modules
* ✅ Unit test execution
* ✅ ESLint validation (zero warnings required)
* ✅ Maven artifact generation

**Step 2: Integration Test Verification**
[source,bash]
----
# Execute integration tests with Docker environment
./mvnw clean verify -pl e-2-e-playwright -Pintegration-tests
----

This command validates:

* ✅ End-to-end test execution
* ✅ Docker environment lifecycle
* ✅ Complete user workflow simulation
* ✅ Integration with external services

=== Fix Validation Requirements

**If either command fails**:

1. **Analyze the failure output carefully**
2. **Fix the specific issues identified**
3. **Re-run both commands until they pass**
4. **Do not proceed with commit until both pass**

**Success Criteria**:

* ✅ `./mvnw clean verify` exits with code 0
* ✅ `./mvnw clean verify -pl e-2-e-playwright -Pintegration-tests` exits with code 0
* ✅ No ESLint warnings or errors
* ✅ All tests pass consistently

== Advanced Troubleshooting

=== Common Roundtrip Testing Scenarios

==== Loading Indicator Issues

**Symptoms**:
* UI hangs on "Loading JWT Validator UI..." message
* Components fail to initialize properly

**Analysis Focus**:
* Check for timing-related console errors
* Verify `hideLoadingIndicatorRobust()` execution
* Review component registration sequence

**Typical Log Indicators**:
[source,json]
----
{
  "errors": [
    "TypeError: Cannot read property 'style' of null",
    "Element not found: loading-indicator"
  ]
}
----

==== Component Registration Failures

**Symptoms**:
* Custom UI tabs not appearing
* Processor configuration interface unavailable

**Analysis Focus**:
* Verify `registerComponents()` execution
* Check for module import errors
* Review CSS selector accuracy

==== Timing and Race Conditions

**Symptoms**:
* Intermittent test failures
* Components sometimes load, sometimes don't

**Analysis Focus**:
* Review initialization sequence timing
* Check for DOM readiness issues
* Verify async/await patterns

=== Log Analysis Best Practices

1. **Chronological Analysis**: Review logs in timestamp order
2. **Error Correlation**: Match errors with specific test actions
3. **Pattern Recognition**: Look for recurring error patterns
4. **Context Validation**: Verify URL, test name, and browser context

== Integration with Development Workflow

=== Fail-Fast Development Approach

The roundtrip testing process integrates with the project's fail-fast development philosophy:

1. **Make Incremental Changes**: Small, focused modifications
2. **Deploy Changes**: Run `integration-testing/src/main/docker/copy-deployment.sh` after each change
3. **Test Immediately**: Use roundtrip testing after each deployment
4. **Fix Before Proceeding**: Resolve issues before adding new features
5. **Validate Comprehensively**: Use both Maven commands for final validation

=== Version Control Integration

**Commit Requirements**:

* ✅ All roundtrip testing cycles completed successfully
* ✅ Both Maven verification commands pass
* ✅ Browser logs show no critical errors
* ✅ UI functionality verified through Playwright tests

== Summary

Roundtrip testing provides a systematic approach to UI module development and debugging:

* **Iterative**: Continuous test-fix-analyze cycles
* **Data-Driven**: Browser logs provide concrete debugging information
* **Comprehensive**: Full build and integration validation
* **Reproducible**: Standardized process for consistent results

This methodology ensures high-quality UI components that integrate seamlessly with the NiFi platform while maintaining the project's fail-fast development standards.

---

*Document version: 1.0 | Last updated: June 2025*
