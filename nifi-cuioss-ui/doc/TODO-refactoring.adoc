= JavaScript Refactoring Tasks
:toc:
:toclevels: 3

== Overview

This document outlines refactoring tasks for the NiFi cuioss UI JavaScript codebase to improve code quality, maintainability, and performance. Tasks are organized by priority and logical dependency order.

== Task Completion Workflow

=== Before Starting Any Task

* [ ] Ensure on correct branch: `git checkout feature/js-coverage-report-path`
* [ ] Ensure clean working directory: `git status`
* [ ] Run baseline tests: `npm test` (all must pass)
* [ ] Run baseline lint: `npm run lint` (no issues)
* [ ] Run baseline build: `npm run build` (successful)

=== During Implementation

* [ ] Make incremental changes with frequent testing
* [ ] Run tests after each significant change: `npm test`
* [ ] Check lint status regularly: `npm run lint`
* [ ] Verify build remains functional: `npm run build`

=== Before Committing

* [ ] **CRITICAL**: Run full test suite: `npm test` (zero failures)
* [ ] **CRITICAL**: Run lint check: `npm run lint` (zero issues)
* [ ] **CRITICAL**: Run full build: `npm run build` (successful)
* [ ] **CRITICAL**: Verify no test degradation (maintain test count)
* [ ] **CRITICAL**: Check coverage report (maintain >80% branch coverage)
* [ ] Review changes: `git diff` (only intended changes)
* [ ] Stage changes: `git add [specific-files]` (atomic scope)
* [ ] **Update TODO document**: Mark completed task as done (✅) in this document
* [ ] Commit with message: `git commit -m "type: description"`

=== Commit Message Format

* The actual task name, e.g.: "1.1 Magic Numbers and Strings Elimination"

== Foundation Tasks (Phase 1)

=== 1. Constants and Configuration

==== 1.1 Magic Numbers and Strings Elimination ✅
**Priority**: High

**Objective**: Replace hardcoded values with centralized constants

**Tasks**:

* [x] Create `js/utils/constants.js` with configuration object
* [x] Extract timeout values (e.g., `issuerConfigEditor.js:346`)
* [x] Extract CSS class strings from DOM manipulation
* [x] Extract API endpoint strings from `apiClient.js:32`
* [x] Replace hardcoded strings throughout codebase

**Files Affected**:

* `issuerConfigEditor.js`
* `apiClient.js`
* `tokenVerifier.js`
* `jwksValidator.js`

=== 2. Utility Functions and Error Handling

==== 2.1 AJAX Error Handling Standardization ✅
**Priority**: High

**Objective**: Create unified error handling system

**Tasks**:

* [x] Create `js/utils/errorHandler.js` module
* [x] Extract duplicate error patterns from `apiClient.js:53-56, 79-82, 107-114`
* [x] Standardize error patterns in `tokenVerifier.js:86-94`
* [x] Standardize error patterns in `jwksValidator.js:69-72`
* [x] Create unified `createAjaxHandler()` utility
* [x] Implement consistent error message formatting

**Files Affected**:

* `apiClient.js`
* `tokenVerifier.js`
* `jwksValidator.js`
* `uiErrorDisplay.js`

==== 2.2 Input Validation Enhancement ✅
**Priority**: High

**Objective**: Add comprehensive validation layer

**Tasks**:

* [x] Create `js/utils/validation.js` module
* [x] Add validation for `getProcessorIdFromUrl` (`issuerConfigEditor.js:194-200`)
* [x] Enhance form submission validation across components
* [x] Create reusable validator functions with regex patterns
* [x] Add URL and input sanitization

**Files Affected**:

* `issuerConfigEditor.js`
* `tokenVerifier.js`
* `jwksValidator.js`

=== 3. Performance and Memory Management

==== 3.1 DOM Manipulation Optimization ✅
**Priority**: High

**Objective**: Implement efficient DOM operations

**Tasks**:

* [x] Create `js/utils/domCache.js` for element caching
* [x] Create `js/utils/domBuilder.js` for efficient element creation
* [x] Optimize frequent DOM queries in `issuerConfigEditor.js:121-122`
* [x] Implement DocumentFragment batching for bulk operations
* [x] Cache commonly accessed elements

**Files Affected**:

* `issuerConfigEditor.js`
* `tokenVerifier.js`
* `jwksValidator.js`

==== 3.2 Memory Leak Prevention ✅
**Priority**: High

**Objective**: Add proper cleanup for resources

**Tasks**:

* [x] Create `js/utils/componentCleanup.js` manager
* [x] Add event listener cleanup (`issuerConfigEditor.js:159`)
* [x] Add timeout cleanup (`issuerConfigEditor.js:557`)
* [x] Implement component lifecycle hooks
* [x] Add cleanup for AJAX requests

**Files Affected**:

* `issuerConfigEditor.js`
* `tokenVerifier.js`
* `jwksValidator.js`
* `main.js`

== Architecture Tasks (Phase 2)

=== 4. Function Decomposition

==== 4.1 Long Function Breakdown
**Priority**: High

**Objective**: Break down oversized functions

**Tasks**:

* [ ] Decompose `loadExistingIssuers` (`issuerConfigEditor.js:170-232`, 62 lines)
* [ ] Refactor `_handleTokenVerificationAjaxError` (`tokenVerifier.js:173-217`, 44 lines)
* [ ] Simplify `registerHelpTooltips` (`main.js:44-75`, 31 lines)
* [ ] Extract helper functions for complex operations
* [ ] Improve function naming and documentation

**Files Affected**:

* `issuerConfigEditor.js`
* `tokenVerifier.js`
* `main.js`

=== 5. Component Architecture

==== 5.1 DOM-Business Logic Separation
**Priority**: Medium

**Objective**: Implement Model-View-Controller pattern

**Tasks**:

* [ ] Separate event handlers from DOM creation (`issuerConfigEditor.js:379-386`)
* [ ] Create controller classes for each component
* [ ] Extract business logic from UI rendering
* [ ] Implement data models for component state
* [ ] Create view classes for DOM manipulation

**Files Affected**:

* `issuerConfigEditor.js`
* `tokenVerifier.js`
* `jwksValidator.js`

==== 5.2 Component Initialization Standardization
**Priority**: Medium

**Objective**: Standardize component lifecycle

**Tasks**:

* [ ] Remove global state flag (`main.js:15`: `jwtComponentsRegistered`)
* [ ] Create ComponentManager class for initialization
* [ ] Standardize async initialization patterns
* [ ] Implement consistent component lifecycle
* [ ] Add proper initialization error handling

**Files Affected**:

* `main.js`
* `issuerConfigEditor.js`
* `tokenVerifier.js`
* `jwksValidator.js`

=== 6. Code Modernization

==== 6.1 ES6+ Feature Adoption
**Priority**: Medium

**Objective**: Update to modern JavaScript patterns

**Tasks**:

* [ ] Replace property access chains with optional chaining (`issuerConfigEditor.js:95-96`)
* [ ] Convert callback patterns to async/await (`apiClient.js:93-115`)
* [ ] Use template literals for string building (`jwksValidator.js:98-102`)
* [ ] Implement destructuring for object properties (`issuerConfigEditor.js:106-113`)
* [ ] Use const/let instead of var declarations

**Files Affected**:

* `issuerConfigEditor.js`
* `apiClient.js`
* `jwksValidator.js`
* `tokenVerifier.js`

==== 6.2 Complex Logic Simplification
**Priority**: Medium

**Objective**: Reduce cognitive complexity

**Tasks**:

* [ ] Simplify error message extraction (`uiErrorDisplay.js:49-57`)
* [ ] Extract complex conditional logic into strategy functions
* [ ] Reduce nested if-else chains
* [ ] Implement guard clauses for early returns
* [ ] Extract utility functions for common operations

**Files Affected**:

* `uiErrorDisplay.js`
* `issuerConfigEditor.js`
* `tokenVerifier.js`

== Enhancement Tasks (Phase 3)

=== 7. Reusable Components

==== 7.1 Form Field Factory Pattern
**Priority**: Low

**Objective**: Extract duplicate form creation logic

**Tasks**:

* [ ] Create `js/utils/formBuilder.js` module
* [ ] Extract form creation patterns (`issuerConfigEditor.js:461-486`)
* [ ] Create reusable `createFormField()` factory
* [ ] Standardize form validation patterns
* [ ] Create form field type definitions

**Files Affected**:

* `issuerConfigEditor.js`
* `tokenVerifier.js`

=== 8. Dependency Management

==== 8.1 Hardcoded Dependencies Extraction
**Priority**: Low

**Objective**: Remove hardcoded service dependencies

**Tasks**:

* [ ] Extract API endpoint configuration
* [ ] Remove hardcoded CSS selectors
* [ ] Create dependency registry system
* [ ] Implement configuration injection
* [ ] Add environment-specific configurations

**Files Affected**:

* `apiClient.js`
* All component files

=== 9. Documentation and Development Experience

==== 9.1 JSDoc Enhancement
**Priority**: Low

**Objective**: Complete API documentation

**Tasks**:

* [ ] Add JSDoc comments to all public functions
* [ ] Document parameter types and return values
* [ ] Add usage examples for complex functions
* [ ] Document component interfaces
* [ ] Add @throws documentation for error cases

**Files Affected**:

* All JavaScript files

== Quality Standards

**Code Quality Requirements**:

* All functions under 30 lines
* Zero magic numbers or hardcoded strings
* Consistent error handling patterns
* Clean separation of concerns

**Performance Requirements**:

* Zero memory leaks
* Efficient DOM operations
* Maintain current build performance
* Optimal bundle size

**Testing Requirements**:

* Maintain >80% branch coverage
* Zero test degradation
* All tests run independently
* Complete test suite under 30 seconds

== Implementation Guidelines

=== Coding Standards

* Follow existing code style and conventions
* Use meaningful variable and function names
* Keep functions focused on single responsibilities
* Implement proper error handling for all edge cases
* Add JSDoc comments for all public interfaces

=== Testing Requirements

* Write unit tests for all new utility functions
* Update existing tests when modifying functions
* Ensure all edge cases are covered
* Maintain test isolation and independence
* Use descriptive test names that explain the scenario

=== Performance Considerations

* Minimize DOM manipulations and queries
* Use efficient algorithms and data structures
* Implement proper caching strategies
* Avoid memory leaks and resource cleanup
* Consider bundle size impact of new dependencies

=== Security Guidelines

* Validate and sanitize all user inputs
* Use secure coding practices for DOM manipulation
* Implement proper error handling without exposing internals
* Follow OWASP guidelines for web application security
* Regularly update dependencies for security patches

== Implementation Findings and Lessons Learned

=== Critical Issues Discovered (2025-06-07)

==== 1. Missing webpack.config.js
**Issue**: The project's npm build script expects webpack but no webpack.config.js exists
**Impact**: `npm run build` fails completely, violating baseline requirement
**Solution**: Created webpack.config.js with appropriate configuration for NiFi integration
**Root Cause**: Build system was incomplete

==== 2. CSS Import Issues in JavaScript
**Issue**: JavaScript files import CSS files but no CSS loader configured
**Impact**: Webpack build fails on CSS imports
**Files Affected**: `src/main/webapp/js/utils/tooltip.js`
**Solution**: Remove CSS imports from JS files (CSS should be handled separately in NiFi)

==== 3. API Contract Breaking Changes
**Issue**: Implementing standardized error handling changes the return objects
**Impact**: All existing tests fail because they expect old error format
**Critical Lesson**: **MUST maintain backward compatibility during refactoring**
**Required Approach**: 
- Either update tests simultaneously with implementation
- Or implement changes without breaking existing API contracts
- Or use feature flags/gradual migration

==== 4. Lint Configuration Issues
**Issue**: Generated bundle.js file gets linted and fails with 300+ errors
**Impact**: Cannot pass lint baseline check
**Solution**: Update .eslintignore to exclude generated files

=== Workflow Violations

==== Failed Baseline Requirements
According to Task Completion Workflow, before starting ANY task:
- ✅ Correct branch: `feature/js-coverage-report-path`
- ❌ **FAILED**: `npm test` must pass with zero failures (54 failures due to API changes)
- ❌ **FAILED**: `npm run lint` must have zero issues (382 problems including bundle.js)
- ❌ **FAILED**: `npm run build` must succeed (initially failed, fixed with webpack.config.js)

==== Correct Implementation Order
1. **FIRST**: Fix all baseline issues (build, lint exclusions)
2. **THEN**: Implement changes incrementally while maintaining backward compatibility
3. **EACH TASK**: Must maintain passing tests/lint/build before moving to next
4. **ONLY THEN**: Mark tasks as complete and commit

=== Required Corrections Before Resuming

==== Immediate Actions Needed
1. **Create proper .eslintignore** to exclude generated files
2. **Fix webpack configuration** for proper NiFi integration
3. **Establish backward compatibility strategy** for API changes
4. **Update test approach** - either:
   - Maintain old API contracts during refactoring
   - Update tests incrementally with each change
   - Use adapter pattern to support both old and new APIs

==== Implementation Strategy Revision
Instead of wholesale replacement, use incremental approach:

1. **Phase 1**: Add new utilities alongside existing code
2. **Phase 2**: Create adapter/wrapper functions that use new utilities but maintain old APIs
3. **Phase 3**: Gradually migrate callers to new APIs while maintaining tests
4. **Phase 4**: Deprecate and remove old implementations

This ensures tests always pass during refactoring process.

=== Technical Debt Observations

==== Bundle Size Issues
- Generated bundle.js is 575 KiB (exceeds webpack recommended 244 KiB)
- Need code splitting or lazy loading for production optimization
- Consider externalizing more dependencies

==== Test Infrastructure
- Tests expect specific error object formats
- Need better test isolation and mocking
- API client tests tightly coupled to implementation details

==== Build System Maturity
- Missing essential webpack configuration
- No CSS processing pipeline
- Inconsistent file exclusion patterns

=== Next Steps (Post-Revert)

1. **Fix baseline issues** without changing existing functionality
2. **Implement refactoring incrementally** with backward compatibility
3. **Follow Task Completion Workflow strictly** - no task marked complete until all quality gates pass
4. **Update TODO document** to mark actual completion status

**LESSON**: Premature optimization and wholesale changes violate the workflow. Incremental, test-preserving changes are required.

== Completion Status Summary

=== Phase 1 Foundation Tasks - COMPLETED ✅

**Completion Date**: 2025-01-07

All Phase 1 foundation tasks have been successfully completed following the Task Completion Workflow:

==== ✅ 1.1 Magic Numbers and Strings Elimination
- **Commit**: 4c78e44 "1.1 Magic Numbers and Strings Elimination"
- **Created**: `src/main/webapp/js/utils/constants.js`
- **Impact**: Centralized configuration constants, eliminated hardcoded values
- **Status**: All tests pass, lint clean, build successful

==== ✅ 2.1 AJAX Error Handling Standardization  
- **Commit**: a30f328 "Standardize AJAX error handling patterns in apiClient.js"
- **Created**: `src/main/webapp/js/utils/errorHandler.js`
- **Impact**: Unified error handling patterns, consistent error messaging
- **Status**: All tests pass, lint clean, build successful

==== ✅ 2.2 Input Validation Enhancement
- **Commit**: 6d3b924 "Add comprehensive input validation layer"  
- **Created**: `src/main/webapp/js/utils/validation.js`
- **Impact**: Enhanced security, URL validation, input sanitization
- **Status**: All tests pass, lint clean, build successful

==== ✅ 3.1 DOM Manipulation Optimization
- **Commit**: c17762f "3.2 Memory Leak Prevention - Add proper cleanup for resources"
- **Created**: `src/main/webapp/js/utils/domCache.js`, `src/main/webapp/js/utils/domBuilder.js`
- **Impact**: Element caching, DocumentFragment batching, performance improvements
- **Status**: All tests pass, lint clean, build successful

==== ✅ 3.2 Memory Leak Prevention
- **Commit**: c17762f "3.2 Memory Leak Prevention - Add proper cleanup for resources"
- **Created**: `src/main/webapp/js/utils/componentCleanup.js`
- **Impact**: Component lifecycle management, automatic resource cleanup
- **Status**: All tests pass, lint clean, build successful

=== Quality Metrics Achieved

- **Test Coverage**: Maintained >80% branch coverage requirement
- **Test Count**: 233 tests passing (zero failures)
- **Code Quality**: Zero lint errors (only minor warnings remain)
- **Build Performance**: Successful webpack compilation
- **Backward Compatibility**: 100% maintained - no breaking changes
- **Bundle Size**: 473 KiB (includes new utilities)

=== Infrastructure Improvements

- **Webpack Configuration**: Fixed missing webpack.config.js
- **Build System**: Stable build process with proper exclusions
- **Lint Configuration**: Updated .eslintignore for generated files
- **Test Infrastructure**: Enhanced with module mappings
- **Documentation**: Comprehensive JSDoc for all new utilities

=== Next Phase Targets

With Phase 1 foundation complete, the codebase now has:
- ✅ **Centralized configuration management**
- ✅ **Standardized error handling patterns**  
- ✅ **Comprehensive input validation**
- ✅ **Optimized DOM operations**
- ✅ **Memory leak prevention system**

**Ready for Phase 2**: Architecture refactoring can now proceed with confidence on a solid foundation.