<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NiFi Component UI</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Load FontAwesome CSS - we need our own copy because:
         1. We run in an iframe that might not inherit parent styles reliably
         2. NiFi's dynamically injected FA 4.7.0 CSS has broken font paths (404 errors)
         3. Ensures consistent icon availability across all contexts
         Note: The 404 errors from NiFi's broken paths are harmless -->
    <link rel="stylesheet" href="webjars/font-awesome/7.2.0/css/all.min.css">
    <link rel="stylesheet" href="webjars/font-awesome/7.2.0/css/v4-shims.min.css">

    <!-- Override NiFi's injected FA 6 icon definitions with our FA 7 font-family.
         Loaded as a separate <link> (not @import) to ensure !important rules
         participate correctly in the cascade against NiFi's dynamically injected <style>. -->
    <link rel="stylesheet" href="css/modules/icons.css">

    <!-- NiFi will provide globalThis.nf.Common in production -->
    <script type="text/javascript" src="js/nifi-common-init.js"></script>
</head>
<body>
    <div id="jwt-validator-container" data-testid="jwt-customizer-container">
        <!-- This container will be populated by the JavaScript UI components -->
        <h1 class="sr-only">NiFi Component Configuration</h1>
        <div id="loading-indicator" data-i18n="app.loading">Loading Component UI...</div>

        <!-- Tab structure â€” all tabs present, JS shows/hides based on component type -->
        <main id="jwt-validator-tabs" class="jwt-tabs-container hidden">
            <div class="jwt-tabs-header" data-testid="jwt-config-tabs">
                <div class="tabs" role="tablist">
                    <!-- JWT issuer tabs (CS + processor) -->
                    <a href="#issuer-config" class="tab-item active jwt-tab" role="tab" data-toggle="tab" data-i18n="tab.configuration">Configuration</a>
                    <a href="#token-verification" class="tab-item jwt-tab" role="tab" data-toggle="tab" data-i18n="tab.token.verification">Token Verification</a>
                    <!-- Gateway tabs -->
                    <a href="#endpoint-config" class="tab-item gateway-tab hidden" role="tab" data-toggle="tab" data-i18n="tab.endpoint.config">Endpoint Configuration</a>
                    <a href="#endpoint-tester" class="tab-item gateway-tab hidden" role="tab" data-toggle="tab" data-i18n="tab.endpoint.tester">Endpoint Tester</a>
                    <a href="#gateway-issuer-config" class="tab-item gateway-tab hidden" role="tab" data-toggle="tab" data-i18n="tab.issuer.config">Issuer Configuration</a>
                    <a href="#gateway-token-verification" class="tab-item gateway-tab hidden" role="tab" data-toggle="tab" data-i18n="tab.token.verification">Token Verification</a>
                    <!-- Shared tabs -->
                    <a href="#metrics" class="tab-item" role="tab" data-toggle="tab" data-i18n="tab.metrics">Metrics</a>
                    <a href="#help" class="tab-item" role="tab" data-toggle="tab" data-i18n="tab.help">Help</a>
                </div>
            </div>
            <div class="jwt-tabs-content">
                <!-- JWT issuer panes -->
                <div id="issuer-config" class="tab-pane active jwt-tab" role="tabpanel" data-testid="issuer-config-panel">
                    <!-- Issuer configuration content will be injected here -->
                </div>
                <div id="token-verification" class="tab-pane jwt-tab" role="tabpanel">
                    <!-- Token verification content will be injected here -->
                </div>
                <!-- Gateway panes -->
                <div id="endpoint-config" class="tab-pane gateway-tab hidden" role="tabpanel" data-testid="endpoint-config-panel">
                    <!-- Endpoint configuration content will be injected here -->
                </div>
                <div id="endpoint-tester" class="tab-pane gateway-tab hidden" role="tabpanel" data-testid="endpoint-tester-panel">
                    <!-- Endpoint tester content will be injected here -->
                </div>
                <div id="gateway-issuer-config" class="tab-pane gateway-tab hidden" role="tabpanel" data-testid="gateway-issuer-config-panel">
                    <!-- Gateway issuer configuration content will be injected here -->
                </div>
                <div id="gateway-token-verification" class="tab-pane gateway-tab hidden" role="tabpanel" data-testid="gateway-token-verification-panel">
                    <!-- Gateway token verification content will be injected here -->
                </div>
                <!-- Shared panes -->
                <div id="metrics" class="tab-pane" role="tabpanel">
                    <!-- Metrics content will be injected here -->
                </div>
                <div id="help" class="tab-pane" role="tabpanel">
                    <!-- Help tab: static content, no JS needed -->
                    <div id="jwt-help-content" class="jwt-tab-content help-tab" data-testid="help-tab-content">
                        <div class="help-header">
                            <h2 data-i18n="help.heading">Component Help</h2>
                        </div>

                        <div class="help-sections">
                            <!-- JWT-specific help sections -->
                            <div class="help-section jwt-help" data-testid="help-accordion-item">
                                <h4 class="collapsible-header active" data-testid="accordion-toggle">
                                    <i class="fa fa-chevron-down"></i> <span data-i18n="help.jwt.getting.started.title">Getting Started</span>
                                </h4>
                                <div class="collapsible-content show" data-testid="accordion-content">
                                    <p data-i18n="help.jwt.getting.started.intro">The MultiIssuerJWTTokenAuthenticator processor validates JWT tokens from
                                    multiple issuers. Follow these steps to configure:</p>
                                    <ol>
                                        <li data-i18n="help.jwt.getting.started.step1">Add at least one issuer configuration</li>
                                        <li data-i18n="help.jwt.getting.started.step2">Configure the JWKS URL or file path for each issuer</li>
                                        <li data-i18n="help.jwt.getting.started.step3">Set up authorization rules (optional)</li>
                                        <li data-i18n="help.jwt.getting.started.step4">Test your configuration using the Token Verification tab</li>
                                    </ol>
                                </div>
                            </div>

                            <div class="help-section jwt-help" data-testid="help-accordion-item">
                                <h4 class="collapsible-header" data-testid="accordion-toggle">
                                    <i class="fa fa-chevron-right"></i> <span data-i18n="help.jwt.issuer.config.title">Issuer Configuration</span>
                                </h4>
                                <div class="collapsible-content" data-testid="accordion-content">
                                    <h5 data-i18n="help.jwt.issuer.config.dynamic.title">Dynamic Properties</h5>
                                    <p data-i18n="help.jwt.issuer.config.dynamic.desc">Each issuer is configured using dynamic properties with the pattern:</p>
                                    <code>jwt.issuer.&lt;issuer-name&gt;.jwks.url</code>

                                    <h5 data-i18n="help.jwt.issuer.config.examples.title">Example Configurations</h5>
                                    <div class="example-config">
                                        <strong>Keycloak:</strong><br>
                                        <code>jwt.issuer.keycloak.jwks.url =<br>
                                            &nbsp;&nbsp;https://keycloak.example.com/realms/myrealm/<br>
                                            &nbsp;&nbsp;protocol/openid-connect/certs
                                        </code>
                                    </div>

                                    <div class="example-config">
                                        <strong>Auth0:</strong><br>
                                        <code>jwt.issuer.auth0.jwks.url =
                                            https://yourdomain.auth0.com/.well-known/jwks.json</code>
                                    </div>

                                    <div class="example-config">
                                        <strong>Local File:</strong><br>
                                        <code>jwt.issuer.local.jwks.file = /path/to/jwks.json</code>
                                    </div>
                                </div>
                            </div>

                            <div class="help-section jwt-help" data-testid="help-accordion-item">
                                <h4 class="collapsible-header" data-testid="accordion-toggle">
                                    <i class="fa fa-chevron-right"></i> <span data-i18n="help.jwt.auth.rules.title">Authorization Rules</span>
                                </h4>
                                <div class="collapsible-content" data-testid="accordion-content">
                                    <p data-i18n="help.jwt.auth.rules.intro">Control access based on JWT claims using these properties:</p>

                                    <h5 data-i18n="help.jwt.auth.scopes.title">Required Scopes</h5>
                                    <p data-i18n="help.jwt.auth.scopes.desc">Specify scopes that must be present in the token:</p>
                                    <code>Required Scopes = read write admin</code>

                                    <h5 data-i18n="help.jwt.auth.roles.title">Required Roles</h5>
                                    <p data-i18n="help.jwt.auth.roles.desc">Specify roles that must be present in the token:</p>
                                    <code>Required Roles = user manager</code>

                                    <h5 data-i18n="help.jwt.auth.flowfile.title">Flow File Attributes</h5>
                                    <p data-i18n="help.jwt.auth.flowfile.desc">The processor adds these attributes to flow files:</p>
                                    <ul>
                                        <li><code>jwt.subject</code> - <span data-i18n="help.jwt.auth.flowfile.subject">Token subject (user)</span></li>
                                        <li><code>jwt.issuer</code> - <span data-i18n="help.jwt.auth.flowfile.issuer">Token issuer</span></li>
                                        <li><code>jwt.scopes</code> - <span data-i18n="help.jwt.auth.flowfile.scopes">Space-separated scopes</span></li>
                                        <li><code>jwt.roles</code> - <span data-i18n="help.jwt.auth.flowfile.roles">Space-separated roles</span></li>
                                        <li><code>jwt.authorized</code> - <span data-i18n="help.jwt.auth.flowfile.authorized">true/false based on rules</span></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-section jwt-help" data-testid="help-accordion-item">
                                <h4 class="collapsible-header" data-testid="accordion-toggle">
                                    <i class="fa fa-chevron-right"></i> <span data-i18n="help.jwt.token.verification.title">Token Verification</span>
                                </h4>
                                <div class="collapsible-content" data-testid="accordion-content">
                                    <p data-i18n="help.jwt.token.verification.intro">Use the Token Verification tab to test JWT tokens:</p>
                                    <ol>
                                        <li data-i18n="help.jwt.token.verification.step1">Paste a JWT token in the input field</li>
                                        <li data-i18n="help.jwt.token.verification.step2">Click "Verify Token"</li>
                                        <li data-i18n="help.jwt.token.verification.step3">Review the validation results</li>
                                    </ol>

                                    <h5 data-i18n="help.jwt.token.verification.issues.title">Common Issues</h5>
                                    <ul>
                                        <li><strong>Invalid Signature:</strong> <span data-i18n="help.jwt.token.verification.issue.signature">Check that the JWKS URL is correct</span></li>
                                        <li><strong>Token Expired:</strong> <span data-i18n="help.jwt.token.verification.issue.expired">Generate a new token</span></li>
                                        <li><strong>Unknown Issuer:</strong> <span data-i18n="help.jwt.token.verification.issue.unknown">Add the issuer configuration</span></li>
                                        <li><strong>Missing Scopes:</strong> <span data-i18n="help.jwt.token.verification.issue.scopes">Ensure token contains required scopes</span></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Gateway-specific help sections -->
                            <div class="help-section gateway-help" data-testid="help-accordion-item">
                                <h4 class="collapsible-header active" data-testid="accordion-toggle">
                                    <i class="fa fa-chevron-down"></i> <span data-i18n="help.gateway.title">REST API Gateway</span>
                                </h4>
                                <div class="collapsible-content show" data-testid="accordion-content">
                                    <p data-i18n="help.gateway.intro">The RestApiGatewayProcessor provides a secure REST API gateway with
                                    JWT authentication and route-based access control.</p>
                                    <h5 data-i18n="help.gateway.features.title">Key Features</h5>
                                    <ul>
                                        <li data-i18n="help.gateway.features.https">Embedded HTTPS/HTTP server with configurable port</li>
                                        <li data-i18n="help.gateway.features.routing">Route-based request matching with path patterns</li>
                                        <li data-i18n="help.gateway.features.auth">Per-route role and scope requirements</li>
                                        <li data-i18n="help.gateway.features.cors">CORS support with configurable allowed origins</li>
                                        <li data-i18n="help.gateway.features.limits">Request body size limits and queue management</li>
                                    </ul>
                                    <h5 data-i18n="help.gateway.tabs.title">Tabs</h5>
                                    <ul>
                                        <li><strong>Endpoint Configuration:</strong> <span data-i18n="help.gateway.tabs.endpoint">View active routes, global settings, and security configuration</span></li>
                                        <li><strong>Endpoint Tester:</strong> <span data-i18n="help.gateway.tabs.tester">Send test requests to verify route access and authentication</span></li>
                                        <li><strong>Issuer Configuration:</strong> <span data-i18n="help.gateway.tabs.issuer">Manage JWT issuer settings from the linked Controller Service</span></li>
                                        <li><strong>Token Verification:</strong> <span data-i18n="help.gateway.tabs.token">Paste and verify JWT tokens against configured issuers</span></li>
                                        <li><strong>Metrics:</strong> <span data-i18n="help.gateway.tabs.metrics">Monitor token validation, HTTP security events, and gateway activity</span></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Shared help sections -->
                            <div class="help-section" data-testid="help-accordion-item">
                                <h4 class="collapsible-header" data-testid="accordion-toggle">
                                    <i class="fa fa-chevron-right"></i> <span data-i18n="help.troubleshooting.title">Troubleshooting</span>
                                </h4>
                                <div class="collapsible-content" data-testid="accordion-content">
                                    <h5 data-i18n="help.troubleshooting.jwks.title">JWKS Loading Issues</h5>
                                    <ul>
                                        <li data-i18n="help.troubleshooting.jwks.network">Verify network connectivity to JWKS endpoints</li>
                                        <li data-i18n="help.troubleshooting.jwks.ssl">Check SSL/TLS certificates for HTTPS endpoints</li>
                                        <li data-i18n="help.troubleshooting.jwks.paths">Ensure file paths are absolute for local JWKS files</li>
                                        <li data-i18n="help.troubleshooting.jwks.test">Use the JWKS Validation button to test endpoints</li>
                                    </ul>

                                    <h5 data-i18n="help.troubleshooting.performance.title">Performance Tips</h5>
                                    <ul>
                                        <li data-i18n="help.troubleshooting.performance.cache">JWKS are cached for 5 minutes by default</li>
                                        <li data-i18n="help.troubleshooting.performance.local">Use local JWKS files for better performance</li>
                                        <li data-i18n="help.troubleshooting.performance.monitor">Monitor the Metrics tab for performance data</li>
                                    </ul>

                                    <h5 data-i18n="help.troubleshooting.security.title">Security Best Practices</h5>
                                    <ul>
                                        <li data-i18n="help.troubleshooting.security.https">Always use HTTPS for JWKS endpoints</li>
                                        <li data-i18n="help.troubleshooting.security.rotate">Rotate signing keys regularly</li>
                                        <li data-i18n="help.troubleshooting.security.rules">Implement proper authorization rules</li>
                                        <li data-i18n="help.troubleshooting.security.monitor">Monitor failed validations in the Metrics tab</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="help-section" data-testid="help-accordion-item">
                                <h4 class="collapsible-header" data-testid="accordion-toggle">
                                    <i class="fa fa-chevron-right"></i> <span data-i18n="help.resources.title">Additional Resources</span>
                                </h4>
                                <div class="collapsible-content" data-testid="accordion-content">
                                    <ul class="resource-links">
                                        <li><a href="https://jwt.io/introduction"
                                               target="_blank" rel="noopener noreferrer">
                                            <i class="fa fa-external-link"></i> <span data-i18n="help.resources.jwt">JWT Introduction</span>
                                        </a></li>
                                        <li><a href="https://tools.ietf.org/html/rfc7517"
                                               target="_blank" rel="noopener noreferrer">
                                            <i class="fa fa-external-link"></i> <span data-i18n="help.resources.jwk">JWK Specification</span>
                                        </a></li>
                                        <li><a href="https://nifi.apache.org/docs.html"
                                               target="_blank" rel="noopener noreferrer">
                                            <i class="fa fa-external-link"></i> <span data-i18n="help.resources.nifi">Apache NiFi Docs</span>
                                        </a></li>
                                    </ul>

                                    <div class="help-footer">
                                        <p><strong data-i18n="help.footer.version">Version:</strong> 1.0.0</p>
                                        <p><strong data-i18n="help.footer.support">Support:</strong> support@cuioss.de</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Load application as ES module (includes collapsible section handling) -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
