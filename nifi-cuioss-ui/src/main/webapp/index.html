<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiIssuerJWTTokenAuthenticator UI</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Load external dependencies from WebJars (maintained by Maven) -->
    
    <!-- Load Cash-DOM (jQuery alternative) -->
    <script type="text/javascript" src="webjars/cash-dom/8.1.5/dist/cash.min.js"></script>

    <!-- Load Popper.js (required by Tippy.js) -->
    <script type="text/javascript" src="webjars/popperjs__core/2.11.8/dist/umd/popper.min.js"></script>

    <!-- Load Tippy.js for tooltips -->
    <script type="text/javascript" src="webjars/tippy.js/6.3.7/dist/tippy.umd.min.js"></script>
    <link rel="stylesheet" href="webjars/tippy.js/6.3.7/dist/tippy.css">

    <!-- Load FontAwesome CSS - we need our own copy because:
         1. We run in an iframe that might not inherit parent styles reliably
         2. NiFi's dynamically injected FA 4.7.0 CSS has broken font paths (404 errors)
         3. Ensures consistent icon availability across all contexts
         Note: The 404 errors from NiFi's broken paths are harmless -->
    <link rel="stylesheet" href="webjars/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="webjars/font-awesome/6.7.2/css/v4-shims.min.css">

    <!-- NiFi will provide globalThis.nf.Common in production -->
    <script type="text/javascript">
        // In production, NiFi provides the nf.Common object
        // Map it to nfCommon for compatibility with our code
        if (typeof globalThis.nf !== 'undefined' && globalThis.nf.Common) {
            globalThis.nfCommon = globalThis.nf.Common;
        } else if (typeof globalThis.nfCommon === 'undefined') {
            // Only log error if nfCommon is not already available from another source
            console.warn('NiFi Common API not available. UI functionality may be limited.');
            // Create a minimal stub to prevent errors
            globalThis.nfCommon = {
                registerCustomUiTab: function() { console.warn('registerCustomUiTab called but NiFi API not available'); },
                getI18n: function() { 
                    return { 
                        getProperty: function(key) { return key; }
                    };
                }
            };
        }
    </script>
</head>
<body>
    <div id="jwt-validator-container" data-testid="jwt-customizer-container">
        <!-- This container will be populated by the JavaScript UI components -->
        <h1 class="sr-only">JWT Token Authenticator Configuration</h1>
        <div id="loading-indicator">Loading JWT Validator UI...</div>
        
        <!-- Tab structure for JWT configuration -->
        <div id="jwt-validator-tabs" class="jwt-tabs-container" style="display:none;" role="main">
            <div class="jwt-tabs-header" data-testid="jwt-config-tabs">
                <ul class="tabs" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#issuer-config" role="tab" data-toggle="tab">Configuration</a>
                    </li>
                    <li role="presentation">
                        <a href="#token-verification" role="tab" data-toggle="tab">Token Verification</a>
                    </li>
                    <li role="presentation">
                        <a href="#metrics" role="tab" data-toggle="tab">Metrics</a>
                    </li>
                    <li role="presentation">
                        <a href="#help" role="tab" data-toggle="tab">Help</a>
                    </li>
                </ul>
            </div>
            <div class="jwt-tabs-content">
                <div id="issuer-config" class="tab-pane active" role="tabpanel" data-testid="issuer-config-panel">
                    <!-- Issuer configuration content will be injected here -->
                </div>
                <div id="token-verification" class="tab-pane" role="tabpanel">
                    <!-- Token verification content will be injected here -->
                </div>
                <div id="metrics" class="tab-pane" role="tabpanel">
                    <!-- Metrics content will be injected here -->
                </div>
                <div id="help" class="tab-pane" role="tabpanel">
                    <!-- Help content will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load our modern ES6 bundle built with Vite -->
    <script type="text/javascript" src="js/bundle.js?v=20250730"></script>
    
    <!-- Initialize the JWT UI -->
    <script type="text/javascript">
        // Initialize the JWT UI components when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing JWT UI...');
            
            // Initialize the UI components - the bundle exposes nifiCuiossUI global variable
            if (globalThis.nifiCuiossUI && typeof globalThis.nifiCuiossUI.init === 'function') {
                console.log('Initializing JWT UI from Vite bundle');
                globalThis.nifiCuiossUI.init().then(function(success) {
                    if (success) {
                        console.log('JWT UI initialization completed successfully');
                    } else {
                        console.warn('JWT UI initialization completed with warnings');
                    }
                }).catch(function(error) {
                    console.error('JWT UI initialization failed:', error);
                });
            } else {
                console.error('nifiCuiossUI not found in global scope. Bundle may not have loaded correctly.');
            }
        });
        
        // Add global error handler for debugging
        globalThis.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });
    </script>
</body>
</html>