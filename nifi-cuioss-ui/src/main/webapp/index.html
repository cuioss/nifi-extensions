<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiIssuerJWTTokenAuthenticator UI</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Load external dependencies from WebJars (maintained by Maven) -->
    
    <!-- Load Cash-DOM (jQuery alternative) -->
    <script type="text/javascript" src="webjars/cash-dom/8.1.5/dist/cash.min.js"></script>
    
    <!-- Load Cash-DOM polyfill for missing jQuery methods -->
    <script type="text/javascript" src="js/cash-dom-polyfill.js"></script>

    <!-- Load Popper.js (required by Tippy.js) -->
    <script type="text/javascript" src="webjars/popperjs__core/2.11.8/dist/umd/popper.min.js"></script>

    <!-- Load Tippy.js for tooltips -->
    <script type="text/javascript" src="webjars/tippy.js/6.3.7/dist/tippy.umd.min.js"></script>
    <link rel="stylesheet" href="webjars/tippy.js/6.3.7/dist/tippy.css">

    <!-- Load FontAwesome CSS - we need our own copy because:
         1. We run in an iframe that might not inherit parent styles reliably
         2. NiFi's dynamically injected FA 4.7.0 CSS has broken font paths (404 errors)
         3. Ensures consistent icon availability across all contexts
         Note: The 404 errors from NiFi's broken paths are harmless -->
    <link rel="stylesheet" href="webjars/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="webjars/font-awesome/6.7.2/css/v4-shims.min.css">

    <!-- Load NiFi Common mock for standalone testing -->
    <script type="text/javascript" src="js/nf-common-mock.js"></script>
    
    <!-- Make nf.Common available as global variable for bundle -->
    <script type="text/javascript">
        // Ensure nf.Common is available as a global for the bundle
        // The nfCommon global is already set by nf-common-mock.js
        if (typeof window.nfCommon === 'undefined') {
            console.warn('nfCommon is not defined. This may cause issues with the bundle.');
        }
    </script>
</head>
<body>
    <div id="jwt-validator-container" data-testid="jwt-customizer-container">
        <!-- This container will be populated by the JavaScript UI components -->
        <div id="loading-indicator">Loading JWT Validator UI...</div>
        
        <!-- Tab structure for JWT configuration -->
        <div id="jwt-validator-tabs" class="jwt-tabs-container" style="display:none;">
            <div class="jwt-tabs-header" data-testid="jwt-config-tabs">
                <ul class="tabs" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#issuer-config" role="tab" data-toggle="tab">Configuration</a>
                    </li>
                    <li role="presentation">
                        <a href="#token-verification" role="tab" data-toggle="tab">Token Verification</a>
                    </li>
                    <li role="presentation">
                        <a href="#metrics" role="tab" data-toggle="tab">Metrics</a>
                    </li>
                    <li role="presentation">
                        <a href="#help" role="tab" data-toggle="tab">Help</a>
                    </li>
                </ul>
            </div>
            <div class="jwt-tabs-content">
                <div id="issuer-config" class="tab-pane active" role="tabpanel" data-testid="issuer-config-panel">
                    <!-- Issuer configuration content will be injected here -->
                </div>
                <div id="token-verification" class="tab-pane" role="tabpanel">
                    <!-- Token verification content will be injected here -->
                </div>
                <div id="metrics" class="tab-pane" role="tabpanel">
                    <!-- Metrics content will be injected here -->
                </div>
                <div id="help" class="tab-pane" role="tabpanel">
                    <!-- Help content will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load our modern ES6 bundle built with Vite -->
    <script type="text/javascript" src="js/bundle.vite.umd.js?v=20250726"></script>
    
    <!-- Initialize the JWT UI -->
    <script type="text/javascript">
        // Initialize the JWT UI components when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing JWT UI...');
            
            // Initialize the UI components - the bundle exposes nifiCuiossUI global variable
            if (window.nifiCuiossUI && typeof window.nifiCuiossUI.init === 'function') {
                console.log('Initializing JWT UI from Vite bundle');
                window.nifiCuiossUI.init().then(function(success) {
                    if (success) {
                        console.log('JWT UI initialization completed successfully');
                    } else {
                        console.warn('JWT UI initialization completed with warnings');
                    }
                }).catch(function(error) {
                    console.error('JWT UI initialization failed:', error);
                });
            } else {
                console.error('nifiCuiossUI not found in global scope. Bundle may not have loaded correctly.');
            }
        });
        
        // Add global error handler for debugging
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });
    </script>
</body>
</html>