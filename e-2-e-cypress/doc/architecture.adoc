= Technical Architecture
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

== Purpose

This document covers the technical architecture, infrastructure, and implementation details of the NiFi integration testing framework.

== System Architecture

=== Infrastructure Overview

[source]
----
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Cypress       │────│   Docker Host    │────│   Test Data     │
│   Test Runner   │    │                  │    │   Fixtures      │
└─────────────────┘    │  ┌─────────────┐ │    └─────────────────┘
                       │  │    NiFi     │ │
                       │  │   2.4.0     │ │
                       │  └─────────────┘ │
                       │  ┌─────────────┐ │
                       │  │  Keycloak   │ │
                       │  │   OIDC      │ │
                       │  └─────────────┘ │
                       └──────────────────┘
----

=== Component Stack

* *Test Framework*: Cypress 14.4.1 with custom commands
* *Target Application*: NiFi 2.4.0 with Angular 19.2.14 UI
* *Authentication*: Built-in NiFi authentication
* *Infrastructure*: Docker with custom Dockerfile
* *Build System*: Maven with frontend-maven-plugin
* *CI/CD*: GitHub Actions with automated testing

== Infrastructure Details

=== Docker Environment

The testing environment uses containerized infrastructure for consistency:

[source,yaml]
----
# docker-compose.yml structure (actual configuration)
services:
  nifi:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "9095:8443"  # NiFi HTTPS UI
    environment:
      - NIFI_WEB_HTTP_PORT=
      - NIFI_WEB_HTTPS_PORT=8443
      - NIFI_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_WEB_PROXY_HOST=localhost:9095
      - NIFI_SECURITY_ALLOW_ANONYMOUS_AUTHENTICATION=false
    volumes:
      - ../../../../target/nifi-deploy:/opt/nifi/nifi-current/nar_extensions
    healthcheck:
      test: ["CMD-SHELL", "curl -k --fail --max-time 3 https://localhost:8443/nifi/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
      
  keycloak:
    image: quay.io/keycloak/keycloak:25.0
    ports:
      - "9080:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KC_HTTP_ENABLED=true
----

=== Network Configuration and Access Points

==== Service URLs

* **NiFi UI**: `https://localhost:9095/nifi/`
* **NiFi API**: `https://localhost:9095/nifi-api/`
* **Keycloak**: `http://localhost:9080/`
* **Keycloak Health**: `http://localhost:9086/health`

==== Test Credentials

* **Username**: `testUser`
* **Password**: `drowssap`

==== Health Check Endpoints

* **NiFi Health**: `https://localhost:9095/nifi-api/system-diagnostics`
* **NiFi Status**: `https://localhost:9095/nifi/`
* **Keycloak Health**: `http://localhost:9080/health`

=== Authentication Flow

[source]
----
User → Cypress → cy.session() → Direct Form Login → NiFi Session → NiFi Access
(Current implementation uses cy.session for reliability and performance)
----

== Testing Framework Architecture

=== Core Components

==== Helper-Based Architecture

[source]
----
cypress/support/
├── commands/                    # Custom Cypress commands
│   ├── auth-helper.js          # Authentication management with cy.session
│   ├── navigation-helper.js    # Page navigation and detection
│   ├── processor-helper.js     # Processor lifecycle operations
│   └── utils.js               # Utility functions
├── constants.js                # Shared selectors and constants
├── test-helpers.js            # Common test utilities
└── e2e.js                     # Main support file
----

==== Constants and Configuration

[source,javascript]
----
// cypress/support/constants.js - Current Implementation
export const PAGE_TYPES = {
  LOGIN: 'LOGIN',
  MAIN_CANVAS: 'MAIN_CANVAS',
  UNKNOWN: 'UNKNOWN',
};

export const SELECTORS = {
  // Canvas selectors - Angular Material patterns
  CANVAS: '#canvas-container',
  CANVAS_CONTAINER: 'mat-sidenav-content',
  CANVAS_SIDENAV_CONTAINER: 'mat-sidenav-container',
  
  // Processor selectors - SVG-based patterns
  PROCESSOR_GROUP: 'svg g[class*="processor"], svg g[data-type*="processor"], svg .component',
  PROCESSOR_ELEMENT: '.processor, [class*="processor"], .component, .flow-component',
  
  // Dialog selectors - Angular Material dialog patterns
  ADD_PROCESSOR_DIALOG: 'mat-dialog-container, .mat-dialog-container, [role="dialog"]',
  PROPERTIES_DIALOG: 'mat-dialog-container, .mat-dialog-container, [role="dialog"]'
};

export const TIMEOUTS = {
  DEFAULT: 10000,
  LONG: 30000,
  AUTHENTICATION: 15000,
  PROCESSOR_LOAD: 20000
};

export const DEFAULT_CREDENTIALS = {
  USERNAME: 'testUser',
  PASSWORD: 'drowssap'
};

export const SERVICE_URLS = {
  NIFI_BASE: 'https://localhost:9095/nifi',
  NIFI_SYSTEM_DIAGNOSTICS: 'https://localhost:9095/nifi-api/system-diagnostics'
};
----

=== Element Discovery Strategy

The framework implements a multi-strategy approach for robust element discovery:

[source,javascript]
----
// Multi-strategy element discovery
const discoveryStrategies = [
  // Strategy 1: Data attributes (preferred)
  `[data-testid="${targetId}"]`,
  
  // Strategy 2: Semantic selectors
  `[aria-label*="${targetLabel}"]`,
  
  // Strategy 3: Content-based
  `:contains("${targetText}")`,
  
  // Strategy 4: Angular-specific
  `mat-${componentType}[id*="${targetId}"]`
];

function findElementRobustly(selectors, options = {}) {
  return cy.get('body').then(($body) => {
    for (const selector of selectors) {
      const $element = $body.find(selector);
      if ($element.length > 0) {
        return cy.wrap($element);
      }
    }
    throw new Error(`Element not found with any strategy`);
  });
}
----

=== Error Handling Architecture

==== Retry Strategy

[source,javascript]
----
// Smart retry with exponential backoff
Cypress.Commands.add('robustAction', (action, options = {}) => {
  const maxRetries = options.maxRetries || 3;
  const baseDelay = options.baseDelay || 1000;
  
  function attemptAction(attempt = 0) {
    return cy.wrap(null).then(() => {
      try {
        return action();
      } catch (error) {
        if (attempt < maxRetries) {
          const delay = baseDelay * Math.pow(2, attempt);
          cy.wait(delay);
          return attemptAction(attempt + 1);
        }
        throw error;
      }
    });
  }
  
  return attemptAction();
});
----

==== Graceful Degradation

[source,javascript]
----
// Fallback strategies for UI changes
function navigateWithFallback(primarySelector, fallbackSelectors) {
  return cy.get('body').then(($body) => {
    if ($body.find(primarySelector).length > 0) {
      return cy.get(primarySelector);
    }
    
    for (const fallback of fallbackSelectors) {
      if ($body.find(fallback).length > 0) {
        cy.log(`Using fallback selector: ${fallback}`);
        return cy.get(fallback);
      }
    }
    
    throw new Error('No working selector found');
  });
}
----

== Performance Optimizations

=== Selector Optimization

* *Data Attributes*: Preferred for stability
* *Caching*: Element references cached when possible
* *Batch Operations*: Multiple actions combined
* *Smart Waiting*: Condition-based waits instead of fixed delays

=== Resource Management

[source,javascript]
----
// Memory-efficient test execution (cypress/support/e2e.js)
beforeEach(() => {
  // Set shorter timeout for individual commands within tests
  Cypress.config('defaultCommandTimeout', 10000);
  
  // Fail fast on viewport issues
  cy.viewport(1280, 720);
});

afterEach(() => {
  // Save browser logs for persistent storage
  cy.task('saveBrowserLogs');
  
  // Verify no unexpected console errors
  cy.verifyNoConsoleErrors();
  cy.verifyNoUnexpectedWarnings();
});

// Uncaught exception handling with selective ignoring
Cypress.on('uncaught:exception', (err) => {
  const shouldIgnore = IGNORED_ERROR_PATTERNS.some((ignoredError) =>
    err.message.includes(ignoredError)
  );
  return !shouldIgnore; // Fail fast on unexpected errors
});
----

=== Network Optimization

[source,javascript]
----
// Intercept and optimize API calls
beforeEach(() => {
  // Cache static resources
  cy.intercept('GET', '/nifi-api/system-diagnostics', { fixture: 'system-diagnostics.json' });
  
  // Monitor critical API calls
  cy.intercept('POST', '/nifi-api/processors').as('createProcessor');
  cy.intercept('PUT', '/nifi-api/processors/*').as('updateProcessor');
});
----

== Build Integration

=== Maven Integration

[source,xml]
----
<!-- pom.xml configuration -->
<plugin>
  <groupId>com.github.eirslett</groupId>
  <artifactId>frontend-maven-plugin</artifactId>
  <configuration>
    <nodeVersion>v20.x.x</nodeVersion>
    <npmVersion>10.x.x</npmVersion>
  </configuration>
  <executions>
    <execution>
      <id>install-node-and-npm</id>
      <goals><goal>install-node-and-npm</goal></goals>
    </execution>
    <execution>
      <id>npm-install</id>
      <goals><goal>npm</goal></goals>
      <configuration>
        <arguments>install</arguments>
      </configuration>
    </execution>
    <execution>
      <id>cypress-tests</id>
      <goals><goal>npm</goal></goals>
      <configuration>
        <arguments>test</arguments>
      </configuration>
    </execution>
  </executions>
</plugin>
----

=== Profile Configuration

[source,xml]
----
<!-- Test execution profiles -->
<profiles>
  <profile>
    <id>selftests</id>
    <properties>
      <cypress.spec>cypress/e2e/selftests/**/*.cy.js</cypress.spec>
    </properties>
  </profile>
  <profile>
    <id>ui-tests</id>
    <properties>
      <cypress.spec>cypress/e2e/**/*.cy.js</cypress.spec>
      <docker.autostart>true</docker.autostart>
    </properties>
  </profile>
</profiles>
----

== Code Quality Framework

=== ESLint Configuration

Following centralized JavaScript standards:

[source,javascript]
----
// .eslintrc.js - Current Implementation
module.exports = {
  env: {
    browser: true,
    es2021: true,
    node: true,
    "cypress/globals": true
  },
  extends: [
    "eslint:recommended",
    "plugin:cypress/recommended",
    "plugin:jsdoc/recommended",
    "plugin:prettier/recommended"
  ],
  plugins: [
    "cypress", 
    "prettier", 
    "jsdoc", 
    "sonarjs", 
    "security",
    "unicorn"
  ],
  rules: {
    // CUI Standards - Fundamental Rules
    "no-console": "warn",
    "no-unused-vars": ["warn", { "argsIgnorePattern": "^_", "varsIgnorePattern": "^_" }],
    "prefer-const": "error",
    "cypress/no-unnecessary-waiting": "error",
    "cypress/assertion-before-screenshot": "warn",
    "complexity": ["error", 10],
    "max-depth": ["error", 4],
    "max-lines-per-function": ["error", 100]
  }
};
----

=== Quality Metrics

* *ESLint Warnings*: 0 (Zero-warning policy enforced)
* *Cognitive Complexity*: <10 per function
* *Max Function Length*: 100 lines (commands and support functions)
* *Max Nesting Depth*: 4 levels
* *Code Coverage*: Tracked via @cypress/code-coverage

== Security Considerations

=== Test Environment Security

* *Isolated Environment*: Docker containers with no production data
* *Test Credentials*: Dedicated test accounts with minimal privileges
* *Network Isolation*: Local Docker network with no external access
* *Data Protection*: No sensitive data in test fixtures

=== Authentication Security

[source,javascript]
----
// Current implementation - cy.session with direct form login
Cypress.Commands.add('loginNiFi', (username = 'testUser', password = 'drowssap') => {
  const sessionId = `nifi-login-${username}`;
  
  cy.session(sessionId, () => {
    cy.log(`🔐 Logging into NiFi as ${username}`);
    
    cy.visit(SERVICE_URLS.NIFI_BASE);
    
    // Wait for login form to be ready
    cy.get('input[type="text"], input[id*="username"], input[name="username"]', {
      timeout: TIMEOUTS.AUTHENTICATION
    })
      .should('be.visible')
      .clear()
      .type(username);
      
    cy.get('input[type="password"], input[id*="password"], input[name="password"]')
      .should('be.visible')
      .clear()
      .type(password, { log: false });
      
    cy.get('button[type="submit"], input[type="submit"], button').contains(/log\s*in/i)
      .click();
      
    // Verify successful login
    cy.url().should('not.include', '/login');
  });
});
----

== Monitoring and Observability

=== Test Metrics Collection

[source,javascript]
----
// Performance monitoring
Cypress.Commands.add('measurePerformance', (operation) => {
  const startTime = performance.now();
  
  return cy.wrap(operation()).then((result) => {
    const duration = performance.now() - startTime;
    
    cy.task('logMetric', {
      operation: operation.name,
      duration,
      timestamp: new Date().toISOString()
    });
    
    return result;
  });
});
----

=== Error Tracking

[source,javascript]
----
// Comprehensive error logging
Cypress.on('fail', (error) => {
  cy.task('logError', {
    message: error.message,
    stack: error.stack,
    test: Cypress.currentTest.title,
    timestamp: new Date().toISOString()
  });
});
----

=== Health Checks

[source,javascript]
----
// Infrastructure health monitoring
before(() => {
  cy.request({
    method: 'GET',
    url: 'https://localhost:9095/nifi/',
    failOnStatusCode: false
  }).then((response) => {
    // Accept both 200 and 401 (auth required) as healthy responses
    expect([200, 401]).to.include(response.status);
  });
});
----

== Scalability Considerations

=== Parallel Execution

* *Test Isolation*: Each test can run independently
* *Resource Sharing*: Shared Docker environment
* *Data Management*: Unique test data per thread
* *Result Aggregation*: Combined reporting across parallel runs

=== Container Scaling

[source,bash]
----
# Scale containers for load testing
docker-compose up --scale nifi=2 --scale keycloak=1

# Load balancer configuration for multiple NiFi instances
----

=== CI/CD Optimization

* *Container Caching*: Docker layer caching
* *Dependency Caching*: npm and Maven caching
* *Selective Testing*: Run only affected tests
* *Fast Feedback*: Critical path tests first

== See Also

* xref:setup-guide.adoc[Setup Guide] - Environment setup instructions
* xref:testing-patterns.adoc[Testing Patterns] - Implementation patterns and examples
* xref:overview.adoc[Project Overview] - High-level project description
