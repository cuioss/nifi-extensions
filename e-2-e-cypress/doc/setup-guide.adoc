= Setup and Configuration Guide
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

== Purpose

This guide provides complete setup instructions for the NiFi integration testing framework.

== Prerequisites

=== System Requirements

* *Java*: 11+ (required for Maven)
* *Maven*: 3.8.0+ (build system)
* *Docker*: Latest version with docker-compose
* *Node.js*: 20.x (auto-installed via Maven)

=== Verification Commands

[source,bash]
----
# Check Java version
java -version

# Check Maven version
mvn -version

# Check Docker availability
docker --version && docker compose version

# Verify Docker daemon is running
docker ps
----

== Environment Setup

=== Project Structure

[source]
----
nifi-extensions/
├── e-2-e-cypress/           # Cypress testing module
├── integration-testing/     # Docker environment
├── nifi-cuioss-processors/ # Custom processors
└── target/nifi-deploy/     # NAR deployment
----

=== Start Test Environment

[source,bash]
----
# Navigate to integration testing
cd integration-testing

# Start NiFi and Keycloak containers
./run-test-container.sh

# Verify containers are running
docker ps | grep -E "(nifi|keycloak)"
----

=== Install Testing Dependencies

[source,bash]
----
# Navigate to Cypress module
cd e-2-e-cypress

# Install dependencies (automatic via Maven)
mvn clean install

# Alternative: Direct npm install
npm install
----

== Configuration

=== Test Environment URLs

* *NiFi UI*: `https://localhost:9095/nifi/`
* *Keycloak*: `http://localhost:9080/`
* *Health Check*: `https://localhost:9095/nifi-api/system-diagnostics`

=== Authentication

* *Username*: `admin`
* *Password*: `ctsBtRBKHRAx69EqUghvvgEvjnaLjFEB`

=== NAR Deployment Verification

[source,bash]
----
# Check NAR file exists
ls -la ../target/nifi-deploy/

# Verify processor availability in NiFi UI
# Navigate to: Add Processor → Filter: "MultiIssuer"
----

== Test Execution

IMPORTANT: All testing requires verification with two essential Maven commands for comprehensive validation.

=== Required Verification Commands

Both commands must pass before committing changes:

1. *Full Build Verification* (lint, unit tests, build artifacts):
+
[source,bash]
----
./mvnw clean verify
----

2. *Integration Tests* (E2E tests with Docker environment):
+
[source,bash]
----
./mvnw clean verify -pl e-2-e-cypress -Pintegration-tests
----

=== Integration Test Process

The integration test command performs the following:

1. *Clean Build*: Removes previous build artifacts
2. *Dependency Management*: Auto-installs Node.js 20.x and npm dependencies
3. *Docker Lifecycle*: Starts NiFi + Keycloak containers
4. *Service Readiness*: Waits for services to be ready (max 2 minutes)
5. *E2E Tests*: Runs all Cypress E2E tests (including self-tests) in headless mode
6. *Cleanup*: Stops and removes Docker containers
7. *Verification*: Reports build SUCCESS/FAILURE

=== Service URLs During Test Execution

* *NiFi UI*: `https://localhost:9095/nifi/`
* *Keycloak*: `http://localhost:9080/`
* *NiFi API*: `https://localhost:9095/nifi-api/`

=== Development Workflow

==== Build Modes

1. *Lint-Only Mode* (safe, no containers needed):
+
[source,bash]
----
./mvnw clean verify -pl e-2-e-cypress
----
+
* Only runs code linting and formatting checks
* No tests executed, no containers started
* Safe for quick code quality verification

2. *Full Integration Mode* (requires containers):
+
[source,bash]
----
./mvnw clean verify -pl e-2-e-cypress -Pintegration-tests
----
+
* Manages complete Docker environment lifecycle
* Runs all E2E tests (including self-tests and functional tests)
* Full automated testing pipeline

==== Implementation Workflow

For implementing new tests or commands:

1. Make your changes (add tests, commands, etc.)
2. Verify with both required commands:
   * `./mvnw clean verify` (full build verification)
   * `./mvnw clean verify -pl e-2-e-cypress -Pintegration-tests` (integration tests)
3. If either command fails: Fix immediately (fail-fast principle)
4. Commit only after both commands pass successfully
5. Repeat for next change

=== Video Recording

Enable video recording for test documentation and debugging:

[source,bash]
----
# Run integration tests with video recording enabled
CYPRESS_VIDEO=true ./mvnw clean verify -pl e-2-e-cypress -Pintegration-tests

# Run specific test with video recording
CYPRESS_VIDEO=true npx cypress run --spec "cypress/e2e/07-processor-functional-single-issuer.cy.js"

# Use npm script for video recording
npm run cypress:run:video --spec="cypress/e2e/07-processor-functional-single-issuer.cy.js"
----

==== Video Configuration

* *Location*: `cypress/videos/` (created automatically)
* *Format*: MP4 with H.264 encoding
* *Compression*: 15 CRF (configurable in `cypress.config.js`)
* *Naming*: Follows test file name (e.g., `07-processor-functional-single-issuer.cy.js.mp4`)

NOTE: Video recording is only enabled when `CYPRESS_VIDEO=true` environment variable is set, requires NiFi server to be running for actual functional test recordings, and videos are automatically cleaned up between test runs.

=== Legacy Methods

Manual environment startup (for debugging only):

[source,bash]
----
# Start containers manually
cd ../integration-testing
./run-test-container.sh

# Run tests directly via npm
cd ../e-2-e-cypress
npm test

# Run specific test patterns
npx cypress run --spec "cypress/e2e/*processor*.cy.js"

# Stop containers manually
cd ../integration-testing
./stop-test-container.sh
----

IMPORTANT: The Maven command is the primary method because it ensures consistent environment setup, provides reliable container lifecycle management, integrates with CI/CD pipelines, and enforces fail-fast development principles.

== Build Integration

=== Maven Profiles

[source,bash]
----
# Run lint check only (safe mode - no tests)
./mvnw clean verify -pl e-2-e-cypress

# Run integration tests with containers (includes all E2E tests)
./mvnw clean verify -pl e-2-e-cypress -Pintegration-tests

# Run UI tests (requires manually started containers)
mvn verify -Pui-tests

# Combined build with testing
mvn clean install -Pui-tests
----

=== Maven Profile Configuration

The integration tests use Maven profiles for container management:

[source,xml]
----
<!-- CUI-compliant container lifecycle management -->
<profile>
  <id>integration-tests</id>
  <build>
    <plugins>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>exec-maven-plugin</artifactId>
        <executions>
          <execution>
            <id>start-containers</id>
            <phase>pre-integration-test</phase>
            <goals>
              <goal>exec</goal>
            </goals>
            <configuration>
              <executable>mvn</executable>
              <workingDirectory>../integration-testing</workingDirectory>
              <arguments>
                <argument>docker:start</argument>
              </arguments>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</profile>
----

== Verification Procedures

=== Health Checks

[source,bash]
----
# Check system status
npm run status

# Verify NiFi API availability
curl -k -f https://localhost:9095/nifi-api/system-diagnostics

# Check authentication
curl -f http://localhost:9080/realms/nifi
----

=== Test Environment Validation

[source,bash]
----
# Check system status
npm run status

# Verify test execution
npm run cypress:run --spec "cypress/e2e/01-nifi-authentication.cy.js"
----

== Troubleshooting

=== Common Issues

==== Container Startup Problems

[source,bash]
----
# Check container logs
docker compose logs nifi
docker compose logs keycloak

# Restart containers
docker compose down && docker compose up -d

# Clean restart
docker compose down -v && docker compose up -d
----

==== Port Conflicts

[source,bash]
----
# Check port usage
netstat -tulpn | grep -E "(9080|9094|9085)"

# Alternative ports in docker-compose.yml if needed
----

==== NAR Deployment Issues

[source,bash]
----
# Rebuild and redeploy
cd ..
mvn clean install
ls -la target/nifi-deploy/

# Check NiFi logs for deployment
docker compose logs nifi | grep -i "nar\|deploy"
----

==== Authentication Failures

[source,bash]
----
# Verify Keycloak status
curl http://localhost:9080/realms/nifi

# Check Keycloak logs
docker compose logs keycloak | tail -50

# Reset authentication state
rm -rf cypress/downloads cypress/screenshots
----

=== Performance Issues

==== Slow Test Execution

* Increase timeouts in `cypress.config.js`
* Use `cy.wait()` strategically, not excessively
* Optimize selectors for better performance

==== Memory Issues

[source,bash]
----
# Increase Docker memory allocation
# In Docker Desktop: Settings → Resources → Memory → 8GB+

# Monitor resource usage
docker stats
----

== Development Workflow

=== Code Quality Standards

This project follows centralized JavaScript standards:

[source,bash]
----
# Lint check
npm run lint

# Fix auto-fixable issues
npm run lint:fix

# Type checking (if applicable)
npm run format:check
----

=== Testing Best Practices

1. *Focus on Custom Logic*: Test JWT validation, not NiFi mechanics
2. *Minimal NiFi Interaction*: Use utilities for setup, focus on testing
3. *Error Handling*: Test edge cases and error scenarios
4. *Clean State*: Ensure proper cleanup in `afterEach()` hooks

=== File Organization

[source]
----
cypress/
├── e2e/
│   ├── auth/           # Authentication tests
│   ├── processors/     # Processor-specific tests
│   └── integration/    # Integration scenarios
├── support/
│   ├── commands/       # Custom commands
│   ├── constants.js    # Test constants
│   └── e2e.js         # Global configuration
└── fixtures/          # Test data
----

== Environment Variables

=== Configuration Options

[source,bash]
----
# Set test environment
export CYPRESS_ENV=local

# Custom timeouts
export CYPRESS_DEFAULT_TIMEOUT=10000

# Debug mode
export DEBUG=cypress:*

# Custom base URL
export CYPRESS_BASE_URL=https://localhost:9095
----

=== CI/CD Variables

[source,bash]
----
# GitHub Actions environment
export CI=true
export CYPRESS_RECORD_KEY=<record-key>

# Container health check
export CONTAINER_HEALTH_TIMEOUT=60
----

== Performance Optimization

=== Resource Management

* *Container Resources*: Allocate sufficient Docker memory (8GB+)
* *Test Parallelization*: Use Cypress Dashboard for parallel execution
* *Caching*: Leverage Maven and npm caching in CI/CD

=== Test Optimization

* *Selective Testing*: Run only relevant test suites
* *Fast Feedback*: Prioritize critical path tests
* *Efficient Selectors*: Use data attributes over CSS selectors

== See Also

* xref:testing-patterns.adoc[Testing Patterns] - Implementation examples and troubleshooting
* xref:architecture.adoc[Technical Architecture] - System architecture details
* xref:overview.adoc[Project Overview] - High-level project description
