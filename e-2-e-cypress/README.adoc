= End-to-End Cypress Testing Module

This module provides comprehensive end-to-end testing for the MultiIssuerJWTTokenAuthenticator processor using Cypress.

== ✅ Implementation Status: COMPLETE

The e-2-e-cypress module is *production-ready* with all core functionality implemented:

* ✅ 15+ Custom Cypress commands
* ✅ Self-verification unit test system (24 tests)
* ✅ Console error monitoring
* ✅ Complete test coverage (processor config, token validation, error handling)
* ✅ Maven integration with unified configuration
* ✅ Code quality standards (ESLint, Prettier) integrated into build
* ✅ Latest stable dependencies (Cypress 14.4.1, ESLint 8.57.1, Node.js 20.12.2)
* ✅ Unified frontend-maven-plugin configuration across modules

== Quick Start

=== Prerequisites

* Node.js 20.x or higher (automatically installed via Maven)
* Maven 3.8.0 or higher
* Docker with docker-compose (for test environment)
* Java 11 or higher

=== Installation

. Install dependencies:
+
[source,bash]
----
cd e-2-e-cypress
npm install
----

. Verify setup:
+
[source,bash]
----
./verify-setup.sh
----

. Start the test environment:
+
[source,bash]
----
cd ../integration-testing
./run-test-container.sh
----

. Run tests:
+
[source,bash]
----
# Self-verification tests (test the commands themselves)
npm run cypress:selftests

# Full end-to-end tests
npm run cypress:run

# Interactive mode
npm run cypress:open
----

== Test Structure

=== 📁 Self-Verification Tests (`cypress/selftests/`)

These tests verify that the custom Cypress commands work correctly:

* `login-commands.cy.js` - Tests login functionality
* `navigation-commands.cy.js` - Tests UI navigation
* `processor-commands.cy.js` - Tests processor operations

=== 📁 End-to-End Tests (`cypress/e2e/`)

Main test suites for the processor:

* `processor-config/multi-issuer-jwt-config.cy.js` - Processor configuration tests
* `token-validation/jwt-validation.cy.js` - JWT token validation tests  
* `token-validation/jwks-validation.cy.js` - JWKS validation tests
* `error-handling/error-scenarios.cy.js` - Error scenario tests

=== 🛠️ Custom Commands (`cypress/support/commands/`)

Reusable Cypress commands for common operations:

* `login.js` - Login and authentication commands
* `navigation.js` - UI navigation commands
* `processor.js` - Processor management commands
* `validation.js` - Token validation commands

==== Available Commands

*Login Commands:*

* `cy.nifiLogin(username, password)` - Login to NiFi UI
* `cy.keycloakLogin(username, password)` - Login to Keycloak
* `cy.verifyLoggedIn()` - Verify successful login state

*Navigation Commands:*

* `cy.navigateToCanvas()` - Navigate to NiFi canvas
* `cy.navigateToProcessorConfig(processorId)` - Open processor configuration
* `cy.navigateToControllerServices()` - Navigate to controller services

*Processor Commands:*

* `cy.addProcessor(type, position)` - Add processor to canvas
* `cy.configureProcessor(processorId, config)` - Configure processor settings
* `cy.verifyProcessorProperties(processorId, expectedProps)` - Verify processor properties

*Validation Commands:*

* `cy.generateToken(claims)` - Generate JWT token with specific claims
* `cy.verifyTokenValidation(processorId, token)` - Verify token validation results

=== Unit Tests (Self-Tests)

The module includes comprehensive unit tests that verify command functionality without requiring external services:

[source,bash]
----
# Run unit tests only
npm run cypress:selftests

# Run via Maven
mvn test -pl :e-2-e-cypress
----

*Command Unit Tests (14 tests):*
* Custom command registration verification
* Command parameter validation
* Environment configuration testing  
* Support file loading verification
* DOM interaction testing
* Error handling validation

*Validation Unit Tests (10 tests):*
* JWT token structure validation
* JWKS structure validation
* Token generation utilities
* Mock validation workflows
* Environment variable handling
* Error simulation testing

== Maven Integration

The module integrates with Maven through the unified `frontend-maven-plugin` configuration:

[source,bash]
----
# Run through Maven (includes linting + unit tests)
mvn clean test

# Run only self-tests (unit tests)
mvn clean pre-integration-test

# Run full test suite including E2E tests
mvn clean integration-test

# Check code formatting
npm run format:check

# Auto-fix formatting issues
npm run format
----

=== Unified Frontend Configuration

This module uses centralized frontend configuration properties defined in the root POM:

* `frontend.maven.plugin.version` - Frontend Maven plugin version (1.15.1)
* `frontend.node.version` - Node.js version (v20.12.2)  
* `frontend.npm.version` - NPM version (10.5.0)

=== Build Integration & Quality Checks

The Maven build includes automated quality checks:

. *Test phase*: ESLint runs with `--max-warnings 0` (build fails on any warnings)
. *Pre-integration-test phase*: Unit tests verify command functionality
. *Integration-test phase*: E2E tests run only if unit tests pass

=== Test Structure

[source]
----
cypress/
├── e2e/                    # End-to-end integration tests
│   ├── error-handling/
│   ├── processor-config/
│   └── token-validation/
├── integration/            # Integration-style tests (require external services)
│   ├── login-commands.cy.js
│   ├── navigation-commands.cy.js  
│   └── processor-commands.cy.js
├── selftests/             # Unit tests (no external dependencies)
│   ├── command-unit-tests.cy.js      # 14 tests - command registration & framework
│   └── validation-unit-tests.cy.js   # 10 tests - validation utilities
├── support/
│   ├── commands/          # Custom command definitions
│   └── e2e.js            # Test configuration
└── fixtures/              # Test data and HTML fixtures
----

== Configuration

=== Environment Variables

* `CYPRESS_BASE_URL` - NiFi base URL (default: https://localhost:8443/nifi)
* `CYPRESS_KEYCLOAK_URL` - Keycloak URL (default: https://localhost:8443/auth)

=== Test Configuration

Edit `cypress.config.js` to modify:

* Browser settings
* Viewport dimensions
* Timeout values
* Reporter configuration

=== Self-Test Configuration

Self-tests use a separate configuration (`cypress.selftests.config.js`) with:

* Shorter timeouts (5 seconds)
* Separate reporting
* Focus on command reliability

== Console Error Monitoring

The module includes automatic console error monitoring that:

* Tracks all console errors and warnings
* Allows specific warnings through an allowlist
* Fails tests if unexpected errors occur
* Provides detailed error reporting

Edit `cypress/support/console-warnings-allowlist.js` to manage allowed warnings:

[source,javascript]
----
module.exports = [
  'Warning: validateDOMNesting(...): <div> cannot appear as a descendant of <p>.',
  'DevTools failed to load source map',
  'Content Security Policy violation for inline script'
];
----

== Usage Examples

=== Basic Test Example

[source,javascript]
----
describe('Processor Configuration', () => {
  beforeEach(() => {
    cy.nifiLogin('admin', 'adminadminadmin');
    cy.navigateToCanvas();
  });

  it('should configure MultiIssuerJWTTokenAuthenticator', () => {
    cy.addProcessor('MultiIssuerJWTTokenAuthenticator').then((processorId) => {
      const config = {
        name: 'JWT Authenticator',
        properties: {
          'JWKS Type': 'Server',
          'JWKS URL': 'https://localhost:8443/auth/realms/oauth_integration_tests/protocol/openid-connect/certs'
        }
      };

      cy.configureProcessor(processorId, config);
      cy.verifyProcessorProperties(processorId, config.properties);
    });
  });
});
----

=== Token Validation Example

[source,javascript]
----
describe('Token Validation', () => {
  it('should validate JWT tokens', () => {
    cy.addProcessor('MultiIssuerJWTTokenAuthenticator').then((processorId) => {
      // Configure processor
      cy.configureProcessor(processorId, { 
        properties: { 'JWKS Type': 'Server' } 
      });

      // Generate and test token
      cy.generateToken().then((token) => {
        cy.verifyTokenValidation(processorId, token);
      });
    });
  });
});
----

== Troubleshooting

=== Common Issues

. *Connection refused errors*: Ensure the test environment is running
+
[source,bash]
----
cd ../integration-testing && ./run-test-container.sh
----

. *Login failures*: Check credentials and NiFi availability
+
* Default: admin/adminadminadmin

. *Timeout errors*: Increase timeout values in configuration
+
[source,javascript]
----
// In cypress.config.js
defaultCommandTimeout: 10000
----

. *SSL errors*: Verify certificate configuration in test environment

=== Debug Mode

Run with debug output:

[source,bash]
----
DEBUG=cypress:* npm run cypress:run
----

=== Check Setup

Use the verification script to diagnose issues:

[source,bash]
----
./verify-setup.sh
----

== Test Reports

Test reports are generated in the `tests-report/` directory:

* *HTML reports* with screenshots and detailed test results
* *JUnit XML* for CI integration  
* *Video recordings* of test runs (configurable)
* *Separate self-test reports* for command verification

== CI/CD Integration

The module is designed for CI/CD pipelines:

* ✅ Self-tests run before main tests to ensure command reliability
* ✅ Proper error handling and reporting
* ✅ Artifact collection for failed tests
* ✅ Configurable through environment variables
* 🔄 GitHub Actions workflow (Phase 4 - optional)

=== CI Environment Setup

For CI environments, ensure:

. Test environment is started before test execution
. Environment variables are properly set
. Sufficient timeouts for slower CI environments
. Proper artifact collection for debugging

== Performance

=== Test Execution Times

* *Self-tests*: ~2-3 minutes (fast command verification)
* *Full E2E tests*: ~10-15 minutes (comprehensive scenarios)
* *Interactive mode*: Immediate (on-demand execution)

=== Optimization Tips

. Use `cy.visit()` sparingly - prefer navigation commands
. Clear state between tests using `beforeEach()`
. Use fixtures for test data instead of generating on-the-fly
. Run self-tests first to catch command issues early

== Contributing

When adding new functionality:

. *Create custom commands* for reusable operations
. *Add self-tests* for any new commands
. *Follow ESLint rules* and run `npm run lint:fix`
. *Update documentation* for new commands or features
. *Test thoroughly* with both `npm run cypress:open` and `npm run cypress:run`

== Architecture

The module follows these design principles:

* *Command-based approach*: Reusable commands for common operations
* *Self-verification*: Commands are tested independently
* *Separation of concerns*: Clear distinction between setup, tests, and utilities
* *Error resilience*: Graceful handling of failures with detailed reporting
* *Maintainability*: Clear structure and comprehensive documentation

This ensures the test suite remains reliable and easy to maintain as the NiFi processor evolves.
