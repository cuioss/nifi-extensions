@startuml
!pragma layout smetana
package "NiFi Framework" {
  [NiFi Core] as NiFiCore
  [Processor API] as ProcessorAPI
  [Controller Service API] as CSAPI
}

package "nifi-cuioss-api" {
  [JwtIssuerConfigService\n(CS Interface)] as CSInterface
  [JwtAuthenticationConfig] as AuthConfig
}

package "nifi-cuioss-common" {
  [StandardJwtIssuerConfig\nService (CS Impl)] as CSImpl
  [AuthorizationValidator] as AuthzValidator
  [TokenClaimMapper] as ClaimMapper
  [ErrorContext] as ErrorContext
}

package "nifi-cuioss-processors" {
  [MultiIssuerJWTToken\nAuthenticator] as MultiIssuer
}

package "nifi-cuioss-rest-processors" {
  [RestApiGateway\nProcessor] as Gateway
  [GatewayRequestHandler] as ReqHandler
  [ManagementEndpoint\nHandler] as MgmtHandler
  [JettyServerManager] as JettyMgr
}

package "nifi-cuioss-ui" {
  [Unified Custom UI] as UI
}

package "OAuth-Sheriff" {
  [TokenValidator] as TokenValidator
  [AccessTokenContent] as TokenContent
}

package "Embedded Jetty 12" {
  [Jetty Server] as Jetty
}

package "External Services" {
  [Identity Provider 1] as IDP1
  [Identity Provider 2] as IDP2
}

NiFiCore --> ProcessorAPI : uses
NiFiCore --> CSAPI : uses
ProcessorAPI --> MultiIssuer : extends
ProcessorAPI --> Gateway : extends
CSAPI --> CSInterface : defines

CSImpl ..|> CSInterface : implements
CSImpl --> TokenValidator : creates
CSImpl --> AuthConfig : produces

MultiIssuer --> CSInterface : references CS
Gateway --> CSInterface : references CS
Gateway --> ReqHandler : delegates requests
Gateway --> JettyMgr : manages server
JettyMgr --> Jetty : starts/stops

ReqHandler --> AuthzValidator : authorizes
ReqHandler --> MgmtHandler : /metrics endpoint
ReqHandler --> ClaimMapper : maps token claims

TokenValidator --> TokenContent : returns result
TokenValidator --> IDP1 : retrieves JWKS
TokenValidator --> IDP2 : retrieves JWKS

UI --> MultiIssuer : configures
UI --> Gateway : configures
@enduml
