@startuml component-interaction
!pragma layout smetana

skinparam componentStyle rectangle
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName "Arial"
skinparam ArrowColor black
skinparam ArrowThickness 1.5

title "Component Interaction Diagram - NiFi Extensions"

cloud "External Services" {
  [Identity Provider] as IDP
}

actor "API Client" as APIClient

package "Apache NiFi" {
  [NiFi Core] as NiFiCore

  package "nifi-cuioss-api" {
    [JwtIssuerConfigService\n(CS Interface)] as CSInterface
  }

  package "nifi-cuioss-common" {
    [StandardJwtIssuer\nConfigService] as CSImpl
    [AuthorizationValidator] as AuthzValidator
    [IssuerConfigurationParser] as ConfigParser
    [ErrorContext] as ErrorContext
  }

  package "nifi-cuioss-processors" {
    [MultiIssuerJWTToken\nAuthenticator] as MultiIssuer
  }

  package "nifi-cuioss-rest-processors" {
    [RestApiGateway\nProcessor] as Gateway
    [GatewayRequestHandler] as ReqHandler
    [ManagementEndpoint\nHandler] as MgmtHandler
  }

  package "nifi-cuioss-ui" {
    [Unified Custom UI] as UI
  }
}

package "OAuth-Sheriff" {
  [TokenValidator] as TokenValidator
}

NiFiCore ..> CSInterface : uses
CSImpl ..|> CSInterface : implements
CSImpl --> ConfigParser : parses issuer configs
CSImpl --> TokenValidator : creates and manages

MultiIssuer --> CSInterface : validates tokens via CS
Gateway --> CSInterface : validates tokens via CS
Gateway --> ReqHandler : handles HTTP requests
ReqHandler --> AuthzValidator : checks roles/scopes
ReqHandler --> MgmtHandler : /metrics endpoint

TokenValidator --> IDP : retrieves JWKS keys
APIClient --> Gateway : HTTP requests (embedded Jetty)

UI ..> MultiIssuer : configures (JWT tabs)
UI ..> Gateway : configures (gateway tabs)

note right of MultiIssuer: JWT validation from\nFlowFile attributes
note right of Gateway: Self-contained REST gateway\nwith embedded Jetty server
note bottom of CSImpl: Shared Controller Service\nused by both processors
@enduml
