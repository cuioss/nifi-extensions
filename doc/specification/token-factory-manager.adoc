= Token Validation with cui-jwt-validation
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

link:../Specification.adoc[Back to Main Specification]

== Overview
_See Requirement link:../Requirements.adoc#NIFI-AUTH-3[NIFI-AUTH-3: Token Validation Requirements]_

This document describes how the MultiIssuerJWTTokenAuthenticator processor uses the https://github.com/cuioss/cui-jwt-validation[cui-jwt-validation] library to validate JWT tokens. The cui-jwt-validation library provides a robust implementation for JWT token validation with support for multiple issuers, JWKS endpoints, and caching.

== cui-jwt-validation Library

The cui-jwt-validation library is a Java library that provides a comprehensive solution for JWT token validation. It supports:

* Multiple token issuers
* JWKS (JSON Web Key Set) endpoint integration
* Automatic key rotation
* Token signature validation
* Token claims validation
* Caching of validation results
* Support for various signing algorithms

For more details, see the https://github.com/cuioss/cui-jwt-validation[cui-jwt-validation GitHub repository].

== Integration with NiFi

=== Maven Dependency

To use the cui-jwt-validation library in the NiFi processor, add the following dependency to the pom.xml file:

[source,xml]
----
<dependency>
    <groupId>de.cuioss</groupId>
    <artifactId>cui-jwt-validation</artifactId>
    <version>${version.cui-jwt-validation}</version>
</dependency>
----

=== TokenValidator Usage

The cui-jwt-validation library provides a `TokenValidator` class that is responsible for creating and validating JWT tokens. The `TokenValidator` is configured with one or more `IssuerConfig` instances, each representing a trusted token issuer.

[source,java]
----
// Create a config for each issuer
IssuerConfig issuerConfig = IssuerConfig.builder()
    .jwksIssuer("https://auth.example.com")
    .jwksEndpoint("https://auth.example.com/.well-known/jwks.json")
    .jwksRefreshIntervall(3600) // Refresh keys every hour
    .build();

// Create the TokenValidator with the issuer config
TokenValidator tokenValidator = new TokenValidator(issuerConfig);

// Validate a token
Optional<AccessTokenContent> token = tokenValidator.createAccessToken(tokenString);
----

=== Processor Implementation

The MultiIssuerJWTTokenAuthenticator processor uses the cui-jwt-validation library to validate JWT tokens. The processor initializes a `TokenValidator` with the configured issuers and uses it to validate tokens.

[source,java]
----
/**
 * Processor implementation for JWT token validation using cui-jwt-validation.
 */
public class MultiIssuerJWTTokenAuthenticator extends AbstractProcessor {

    private static final CuiLogger LOGGER = new CuiLogger(MultiIssuerJWTTokenAuthenticator.class);

    // TokenValidator instance for validating tokens
    private volatile TokenValidator tokenValidator;

    // Lock for thread-safe initialization
    private final Object lock = new Object();

    /**
     * Gets or initializes the TokenValidator.
     * 
     * @return The TokenValidator instance
     */
    private TokenValidator getTokenValidator() {
        if (tokenValidator == null) {
            synchronized (lock) {
                if (tokenValidator == null) {
                    tokenValidator = initializeTokenValidator();
                }
            }
        }
        return tokenValidator;
    }

    /**
     * Initializes the TokenValidator with configured issuers.
     * 
     * @return A new TokenValidator instance
     */
    private TokenValidator initializeTokenValidator() {
        List<IssuerConfig> issuers = new ArrayList<>();

        // Get dynamic properties for issuers
        Map<PropertyDescriptor, String> properties = getProperties();
        for (Map.Entry<PropertyDescriptor, String> entry : properties.entrySet()) {
            PropertyDescriptor descriptor = entry.getKey();

            // Skip static properties
            if (!descriptor.isDynamic()) {
                continue;
            }

            String issuerName = descriptor.getName();
            String jwksUrl = entry.getValue();

            // Create an issuer config for this issuer using cui-jwt-validation
            IssuerConfig issuerConfig = IssuerConfig.builder()
                .jwksIssuer(issuerName)
                .jwksEndpoint(jwksUrl)
                .jwksRefreshIntervall(getRefreshInterval())
                .build();

            issuers.add(issuerConfig);
            LOGGER.debug("Added issuer config for issuer '%s' with JWKS URL '%s'", 
                issuerName, jwksUrl);
        }

        if (issuers.isEmpty()) {
            throw new ProcessException("No token issuers configured");
        }

        // Create the TokenValidator with all issuers using cui-jwt-validation
        return new TokenValidator(issuers.toArray(new IssuerConfig[0]));
    }

    /**
     * Called when a processor property is modified.
     * Resets the TokenValidator when relevant properties change.
     */
    @Override
    public void onPropertyModified(PropertyDescriptor descriptor, String oldValue, String newValue) {
        // Reset TokenValidator when properties change
        if (descriptor.isDynamic() || JWKS_REFRESH_INTERVAL.equals(descriptor)) {
            // Reset the TokenValidator to force reinitialization
            synchronized (lock) {
                tokenValidator = null;
            }
            LOGGER.debug("Reset TokenValidator due to property change: %s", descriptor.getName());
        }
    }
}
----

== Benefits of Using cui-jwt-validation

Using the cui-jwt-validation library provides several benefits:

1. **Robust Implementation**: The library provides a well-tested implementation for JWT token validation.
2. **Multiple Issuer Support**: The library supports multiple token issuers, allowing the processor to validate tokens from different authentication servers.
3. **JWKS Integration**: The library integrates with JWKS endpoints, automatically retrieving and caching public keys for token validation.
4. **Key Rotation**: The library supports automatic key rotation, ensuring that the processor always uses the latest keys for token validation.
5. **Caching**: The library caches validation results, improving performance for repeated token validations.
6. **Comprehensive Validation**: The library validates token structure, signature, expiration, and other claims.

== Conclusion

The cui-jwt-validation library provides a robust and feature-rich solution for JWT token validation in the MultiIssuerJWTTokenAuthenticator processor. By leveraging this library, the processor can validate tokens from multiple issuers with minimal code and maximum reliability.

== See Also
* link:token-validation.adoc[Token Validation] - Details on the token validation process
* link:configuration.adoc[Configuration] - Configuration properties and UI elements
* link:technical-components.adoc[Technical Components] - Core implementation details
* link:../Specification.adoc[Back to Main Specification]

link:token-validation.adoc[Back to Token Validation]
