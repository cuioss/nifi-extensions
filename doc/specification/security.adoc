= MultiIssuerJWTTokenAuthenticator Security Specification
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:imagesdir: ../plantuml

link:../Specification.adoc[Back to Main Specification]

== Security Overview
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-8[NIFI-AUTH-8: Security Requirements]_

== Implementation Status

=== Implementation Classes
* link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/servlets/JwksValidationServlet.java[JwksValidationServlet] -- JWKS URL/file/content validation with SSRF and path traversal protection
* link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/util/ProcessorConfigReader.java[ProcessorConfigReader] -- Secure processor configuration retrieval via NiFi REST API
* link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/servlets/SecurityHeadersFilter.java[SecurityHeadersFilter] -- Defense-in-depth security response headers
* link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/servlets/ProcessorIdValidationFilter.java[ProcessorIdValidationFilter] -- Processor ID validation for API endpoints
* link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/util/TokenMasking.java[TokenMasking] -- Sensitive token masking for log output

=== Verification
* link:../../nifi-cuioss-ui/src/test/java/de/cuioss/nifi/ui/servlets/JwksValidationServletTest.java[JwksValidationServletTest]
* link:../../nifi-cuioss-ui/src/test/java/de/cuioss/nifi/ui/util/ProcessorConfigReaderTest.java[ProcessorConfigReaderTest]
* link:../../nifi-cuioss-ui/src/test/java/de/cuioss/nifi/ui/servlets/SecurityHeadersFilterTest.java[SecurityHeadersFilterTest]
* link:../../nifi-cuioss-ui/src/test/java/de/cuioss/nifi/ui/servlets/ProcessorIdValidationFilterTest.java[ProcessorIdValidationFilterTest]
* link:../../nifi-cuioss-ui/src/test/java/de/cuioss/nifi/ui/util/TokenMaskingTest.java[TokenMaskingTest]

== Token Validation Security
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-8[NIFI-AUTH-8: Security Requirements]_

=== JWT Validation Best Practices

The processor implements these JWT validation security best practices:

1. **Signature Verification**: All tokens are validated against trusted issuer keys
2. **Expiration Checking**: Expired tokens are rejected
3. **Issuer Verification**: Only configured issuers are accepted
4. **Audience Validation**: Tokens must include the expected audience claim
5. **Key Rotation Support**: Automated JWKS key rotation
6. **Algorithm Restrictions**: Only secure algorithms are allowed

=== Algorithm Restrictions

The processor restricts token algorithms to those considered secure:

[cols="1,3"]
|===
|Algorithm |Security Status

|RS256, RS384, RS512
|Secure - RSA with SHA-2

|ES256, ES384, ES512
|Secure - ECDSA with SHA-2

|PS256, PS384, PS512
|Secure - RSA PSS with SHA-2

|HS256, HS384, HS512
|**Not recommended** - Requires shared secret

|none
|**Blocked** - "none" algorithm is never allowed
|===

For more details on token validation implementation, see link:token-validation.adoc[Token Validation].

== JWKS Endpoint Security
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-8[NIFI-AUTH-8: Security Requirements]_

The processor implements these JWKS endpoint security measures:

1. **HTTPS Enforcement**: Production environments should use HTTPS for JWKS endpoints
2. **Certificate Validation**: TLS certificates are validated by default
3. **Key Caching**: Keys are cached to prevent DoS attacks
4. **Timeout Handling**: HTTP connections have reasonable timeouts
5. **Response Validation**: JWKS responses are validated before use

=== JWKS HTTP Client Configuration

The processor's HTTP client for JWKS endpoints uses the `cui-http` library's `HttpHandler` for secure communication with built-in timeouts and URL validation. See link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/servlets/JwksValidationServlet.java[JwksValidationServlet] for the implementation.

For more details on JWKS configuration, see link:configuration.adoc[Configuration].

== Custom UI Endpoint Security

The processor's Custom UI is deployed as a WAR file within NiFi's web container and is accessed via an iframe within the authenticated NiFi session.

=== Exposed Endpoints

The Custom UI exposes these administration endpoints:

[cols="2,3"]
|===
|Endpoint |Purpose

|`/nifi-api/processors/jwt/verify-token`
|JWT token verification

|`/nifi-api/processors/jwt/validate-jwks-url`
|JWKS URL validation

|`/nifi-api/processors/jwt/validate-jwks-file`
|JWKS file validation

|`/nifi-api/processors/jwt/validate-jwks-content`
|JWKS content validation

|`/nifi-api/processors/jwt/metrics`
|Validation metrics
|===

=== Security Model

The endpoints are protected through multiple layers:

1. **NiFi Session Authentication**: The Custom UI runs inside NiFi's web container as an iframe within an authenticated NiFi session. Unauthenticated users cannot reach the Custom UI at all.
2. **Processor ID Validation**: The `ProcessorIdValidationFilter` requires an `X-Processor-Id` header on every request. This is a UUID passed to the iframe via URL parameter (`?id=<uuid>`), only available to authenticated NiFi users.
3. **Security Response Headers**: The `SecurityHeadersFilter` adds defense-in-depth headers (`X-Content-Type-Options`, `X-Frame-Options: SAMEORIGIN`, `Referrer-Policy`) to all responses.
4. **Full Signature Verification**: All token verification uses the processor's real configuration with full cryptographic signature verification. No test or bypass modes exist.

=== JWKS File Path Protection

JWKS file validation uses a two-layer defense against path traversal:

1. **Security Pipeline Validation**: The `cui-http` library's `PipelineFactory.createUrlPathPipeline()` detects path traversal patterns including `../`, URL-encoded variants, and Unicode normalization attacks.
2. **Base Directory Restriction**: File access is restricted to the NiFi configuration directory (resolved from `nifi.properties.file.path` or configurable via `nifi.jwks.allowed.base.path`).

=== JWKS URL Protection

JWKS URL validation uses the `cui-http` library's `HttpHandler` for secure HTTP communication with built-in timeouts and URL structure validation via `PipelineFactory.createUrlPathPipeline()`.

==== SSRF Protection

By default, JWKS URLs that resolve to private, loopback, link-local, or any-local addresses are blocked to prevent Server-Side Request Forgery (SSRF) attacks. This protection can be disabled when the Identity Provider (IdP) runs on an internal network.

[cols="1,3"]
|===
|Property |Description

|`jwt.validation.jwks.allow.private.network.addresses`
|When set to `true` on the `StandardJwtIssuerConfigService` controller service, allows JWKS URLs that resolve to private/loopback network addresses. Default: `false`.
|===

**Use case:** Enterprise deployments where Keycloak or another IdP runs on a site-local address (e.g., `10.x.x.x`, `172.16.x.x`, `192.168.x.x`).

WARNING: Only enable this setting in trusted network environments where the NiFi instance and IdP are on the same private network. Disabling SSRF protection in untrusted environments exposes the system to internal network scanning attacks.

=== Design Decisions

* No test or E2E bypass endpoints exist in production deployments
* `X-Frame-Options` is set to `SAMEORIGIN` (not `DENY`) because the Custom UI runs inside an iframe within NiFi
* Token logging uses masking (first 8 characters only) to prevent sensitive data exposure

== Multi-Issuer Security
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-8[NIFI-AUTH-8: Security Requirements]_

The multi-issuer support introduces additional security considerations:

1. **Issuer Isolation**: Each issuer is validated independently
2. **Key Separation**: Each issuer has its own key set
3. **Dynamic Configuration**: Issuers can be enabled/disabled without redeployment
4. **Per-Issuer Audience**: Each issuer can have specific audience requirements

=== Issuer Security Configuration

Each issuer can have specific security settings:

[source,properties]
----
# Production issuer with strict settings
auth server production = https://auth.example.com/.well-known/jwks.json
auth server production.audience = api://my-service-prod

# Development issuer with relaxed settings (disabled in production)
auth server development = https://auth-dev.example.com/.well-known/jwks.json
auth server development.enabled = false
----

For more details on multi-issuer implementation, see link:technical-components.adoc[Technical Components].

== Runtime Security
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-8[NIFI-AUTH-8: Security Requirements]_

=== Resource Protection

The processor implements resource protection measures:

1. **Memory Usage Limits**: Token size limits prevent memory exhaustion attacks
2. **CPU Protection**: Parsing complexity is limited to prevent CPU attacks
3. **Caching Optimization**: Effective caching reduces resource usage
4. **Error Rate Limiting**: Failed validation attempts are tracked

=== Memory Usage Considerations

The processor protects against memory-related attacks:

[source,properties]
----
# Limit token size to prevent memory exhaustion
Maximum Token Size=16384
----

For more details on performance and resource considerations, see link:configuration.adoc[Configuration].

== Security Event Monitoring
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-10[NIFI-AUTH-10: Error Handling Requirements]_

The processor tracks security events for monitoring and alerting:

1. **Invalid Token Count**: Tracks tokens with invalid signatures
2. **Expired Token Count**: Tracks expired tokens separately
3. **Malformed Token Count**: Tracks unparseable tokens
4. **Unauthorized Access Attempts**: Tracks authorization failures

For details on security event monitoring implementation, see xref:token-validation.adoc#_security_event_monitoring[Security Event Monitoring].

== Security Recommendations

=== Deployment Recommendations

1. **Use HTTPS for JWKS Endpoints**: Always use HTTPS for JWKS endpoints in production
2. **Regular Key Rotation**: Configure appropriate key rotation intervals
3. **Specific Audience Claims**: Use specific audience claims rather than generic ones
4. **Limit Token Size**: Set appropriate maximum token size
5. **Monitor Security Events**: Track validation failures for security insights

=== Configuration Best Practices

1. **Disable Unused Issuers**: Disable any issuers not needed in production
2. **Require Valid Token**: Set "Require Valid Token" to true in production
3. **Use Specific Scopes**: Configure required scopes for authorization
4. **Set Up Role-Based Access**: Use roles for fine-grained authorization

For more details on configuration, see link:configuration.adoc[Configuration].

== Testing Security
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-14[NIFI-AUTH-14: Unit Testing]_

The processor's security features are tested through:

1. **Unit Tests**: Verify security validations function correctly
2. **Integration Tests**: Test with real token issuers
3. **Security Tests**: Specifically test security edge cases
4. **Performance Tests**: Verify resource protection

For more details on security testing, see link:testing.adoc[Testing].

== See Also

=== Core Documentation
* link:../Specification.adoc[Main Specification]
* link:../Requirements.adoc[Requirements]
* link:../Requirements.adoc#NIFI-AUTH-8[Security Requirements]

=== Related Implementation
* link:authentication-architecture.adoc[Authentication Architecture] -- End-to-end authentication matrix across all service layers
* link:token-validation.adoc[Token Validation]
* link:configuration.adoc[Configuration]
* link:error-handling.adoc[Error Handling]
* link:technical-components.adoc[Technical Components]
