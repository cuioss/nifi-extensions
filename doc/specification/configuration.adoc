= NiFi Extensions Configuration Reference
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js
:imagesdir: ../plantuml

xref:../Specification.adoc[Back to Main Specification]

== Overview
_See Requirement xref:../Requirements.adoc#NIFI-AUTH-7[NIFI-AUTH-7: Configuration Requirements]_

The NiFi Extensions project provides two processors that share JWT validation through a common Controller Service:

* **MultiIssuerJWTTokenAuthenticator** -- validates JWT tokens from FlowFile attributes
* **RestApiGatewayProcessor** -- self-contained REST API gateway with embedded HTTP server

This document serves as the central reference for all configuration options.

[.text-center]
image::../plantuml/configuration-overview.png[Configuration Overview Diagram, align="center"]

== Implementation Status

=== Implementation Classes
* link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/JWTProcessorConstants.java[JWTProcessorConstants] -- JWT processor property definitions and relationships
* link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/RestApiGatewayConstants.java[RestApiGatewayConstants] -- Gateway processor property definitions
* link:../../nifi-cuioss-api/src/main/java/de/cuioss/nifi/jwt/config/JwtIssuerConfigService.java[JwtIssuerConfigService] -- Controller Service interface for JWT issuer configuration (in `nifi-cuioss-api` module)
* link:../../nifi-cuioss-common/src/main/java/de/cuioss/nifi/jwt/config/StandardJwtIssuerConfigService.java[StandardJwtIssuerConfigService] -- Controller Service implementation
* link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] -- JWT processor
* link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/RestApiGatewayProcessor.java[RestApiGatewayProcessor] -- Gateway processor

=== Verification
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorTest.java[MultiIssuerJWTTokenAuthenticatorTest]

=== Configuration Architecture

Configuration is split between processors and a shared Controller Service (CS):

* **JwtIssuerConfigService CS** -- issuer configuration, JWKS settings, token validation, and performance tuning (shared by both processors)
* **MultiIssuerJWTTokenAuthenticator** -- token reading, authorization requirements, and CS reference
* **RestApiGatewayProcessor** -- HTTP server settings, route configuration, CORS, management endpoints, and CS reference

The CS supports three configuration methods:

1. **UI Configuration** - Interactive configuration through the NiFi Web UI
2. **Static Configuration Files** - Configuration through properties or YAML files
3. **Environment Variables** - Configuration through environment variables for containerized environments

== MultiIssuerJWTTokenAuthenticator Properties

=== Core Properties
_See Requirement xref:../Requirements.adoc#NIFI-AUTH-7.2[NIFI-AUTH-7.2: Token Validation Configuration]_

[cols="1,1,3,1"]
|===
|Property |Default |Description |Required

|jwt.issuer.config.service
|--
|Reference to the JwtIssuerConfigService Controller Service that provides JWT issuer configuration and token validation
|Yes

|jwt.validation.token.attribute
|jwt.token
|The FlowFile attribute name containing the raw JWT token
|Yes

|jwt.validation.require.valid.token
|true
|Whether to require a valid token for processing. When false, FlowFiles without a token are routed to success.
|Yes
|===

=== Authorization Properties
_See Requirement xref:../Requirements.adoc#NIFI-AUTH-7.4[NIFI-AUTH-7.4: Authorization Configuration]_

Authorization is configured at the processor level:

[cols="1,1,3,1"]
|===
|Property |Default |Description |Required

|jwt.validation.required.roles
|--
|Comma-separated list of roles required for authorization
|No

|jwt.validation.required.scopes
|--
|Comma-separated list of scopes required for authorization
|No
|===

== RestApiGateway Processor Properties

=== Static Properties

[cols="1,1,3,1"]
|===
|Property |Default |Description |Required

|rest.gateway.listening.port
|9443
|TCP port for the embedded Jetty HTTP server
|Yes

|rest.gateway.listening.host
|0.0.0.0
|Bind address for the embedded server
|No

|rest.gateway.jwt.config.service
|--
|Reference to the JwtIssuerConfigService Controller Service
|Yes

|rest.gateway.ssl.context.service
|--
|Reference to an SSLContextProvider for HTTPS
|No

|rest.gateway.max.request.size
|1048576
|Maximum request body size in bytes (default 1 MB)
|Yes

|rest.gateway.request.queue.size
|50
|Maximum number of requests queued for FlowFile processing. Acts as back-pressure when the NiFi flow cannot keep up.
|Yes

|rest.gateway.cors.allowed.origins
|--
|Comma-separated list of allowed CORS origins. When set, CORS headers are added to responses and preflight OPTIONS requests are handled automatically.
|No

|rest.gateway.management.api-key
|--
|API key required for accessing the `/metrics` management endpoint. When not set, the endpoint is accessible without authentication. **Sensitive property.**
|No
|===

=== Route Configuration via Dynamic Properties

Routes are configured using NiFi dynamic properties with the `restapi.` prefix. Each route is a named group of properties:

[cols="1,3,1"]
|===
|Property Pattern |Description |Example

|restapi.<name>.path
|URL path for the route (exact match)
|/api/users

|restapi.<name>.methods
|Comma-separated HTTP methods (default: GET,POST,PUT,DELETE)
|GET,POST

|restapi.<name>.required-roles
|Comma-separated roles the JWT must carry
|admin,editor

|restapi.<name>.required-scopes
|Comma-separated scopes the JWT must carry
|read,write

|restapi.<name>.success-outcome
|NiFi relationship name for this route; auto-populated with route name when absent
|api-data

|restapi.<name>.create-flowfile
|Whether to create a FlowFile for this route (default: true). Routes with `false` have no NiFi relationship.
|false
|===

Each configured route with `create-flowfile=true` creates a NiFi relationship named by its `success-outcome` property.

==== Multi-Route Configuration Example

[source,properties]
----
# Route 1: User API (read-only)
restapi.users.path = /api/users
restapi.users.methods = GET
restapi.users.required-roles = read
restapi.users.success-outcome = users

# Route 2: Admin API (full access)
restapi.admin.path = /api/admin
restapi.admin.methods = GET,POST,PUT,DELETE
restapi.admin.required-roles = admin
restapi.admin.success-outcome = admin

# Route 3: Public health check (no authorization)
restapi.health.path = /api/health
restapi.health.methods = GET
restapi.health.success-outcome = health
----

This creates three relationships (`users`, `admin`, `health`) plus the static `failure` relationship.
The `success-outcome` property is auto-populated with the route name when absent.

== Controller Service Properties

The `JwtIssuerConfigService` manages issuer configuration and token validation settings. Both processors reference the same CS instance.

=== Performance Properties
_See Requirement xref:../Requirements.adoc#NIFI-AUTH-9[NIFI-AUTH-9: Performance Requirements]_

[cols="1,1,3,1"]
|===
|Property |Default |Description |Required

|jwt.validation.jwks.refresh.interval
|3600
|Interval in seconds for refreshing JWKS keys
|Yes

|jwt.validation.jwks.connection.timeout
|10
|Seconds before a JWKS endpoint request times out
|Yes

|jwt.validation.maximum.token.size
|16384
|Maximum token size in bytes
|Yes

|jwt.validation.allowed.algorithms
|Secure defaults
|Comma-separated list of permitted signing algorithms (RS256, RS384, RS512, ES256, ES384, ES512, PS256, PS384, PS512). The `none` algorithm and weak HMAC algorithms are always blocked.
|No

|jwt.validation.require.https.for.jwks
|true
|Enforces HTTPS for JWKS endpoint URLs. Disable only for development.
|Yes

|jwt.validation.jwks.allow.private.network.addresses
|false
|Whether to allow JWKS URLs pointing to private network addresses. Enable only for development.
|Yes
|===

=== Dynamic Properties (Issuers)
_See Requirement xref:../Requirements.adoc#NIFI-AUTH-4[NIFI-AUTH-4: Multiple Issuer Support]_

The Controller Service supports multiple issuers through NiFi dynamic properties. Issuer properties use the prefix `issuer.<N>.<property>`:

[cols="1,3,1"]
|===
|Property |Description |Example

|issuer.<N>.jwks-url
|The JWKS URL or public key for the issuer
|https://auth.example.com/.well-known/jwks.json

|issuer.<N>.enabled
|Whether this issuer is enabled (true/false)
|true

|issuer.<N>.audience
|Required audience for this specific issuer
|api://my-service
|===

NOTE: In static configuration files, the prefix is `jwt.validation.issuer.<N>.<property>` (see xref:configuration-static.adoc[Static Configuration]).

== Configuration Methods

=== UI Configuration

Both processors provide a comprehensive user interface for configuration through the NiFi Web UI. The unified Custom UI detects the processor type and shows appropriate tabs:

* **JWT processor tabs**: Issuer Configuration, Token Verification, Metrics
* **Gateway processor tabs**: Endpoint Configuration, Endpoint Tester, Metrics

For detailed information about UI configuration, see xref:configuration-ui.adoc[UI Configuration].

=== Static Configuration Files

For containerized environments and automated deployments, the Controller Service supports configuration through external files in multiple formats:

* Properties (.properties)
* YAML (.yaml, .yml)

Static configuration files can be placed in standard locations or specified through system properties and environment variables.

For detailed information about static file configuration, see xref:configuration-static.adoc[Static Configuration].

=== Environment Variables

For container environments, configuration can also be provided through environment variables, making it suitable for Kubernetes, Docker, and other container orchestration platforms.

The configuration precedence order is:
1. Static configuration files
2. Environment variables
3. UI configuration

For detailed information about environment variable configuration, see xref:configuration-static.adoc#environment-variable-configuration[Environment Variable Configuration].

== Common Configuration Scenarios

=== Basic JWT Processor with Single Issuer

[source,properties]
----
# Controller Service properties
jwt.validation.require.valid.token = true
jwt.validation.jwks.refresh.interval = 3600

# Issuer configuration (on CS)
jwt.validation.issuer.1.jwks-url = https://auth-server.example.com/.well-known/jwks.json
jwt.validation.issuer.1.audience = api://my-service
----

=== RestApiGateway with Multiple Routes

[source,properties]
----
# Gateway processor properties
rest.gateway.listening.port = 9443
rest.gateway.cors.allowed.origins = https://app.example.com
rest.gateway.management.api-key = <secret>

# Route configuration (on processor as dynamic properties)
restapi.users.path = /api/users
restapi.users.methods = GET,POST
restapi.users.required-roles = user

restapi.admin.path = /api/admin
restapi.admin.methods = GET,POST,PUT,DELETE
restapi.admin.required-roles = admin
restapi.admin.required-scopes = admin:write
----

=== Multiple Issuers (Shared CS)

[source,properties]
----
# Controller Service properties
jwt.validation.require.valid.token = true
jwt.validation.jwks.refresh.interval = 1800

# Issuer configuration (on CS)
jwt.validation.issuer.1.jwks-url = https://auth.example.com/.well-known/jwks.json
jwt.validation.issuer.1.audience = api://my-service-prod

jwt.validation.issuer.2.jwks-url = https://auth-test.example.com/.well-known/jwks.json
jwt.validation.issuer.2.audience = api://my-service-test
jwt.validation.issuer.2.enabled = false  # Disabled in production
----

== See Also

=== Core Documentation
* xref:../Specification.adoc[Main Specification]
* xref:../Requirements.adoc[Requirements]

=== Configuration Details
* xref:configuration-ui.adoc[UI Configuration]
* xref:configuration-static.adoc[Static Configuration]

=== Related Implementation
* xref:token-validation.adoc[Token Validation]
* xref:technical-components.adoc[Technical Components]
* xref:error-handling.adoc[Error Handling]
