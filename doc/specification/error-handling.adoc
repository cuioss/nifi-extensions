= NiFi Extensions Error Handling
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:imagesdir: ../plantuml

link:../Specification.adoc[Back to Main Specification]

== Error Handling Overview
_See Requirement link:../Requirements.adoc#NIFI-AUTH-10[NIFI-AUTH-10: Error Handling Requirements]_

The NiFi Extensions project implements comprehensive error handling across both processors:

* **MultiIssuerJWTTokenAuthenticator** -- routes failed FlowFiles to the `authentication-failed` relationship with error attributes
* **RestApiGatewayProcessor** -- returns RFC 9457 `application/problem+json` error responses directly to HTTP clients

== Implementation Status

=== Implementation Classes
* link:../../nifi-cuioss-common/src/main/java/de/cuioss/nifi/jwt/util/ErrorContext.java[ErrorContext] -- Structured error context with component, operation, and error code
* link:../../nifi-cuioss-common/src/main/java/de/cuioss/nifi/jwt/util/ProcessingError.java[ProcessingError] -- Value object for flow file processing failures
* link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/AuthLogMessages.java[AuthLogMessages] -- Standardized log messages with AUTH prefix
* link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/ProblemDetail.java[ProblemDetail] -- RFC 9457 error response format for the REST API gateway
* link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/GatewaySecurityEvents.java[GatewaySecurityEvents] -- Application-level security event counters

=== Verification
* link:../../nifi-cuioss-common/src/test/java/de/cuioss/nifi/jwt/util/ErrorContextTest.java[ErrorContextTest]

== JWT Processor Error Handling
_See Requirement link:../Requirements.adoc#NIFI-AUTH-10[NIFI-AUTH-10: Error Handling Requirements]_

The MultiIssuerJWTTokenAuthenticator implements error handling using the oauth-sheriff-core library to detect and report validation issues. Error handling has been enhanced with the `ErrorContext` utility class to provide structured, contextual error information.

=== ErrorContext Utility

The `ErrorContext` utility class provides enhanced error reporting with:

* **Component Identification**: Identifies which component generated the error
* **Operation Context**: Specifies what operation was being performed
* **Error Categorization**: Uses standardized error codes for classification
* **Contextual Information**: Includes relevant debugging data
* **Exception Chain Analysis**: Tracks root causes through exception chains

See link:../../nifi-cuioss-common/src/main/java/de/cuioss/nifi/jwt/util/ErrorContext.java[ErrorContext] for the builder API and usage patterns.

=== Standardized Error Codes

The `ErrorContext` class defines standardized error codes for consistent categorization:

[cols="2,3"]
|===
|Error Code |Description

|CONFIGURATION_ERROR
|Issues with processor or issuer configuration

|VALIDATION_ERROR
|Token validation failures (format, size, etc.)

|PROCESSING_ERROR
|General processing errors

|SECURITY_ERROR
|Security-related failures

|IO_ERROR
|File or network I/O errors

|AUTHENTICATION_ERROR
|Authentication failures

|AUTHORIZATION_ERROR
|Authorization failures

|TOKEN_ERROR
|Token-specific errors (malformed, expired)

|NETWORK_ERROR
|Network connectivity issues

|RESOURCE_ERROR
|Resource availability issues
|===

=== Error Categories

The processor categorizes errors into the following categories:

[cols="1,3"]
|===
|Category |Description

|Token Format Errors
|Errors related to malformed or unparseable tokens

|Signature Validation Errors
|Errors related to invalid token signatures

|Claims Validation Errors
|Errors related to invalid token claims (expiration, issuer, etc.)

|Authorization Errors
|Errors related to insufficient permissions (scopes, roles)

|JWKS Retrieval Errors
|Errors related to retrieving JWKS from endpoints

|Configuration Errors
|Errors related to processor configuration
|===

=== Error Codes and Messages

For a comprehensive list of error messages, codes, and their explanations, refer to link:../LogMessages.adoc[Log Message Documentation].

== REST API Gateway Error Handling

The RestApiGatewayProcessor returns error responses to HTTP clients using the RFC 9457 Problem Details format (`application/problem+json`). All error responses are generated by the link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/ProblemDetail.java[ProblemDetail] class.

=== RFC 9457 Problem Details Format

Every error response follows this JSON structure:

[source,json]
----
{
  "type": "https://github.com/cuioss/nifi-extensions/blob/main/doc/rest-errors/unauthorized.adoc",
  "title": "Unauthorized",
  "status": 401,
  "detail": "Bearer token validation failed"
}
----

The `type` field links to human-readable error documentation in the link:../rest-errors/index.adoc[REST API Error Reference].

=== Error Types

The gateway returns the following error responses:

[cols="1,1,3"]
|===
|Status |Title |When Returned

|400
|Bad Request
|Input sanitization failed (malformed path, query, or headers)

|401
|Unauthorized
|Missing or invalid Bearer token. Includes `WWW-Authenticate: Bearer` header per RFC 6750. Missing scopes trigger `Bearer error="insufficient_scope"`.

|403
|Forbidden
|Valid token but missing required roles for the matched route.

|404
|Not Found
|No route configured for the requested path.

|405
|Method Not Allowed
|Route exists but the HTTP method is not in the allowed set. Includes `Allow` header listing permitted methods.

|413
|Payload Too Large
|Request body exceeds the configured `rest.gateway.max.request.size` limit.

|422
|Unprocessable Content
|Request body fails JSON Schema validation (when a route specifies `schemaName`).

|500
|Internal Server Error
|Unexpected internal error during request processing.

|503
|Service Unavailable
|Request queue is full (back-pressure). Indicates the NiFi flow cannot keep up with incoming requests.
|===

=== Security Event Tracking

Each error response increments a corresponding counter in link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/GatewaySecurityEvents.java[GatewaySecurityEvents]:

[cols="1,1,2"]
|===
|Event Type |HTTP Status |Description

|MISSING_BEARER_TOKEN
|401
|No Authorization header or malformed Bearer prefix

|AUTH_FAILED
|401
|Token validation failed (expired, bad signature, etc.)

|AUTHZ_ROLE_DENIED
|403
|Valid token but missing required roles

|AUTHZ_SCOPE_DENIED
|401
|Valid token but missing required scopes (step-up authentication)

|BODY_TOO_LARGE
|413
|Request body exceeds configured maximum

|ROUTE_NOT_FOUND
|404
|No route configured for requested path

|METHOD_NOT_ALLOWED
|405
|Route exists but HTTP method not allowed

|QUEUE_FULL
|503
|Request queue at capacity, back-pressure applied
|===

These counters are exposed through the `/metrics` management endpoint. See link:observability.adoc[Observability] for metrics access.

=== CORS Error Handling

When CORS origins are configured, the gateway:

* Handles preflight `OPTIONS` requests with 204 and appropriate `Access-Control-*` headers
* Adds `Access-Control-Allow-Origin` and `Vary: Origin` to all responses (including error responses) when the request origin is allowed
* Adds `Access-Control-Allow-Credentials: true` for non-wildcard origins

=== WWW-Authenticate Header (RFC 6750)

Authentication failures include the `WWW-Authenticate` header per RFC 6750:

* Missing token: `WWW-Authenticate: Bearer`
* Invalid token: `WWW-Authenticate: Bearer error="invalid_token"`
* Insufficient scope: `WWW-Authenticate: Bearer error="insufficient_scope"`

== Integration with OAuth-Sheriff

Both processors leverage the OAuth-Sheriff library's error reporting capabilities, which are mapped to the appropriate error handling mechanism. See link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] and link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/GatewayRequestHandler.java[GatewayRequestHandler] for the validation error handling implementations.

== Security Event Monitoring

Both processors implement security event monitoring as described in xref:observability.adoc[Observability].

== Error Response Design Principles

Error responses are carefully crafted to:

1. Provide actionable information to developers
2. Avoid exposing sensitive information (no token content, no internal stack traces)
3. Include standardized error codes for troubleshooting
4. Use internationalized error messages for consistent user experience (JWT processor)
5. Follow RFC 9457 for machine-readable error responses (REST gateway)
6. Include RFC 6750 authentication challenge headers (REST gateway)

== Testing Error Handling

For details on how error handling is tested, including specific test cases and verification approaches, see link:testing.adoc[Testing Specification].

== See Also

=== Core Documentation
* link:../Specification.adoc[Main Specification]
* link:../Requirements.adoc[Requirements]
* link:../LogMessages.adoc[Log Message Documentation]
* link:../rest-errors/index.adoc[REST API Error Reference]

=== Related Implementation
* link:token-validation.adoc[Token Validation]
* link:security.adoc[Security]
* link:configuration-ui.adoc[UI Configuration]
* link:observability.adoc[Observability]
* link:testing.adoc[Testing]
