= MultiIssuerJWTTokenAuthenticator Error Handling
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:imagesdir: ../plantuml

link:../Specification.adoc[Back to Main Specification]

== Error Handling Overview
_See Requirement link:../Requirements.adoc#NIFI-AUTH-10[NIFI-AUTH-10: Error Handling Requirements]_

== Error Handling Implementation
_See Requirement link:../Requirements.adoc#NIFI-AUTH-10[NIFI-AUTH-10: Error Handling Requirements]_

The MultiIssuerJWTTokenAuthenticator implements comprehensive error handling using the oauth-sheriff-core library to detect and report validation issues in a consistent manner. Error handling has been enhanced with the `ErrorContext` utility class to provide structured, contextual error information.

=== ErrorContext Utility

The `ErrorContext` utility class provides enhanced error reporting with:

* **Component Identification**: Identifies which component generated the error
* **Operation Context**: Specifies what operation was being performed
* **Error Categorization**: Uses standardized error codes for classification
* **Contextual Information**: Includes relevant debugging data
* **Exception Chain Analysis**: Tracks root causes through exception chains

[source,java]
----
// Example usage
String contextMessage = ErrorContext.forComponent("MultiIssuerJWTTokenAuthenticator")
    .operation("validateTokenSize")
    .errorCode(ErrorContext.ErrorCodes.VALIDATION_ERROR)
    .build()
    .with("tokenSize", token.length())
    .with("maxTokenSize", maxTokenSize)
    .with("flowFileUuid", flowFile.getAttribute("uuid"))
    .buildMessage("Token exceeds maximum size limit");

LOGGER.error(contextMessage);
----

=== Standardized Error Codes

The `ErrorContext` class defines standardized error codes for consistent categorization:

[cols="2,3"]
|===
|Error Code |Description

|CONFIGURATION_ERROR
|Issues with processor or issuer configuration

|VALIDATION_ERROR
|Token validation failures (format, size, etc.)

|PROCESSING_ERROR
|General processing errors

|SECURITY_ERROR
|Security-related failures

|IO_ERROR
|File or network I/O errors

|AUTHENTICATION_ERROR
|Authentication failures

|AUTHORIZATION_ERROR
|Authorization failures

|TOKEN_ERROR
|Token-specific errors (malformed, expired)

|NETWORK_ERROR
|Network connectivity issues

|RESOURCE_ERROR
|Resource availability issues
|===

=== Error Categories
_See Requirement link:../Requirements.adoc#NIFI-AUTH-10[NIFI-AUTH-10: Error Handling Requirements]_

The processor categorizes errors into the following categories:

[cols="1,3"]
|===
|Category |Description

|Token Format Errors
|Errors related to malformed or unparseable tokens

|Signature Validation Errors
|Errors related to invalid token signatures

|Claims Validation Errors
|Errors related to invalid token claims (expiration, issuer, etc.)

|Authorization Errors
|Errors related to insufficient permissions (scopes, roles)

|JWKS Retrieval Errors
|Errors related to retrieving JWKS from endpoints

|Configuration Errors
|Errors related to processor configuration
|===

=== Error Codes and Messages

For a comprehensive list of error messages, codes, and their explanations, refer to link:../LogMessages.adoc[Log Message Documentation].

=== Integration with oauth-sheriff-core

The processor leverages the oauth-sheriff-core library's error reporting capabilities, which are mapped to NiFi's error handling mechanisms:

[source,java]
----
/**
 * Maps oauth-sheriff-core errors to processor error codes and messages.
 */
private void handleValidationError(FlowFile flowFile, ProcessSession session, ValidationError error) {
    String errorCode;
    String category;
    String message;
    
    switch (error.getErrorType()) {
        case TOKEN_EXPIRED:
            errorCode = "AUTH-003";
            category = "CLAIMS_VALIDATION";
            message = ERROR.TOKEN_EXPIRED.format();
            break;
            
        case INVALID_SIGNATURE:
            errorCode = "AUTH-002";
            category = "SIGNATURE_VALIDATION";
            message = ERROR.INVALID_TOKEN_SIGNATURE.format(error.getIssuer().orElse("unknown"));
            break;
            
        case INVALID_ISSUER:
            errorCode = "AUTH-005";
            category = "CLAIMS_VALIDATION";
            message = ERROR.UNKNOWN_ISSUER.format(error.getIssuer().orElse("unknown"));
            break;
            
        case INVALID_AUDIENCE:
            errorCode = "AUTH-006";
            category = "CLAIMS_VALIDATION";
            message = ERROR.INVALID_AUDIENCE.format();
            break;
            
        // Additional error types handled here...
            
        default:
            errorCode = "AUTH-001";
            category = "TOKEN_FORMAT";
            message = ERROR.INVALID_TOKEN_FORMAT.format(error.getMessage());
    }
    
    // Add error attributes to flow file
    Map<String, String> attributes = new HashMap<>();
    attributes.put("jwt.error.code", errorCode);
    attributes.put("jwt.error.reason", message);
    attributes.put("jwt.error.category", category);
    session.putAllAttributes(flowFile, attributes);
    
    // Log the error
    LOGGER.error("{}-{}: {}", "AUTH", errorCode.substring(5), message);
    
    // Transfer to failure relationship
    session.transfer(flowFile, AUTHENTICATION_FAILED);
}
----

=== Security Event Monitoring

The processor implements security event monitoring as described in link:token-validation.adoc[Token Validation - Security Event Monitoring].

=== Error Response Generation

Error responses are carefully crafted to:

1. Provide actionable information to developers
2. Avoid exposing sensitive information
3. Include standardized error codes for troubleshooting
4. Use internationalized error messages for consistent user experience

For information about how errors are handled in the UI, see link:configuration-ui.adoc[UI Configuration].

== Testing Error Handling

For details on how error handling is tested, including specific test cases and verification approaches, see link:testing.adoc[Testing Specification].

=== Enhanced Error Messages

The implementation provides enhanced error messages with contextual information:

==== Example Error Messages

[source,text]
----
# Token validation error with context
Error processing flow file [ErrorCode=PROCESSING_ERROR, Component=MultiIssuerJWTTokenAuthenticator, Operation=onTrigger, flowFileUuid=abc123, tokenLocation=AUTHORIZATION_HEADER] Caused by: JWTValidationException: Token signature is invalid

# Configuration error with file context  
Error loading configuration file [ErrorCode=IO_ERROR, Component=ConfigurationManager, Operation=loadConfigurationFile, file=/opt/nifi/conf/jwt-validation.yaml, fileFormat=yaml] Caused by: YAMLException: Invalid syntax at line 10

# Issuer configuration error with details
Failed to create issuer configuration [ErrorCode=CONFIGURATION_ERROR, Component=IssuerConfigurationParser, Operation=parseIssuers, issuerId=auth-server-1, issuerName=Primary Auth Server, jwksUrl=https://auth.example.com/.well-known/jwks.json]
----

==== Benefits of Enhanced Error Handling

1. **Faster Debugging**: Contextual information helps identify issues quickly
2. **Better Monitoring**: Standardized error codes enable automated alerting
3. **Improved Operations**: Clear error categorization helps with routing and resolution
4. **Enhanced Security**: Structured logging without exposing sensitive data

== See Also

=== Core Documentation
* link:../Specification.adoc[Main Specification]
* link:../Requirements.adoc[Requirements]
* link:../LogMessages.adoc[Log Message Documentation]

=== Related Implementation
* link:token-validation.adoc[Token Validation]
* link:security.adoc[Security]
* link:configuration-ui.adoc[UI Configuration]
* link:testing.adoc[Testing]
