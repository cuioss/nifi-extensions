= Static Configuration Support
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

== Overview

This document details the static configuration support for JWT validation in container environments. This capability addresses requirement link:../Requirements.adoc#NIFI-AUTH-7[NIFI-AUTH-7: Container-based Integration].

== Configuration File Formats

The JWTTokenExtractor processor supports loading issuer configurations from external files, which is especially useful in containerized environments where configuration can be injected as mounted files rather than manually configured in the NiFi UI.

The following file formats are supported:

=== Properties Format (.properties)

```properties
# Example properties configuration
issuer.count=2

# First issuer configuration
issuer.1.name=Primary Auth Server
issuer.1.issuerUrl=https://auth.example.org
issuer.1.jwksUrl=https://auth.example.org/.well-known/jwks.json
issuer.1.tokenExpiration=3600
issuer.1.requiredClaims=aud,sub
issuer.1.aud=my-api
issuer.1.roles=admin,user

# Second issuer configuration
issuer.2.name=Secondary Auth Server
issuer.2.issuerUrl=https://auth2.example.org
issuer.2.jwksUrl=https://auth2.example.org/.well-known/jwks.json
issuer.2.tokenExpiration=7200
issuer.2.requiredClaims=aud,sub,roles
issuer.2.aud=my-secondary-api
issuer.2.roles=viewer
```

=== YAML Format (.yaml, .yml)

```yaml
issuers:
  - name: "Primary Auth Server"
    issuerUrl: "https://auth.example.org"
    jwksUrl: "https://auth.example.org/.well-known/jwks.json"
    tokenExpiration: 3600
    requiredClaims: ["aud", "sub"]
    claims:
      aud: "my-api"
      roles: "admin,user"
  
  - name: "Secondary Auth Server"
    issuerUrl: "https://auth2.example.org"
    jwksUrl: "https://auth2.example.org/.well-known/jwks.json"
    tokenExpiration: 7200
    requiredClaims: ["aud", "sub", "roles"]
    claims:
      aud: "my-secondary-api"
      roles: "viewer"
```

=== JSON Format (.json)

```json
{
  "issuers": [
    {
      "name": "Primary Auth Server",
      "issuerUrl": "https://auth.example.org",
      "jwksUrl": "https://auth.example.org/.well-known/jwks.json",
      "tokenExpiration": 3600,
      "requiredClaims": ["aud", "sub"],
      "claims": {
        "aud": "my-api",
        "roles": "admin,user"
      }
    },
    {
      "name": "Secondary Auth Server",
      "issuerUrl": "https://auth2.example.org",
      "jwksUrl": "https://auth2.example.org/.well-known/jwks.json",
      "tokenExpiration": 7200,
      "requiredClaims": ["aud", "sub", "roles"],
      "claims": {
        "aud": "my-secondary-api",
        "roles": "viewer"
      }
    }
  ]
}
```

== Configuration Properties

Each issuer configuration supports the following properties:

[cols="1,3,1,1"]
|===
|Property |Description |Required |Default

|name
|A descriptive name for the issuer
|Yes
|N/A

|issuerUrl
|The URL of the token issuer, must match the 'iss' claim in the token
|Yes
|N/A

|jwksUrl
|URL to the JSON Web Key Set (JWKS) endpoint for retrieving public keys
|Yes
|N/A

|tokenExpiration
|Maximum allowed token lifetime in seconds
|No
|3600

|requiredClaims
|Comma-separated list of claims that must be present in the token
|No
|None

|claims
|Map of claim names and their expected values
|No
|None
|===

== Container Environment Integration

=== Kubernetes ConfigMap Example

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: jwt-issuers-config
data:
  issuers.yaml: |
    issuers:
      - name: "Primary Auth Server"
        issuerUrl: "https://auth.example.org"
        jwksUrl: "https://auth.example.org/.well-known/jwks.json"
        tokenExpiration: 3600
        requiredClaims: ["aud", "sub"]
        claims:
          aud: "my-api"
          roles: "admin,user"
```

=== Docker Compose Example

```yaml
version: '3'
services:
  nifi:
    image: apache/nifi:2.3.0
    ports:
      - "8443:8443"
    volumes:
      - ./config/issuers.json:/opt/nifi/nifi-current/config/issuers.json:ro
    environment:
      - NIFI_WEB_HTTPS_PORT=8443
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=Password123
```

== Runtime Configuration Loading

The JWTTokenExtractor processor checks for configuration file updates at regular intervals, allowing for dynamic reconfiguration without restarting NiFi or the processor.

=== Configuration Refresh Behavior

1. The processor checks for file modification timestamps at a configurable interval
2. If changes are detected, the configuration is reloaded
3. Configuration errors are logged and the processor falls back to the last valid configuration
4. A flowfile attribute `jwt.config.refreshed` is set to `true` on the first flowfile processed after a configuration refresh

== Error Handling

The processor implements robust error handling for configuration loading:

1. If the configuration file cannot be read or parsed, an error is logged and the processor continues with the last valid configuration
2. If no valid configuration has been loaded, flowfiles are routed to the `failure` relationship
3. Detailed error information is added to flowfile attributes with the prefix `jwt.config.error`

== Security Considerations

=== File Permissions

When deploying in containerized environments, ensure that:

1. Configuration files have appropriate read permissions for the NiFi process user
2. Configuration files are mounted as read-only to prevent unauthorized modifications
3. Sensitive configuration is properly secured using Kubernetes Secrets or similar mechanisms

=== JWKS URL Security

1. JWKS URLs should use HTTPS to ensure secure key retrieval
2. Consider using mutual TLS authentication for JWKS endpoints in high-security environments
3. Implement proper network security controls to restrict access to JWKS endpoints