= NiFi Extensions Observability
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

link:../Specification.adoc[Back to Main Specification]

== Observability Overview
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18[NIFI-AUTH-18: Security Event Monitoring]_

The NiFi Extensions project implements comprehensive observability features for monitoring token validation, security events, and processor performance. Both processors expose metrics through different mechanisms:

* **MultiIssuerJWTTokenAuthenticator** -- exposes OAuth-Sheriff `SecurityEventCounter` metrics through the Custom UI metrics tab
* **RestApiGatewayProcessor** -- exposes three metric sources through a dedicated `/metrics` management endpoint (Prometheus and JSON formats)

== Implementation Status

=== Implementation Classes
* link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] -- Token validation with security event tracking
* link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/ManagementEndpointHandler.java[ManagementEndpointHandler] -- Gateway `/metrics` management endpoint
* link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/GatewaySecurityEvents.java[GatewaySecurityEvents] -- Application-level security event counters
* link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/servlets/GatewayProxyServlet.java[GatewayProxyServlet] -- Proxies `/metrics` from Custom UI to gateway

=== Verification
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorTest.java[MultiIssuerJWTTokenAuthenticatorTest]

== JWT Processor Metrics

=== SecurityEventCounter Metrics
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18.1[NIFI-AUTH-18.1: NiFi UI Integration]_

The JWT processor leverages the `SecurityEventCounter` from the OAuth-Sheriff library to track key security events:

[cols="2,4"]
|===
|Metric Name |Description

|totalProcessedTokens
|Total number of tokens processed by the validator

|validTokens
|Number of tokens that passed all validation checks

|invalidTokens
|Total number of tokens that failed validation for any reason

|malformedTokens
|Number of tokens with structural issues, incorrect format, or parsing problems

|expiredTokens
|Number of tokens that were rejected because they were expired

|invalidSignatureTokens
|Number of tokens with invalid, tampered, or unverifiable signatures

|missingClaimTokens
|Number of tokens missing required claims (e.g., sub, iss, exp)

|invalidClaimTokens
|Number of tokens with invalid claim values (e.g., wrong audience)

|processingErrors
|Number of unexpected errors during token processing
|===

These metrics are displayed in the Custom UI "Metrics" tab.

== REST API Gateway Metrics

The RestApiGatewayProcessor provides a dedicated `/metrics` management endpoint via link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/ManagementEndpointHandler.java[ManagementEndpointHandler]. This endpoint aggregates three metric sources:

=== Metric Sources

1. **OAuth-Sheriff Token Validation** (`tokenValidation`) -- Token validation events from the `SecurityEventCounter` (same metrics as the JWT processor)
2. **cui-http Transport Security** (`httpSecurity`) -- Transport-level security events from the cui-http `SecurityEventCounter` (input sanitization, suspicious requests)
3. **Gateway Application Events** (`gatewayEvents`) -- Application-level events from link:../../nifi-cuioss-rest-processors/src/main/java/de/cuioss/nifi/rest/handler/GatewaySecurityEvents.java[GatewaySecurityEvents]

=== Gateway Security Event Types

[cols="2,1,3"]
|===
|Event Type |HTTP Status |Description

|MISSING_BEARER_TOKEN
|401
|No Authorization header or malformed Bearer prefix

|AUTH_FAILED
|401
|Token validation failed (expired, bad signature, etc.)

|AUTHZ_ROLE_DENIED
|403
|Valid token but missing required roles

|AUTHZ_SCOPE_DENIED
|401
|Valid token but missing required scopes

|BODY_TOO_LARGE
|413
|Request body exceeds configured maximum

|ROUTE_NOT_FOUND
|404
|No route configured for requested path

|METHOD_NOT_ALLOWED
|405
|Route exists but HTTP method not allowed

|QUEUE_FULL
|503
|Request queue at capacity (back-pressure)
|===

=== /metrics Endpoint

The `/metrics` endpoint is served on the same port as the gateway (e.g., `https://host:9443/metrics`).

==== Authentication

When `rest.gateway.management.api-key` is configured, the endpoint requires the key in the `X-Api-Key` header. Returns 401 if the key is missing or incorrect.

==== Prometheus Format (default)

Requested with `Accept: text/plain` or by default:

[source]
----
# Token validation metrics
nifi_jwt_validations_total{result="validTokens"} 15126
nifi_jwt_validations_total{result="invalidTokens"} 297
nifi_jwt_validations_total{result="expiredTokens"} 198

# Transport security metrics (cui-http)
nifi_gateway_http_security_events_total{type="sanitized_path"} 42

# Gateway application metrics
nifi_gateway_events_total{type="MISSING_BEARER_TOKEN"} 12
nifi_gateway_events_total{type="AUTH_FAILED"} 85
nifi_gateway_events_total{type="ROUTE_NOT_FOUND"} 3
nifi_gateway_events_total{type="QUEUE_FULL"} 0
----

==== JSON Format

Requested with `Accept: application/json`:

[source,json]
----
{
  "tokenValidation": {
    "validTokens": 15126,
    "invalidTokens": 297,
    "expiredTokens": 198
  },
  "httpSecurity": {
    "sanitized_path": 42
  },
  "gatewayEvents": {
    "MISSING_BEARER_TOKEN": 12,
    "AUTH_FAILED": 85,
    "ROUTE_NOT_FOUND": 3,
    "QUEUE_FULL": 0
  }
}
----

=== Custom UI Integration

The Custom UI proxies gateway metrics through link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/servlets/GatewayProxyServlet.java[GatewayProxyServlet], allowing the Metrics tab to display real-time gateway metrics alongside token validation metrics.

== NiFi UI Integration
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18.1[NIFI-AUTH-18.1: NiFi UI Integration]_

Both processors integrate metrics into the NiFi UI for operational visibility through the Custom UI Metrics tab. The tab shows:

1. Detailed breakdown of all security event metrics
2. Percentage calculations and trend indicators
3. A "Reset Metrics" button to clear counters

For more information on the UI components, see link:configuration-ui.adoc[UI Configuration].

== External Monitoring Integration
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18.3[NIFI-AUTH-18.3: External Monitoring System Support]_

=== Prometheus Integration

The RestApiGateway's `/metrics` endpoint natively supports Prometheus scraping:

[source,yaml]
----
scrape_configs:
  - job_name: 'nifi-gateway'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['nifi-gateway:9443']
    scheme: https
    tls_config:
      insecure_skip_verify: false
    # If management API key is configured:
    # authorization:
    #   credentials: '<api-key>'
    #   type: 'X-Api-Key'
----

=== Grafana Dashboard Panels

When using Prometheus as a data source, recommended panels include:

1. Token validation success rate over time
2. Error breakdown by type (pie chart)
3. Gateway events timeline (QUEUE_FULL indicates back-pressure)
4. Alert thresholds for high error rates

== Security Considerations

=== Metric Access Control

* The gateway `/metrics` endpoint can be secured with an API key (`rest.gateway.management.api-key`)
* The Custom UI metrics tab inherits NiFi's authentication and authorization
* Metrics contain only aggregate counts, no token content or PII

=== Data Privacy

Security metrics are designed to protect sensitive information:

1. Metrics contain only aggregate counts, no token content or PII
2. Instance identifiers can be anonymized if needed
3. No sensitive information is exposed in metric names or values

For more information on security considerations, see link:security.adoc[Security].

== See Also

=== Core Documentation
* link:../Specification.adoc[Main Specification]
* link:../Requirements.adoc[Requirements]
* link:../Requirements.adoc#NIFI-AUTH-18[Security Event Monitoring Requirements]

=== Related Implementation
* link:security.adoc[Security]
* link:token-validation.adoc[Token Validation]
* link:error-handling.adoc[Error Handling]
* link:configuration-ui.adoc[UI Configuration]
* link:technical-components.adoc[Technical Components]
