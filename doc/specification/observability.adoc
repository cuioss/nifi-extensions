= MultiIssuerJWTTokenAuthenticator Observability
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

link:../Specification.adoc[Back to Main Specification]

== Observability Overview
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18[NIFI-AUTH-18: Security Event Monitoring]_

The MultiIssuerJWTTokenAuthenticator implements comprehensive observability features for monitoring token validation, security events, and processor performance. This document outlines the metrics collection, monitoring integration, and security event tracking provided by the processor.

== Implementation Status

=== Implementation Classes
* link:../../nifi-cuioss-ui/src/main/java/de/cuioss/nifi/ui/servlets/MetricsServlet.java[MetricsServlet] -- REST endpoint for security metrics retrieval
* link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] -- Token validation with security event tracking

=== Verification
* link:../../nifi-cuioss-ui/src/test/java/de/cuioss/nifi/ui/servlets/MetricsServletTest.java[MetricsServletTest]
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorTest.java[MultiIssuerJWTTokenAuthenticatorTest]

== Security Event Metrics

=== Available Metrics
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18.1[NIFI-AUTH-18.1: NiFi UI Integration]_

The processor leverages the SecurityEventCounter from the OAuth-Sheriff library to track key security events:

[cols="2,4"]
|===
|Metric Name |Description

|totalProcessedTokens
|Total number of tokens processed by the validator

|validTokens
|Number of tokens that passed all validation checks

|invalidTokens
|Total number of tokens that failed validation for any reason

|malformedTokens
|Number of tokens with structural issues, incorrect format, or parsing problems

|expiredTokens
|Number of tokens that were rejected because they were expired

|invalidSignatureTokens
|Number of tokens with invalid, tampered, or unverifiable signatures

|missingClaimTokens
|Number of tokens missing required claims (e.g., sub, iss, exp)

|invalidClaimTokens
|Number of tokens with invalid claim values (e.g., wrong audience)

|processingErrors
|Number of unexpected errors during token processing
|===

=== Metrics Implementation

The processor collects metrics using the SecurityEventCounter provided by the OAuth-Sheriff library. See link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] for the metrics collection implementation.

For more information on token validation implementation, see link:token-validation.adoc#_security_event_monitoring[Security Event Monitoring].

== NiFi UI Integration
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18.1[NIFI-AUTH-18.1: NiFi UI Integration]_

The processor integrates metrics into the NiFi UI for operational visibility.

=== Processor Status Display

The processor displays key metrics directly in the NiFi UI status:

[source]
----
Running | Processed: 15,423 | Valid: 15,126 | Invalid: 297
----

=== Processor Details View

When selecting the processor, detailed metrics are displayed in the Processor Details pane:

[cols="2,2"]
|===
|Metric |Value

|Tokens Processed
|15,423

|Valid Tokens
|15,126 (98.1%)

|Invalid Tokens
|297 (1.9%)

|Malformed
|42

|Expired
|198

|Invalid Signature
|37

|Missing Claims
|15

|Invalid Claims
|5
|===

=== Configuration Dialog Metrics Tab

A dedicated "Metrics" tab in the processor configuration dialog provides:

1. Detailed breakdown of all security event metrics
2. Percentage calculations and trend indicators
3. A "Reset Metrics" button to clear counters
4. Historical metrics chart (last 24 hours)

For more information on the UI components, see link:configuration-ui.adoc[UI Configuration].

== NiFi Metrics Integration
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18.2[NIFI-AUTH-18.2: Metrics System Integration]_

The processor registers metrics with NiFi's metrics system for integration with monitoring tools.

=== NiFi Metrics Registry

The processor registers security event metrics with NiFi's metrics registry during initialization. See the `onScheduled` method in link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] for the registration implementation.

=== Metrics Naming Convention

All metrics follow the standard NiFi naming convention:

[source]
----
namespace=jwt-processor
group=security-events
metric_name=<event-type>
----

Example of full metric names:

* `jwt-processor.security-events.total-processed-tokens`
* `jwt-processor.security-events.valid-tokens`
* `jwt-processor.security-events.invalid-tokens`

== External Monitoring Integration
_See Requirement link:../Requirements.adoc#NIFI-AUTH-18.3[NIFI-AUTH-18.3: External Monitoring System Support]_

=== Prometheus Integration

==== NiFi Prometheus Endpoint

The processor exposes metrics through NiFi's built-in Prometheus endpoint:

[source]
----
http(s)://<nifi-host>:<nifi-port>/nifi-api/metrics/prometheus
----

The metrics are formatted according to Prometheus exposition format:

[source]
----
# HELP jwt_processor_total_processed_tokens Total number of tokens processed
# TYPE jwt_processor_total_processed_tokens counter
jwt_processor_total_processed_tokens{component_id="f23a6614-0173-1000-ffff-ffffa96fffff",component_type="MultiIssuerJWTTokenAuthenticator",component_name="ValidateJWT"} 15423

# HELP jwt_processor_valid_tokens Number of tokens successfully validated
# TYPE jwt_processor_valid_tokens counter
jwt_processor_valid_tokens{component_id="f23a6614-0173-1000-ffff-ffffa96fffff",component_type="MultiIssuerJWTTokenAuthenticator",component_name="ValidateJWT"} 15126

# ... other metrics
----

==== Labels and Metadata

All Prometheus metrics include the following labels:

* `component_id`: The processor instance ID
* `component_type`: Always "MultiIssuerJWTTokenAuthenticator"
* `component_name`: The processor name assigned in NiFi
* `instance`: The NiFi instance name/ID

==== Prometheus Configuration Example

Sample Prometheus scrape configuration:

[source,yaml]
----
scrape_configs:
  - job_name: 'nifi'
    metrics_path: '/nifi-api/metrics/prometheus'
    basic_auth:
      username: 'monitor'
      password: 'monitor-password'
    static_configs:
      - targets: ['nifi-server:8443']
    scheme: https
    tls_config:
      insecure_skip_verify: false
      ca_file: /etc/prometheus/certs/nifi-ca.crt
----

=== Grafana Dashboard

When using Prometheus as a data source, a Grafana dashboard can visualize these panels:

1. Total tokens processed (counter)
2. Token validation success rate (gauge)
3. Error breakdown by type (pie chart)
4. Token validation trends over time (time series)
5. Alert thresholds for high error rates

For more information on monitoring integration, see link:security.adoc#_security_event_monitoring[Security Event Monitoring].

== Implementation Details

=== SecurityEventCounter Integration

The processor integrates with the OAuth-Sheriff SecurityEventCounter as follows:

1. Initialize TokenValidator with SecurityEventCounter
2. Track all validation events through TokenValidator
3. Expose counter through NiFi metrics registry
4. Periodically log metrics for operational visibility

See link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] for the full lifecycle implementation (`init`, `onScheduled`, `onUnscheduled`, `onTrigger`).

== Security Considerations

=== Metric Access Control

Metrics should be secured with appropriate access controls:

1. Access to metrics endpoints should be secured with authentication
2. Consider creating a dedicated "metrics" role with limited permissions
3. Monitoring systems should use dedicated service accounts

=== Data Privacy

Security metrics are designed to protect sensitive information:

1. Metrics contain only aggregate counts, no token content or PII
2. Instance identifiers can be anonymized if needed
3. No sensitive information is exposed in metric names or values

For more information on security considerations, see link:security.adoc[Security].

=== Audit Trail Integration

Security events can be integrated with NiFi's Provenance Repository for compliance and auditing. The `onTrigger` method in link:../../nifi-cuioss-processors/src/main/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticator.java[MultiIssuerJWTTokenAuthenticator] records validation failures to the provenance repository and increments security event counters.

== See Also

=== Core Documentation
* link:../Specification.adoc[Main Specification]
* link:../Requirements.adoc[Requirements]
* link:../Requirements.adoc#NIFI-AUTH-18[Security Event Monitoring Requirements]

=== Related Implementation
* link:security.adoc[Security]
* link:token-validation.adoc[Token Validation]
* link:configuration-ui.adoc[UI Configuration]
* link:technical-components.adoc[Technical Components]