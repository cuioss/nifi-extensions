= NiFi Extensions Testing
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:imagesdir: ../plantuml

link:../Specification.adoc[Back to Main Specification]

== Referenced Implementation

=== Test Directories
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/[nifi-cuioss-processors tests] -- JWT processor unit tests
* link:../../nifi-cuioss-rest-processors/src/test/java/de/cuioss/nifi/rest/[nifi-cuioss-rest-processors tests] -- REST gateway processor unit tests
* link:../../nifi-cuioss-common/src/test/java/de/cuioss/nifi/jwt/[nifi-cuioss-common tests] -- Shared infrastructure tests (AuthorizationValidator, ErrorContext, etc.)
* link:../../nifi-cuioss-ui/src/test/java/de/cuioss/nifi/ui/[nifi-cuioss-ui tests] -- UI service and servlet tests
* link:../../integration-testing/[integration-testing module] -- Docker-based integration tests
* link:../../e-2-e-playwright/[e-2-e-playwright module] -- Playwright E2E and WCAG accessibility tests
* link:../../e-2-e-playwright/[e-2-e-playwright module] -- Playwright E2E tests

=== Key Test Classes
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorTest.java[MultiIssuerJWTTokenAuthenticatorTest]
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorExtendedTest.java[MultiIssuerJWTTokenAuthenticatorExtendedTest] -- RS256 signed token tests
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/util/AuthorizationValidatorTest.java[AuthorizationValidatorTest]
* link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/util/ErrorContextTest.java[ErrorContextTest]

== Testing Overview
[.requirement]
_See Requirement: link:../Requirements.adoc#NIFI-AUTH-14[NIFI-AUTH-14: Unit Testing]_

== Testing Strategy
_See Requirement link:../Requirements.adoc#NIFI-AUTH-14[NIFI-AUTH-14: Unit Testing] and link:../Requirements.adoc#NIFI-AUTH-15[NIFI-AUTH-15: Integration Testing]_

The MultiIssuerJWTTokenAuthenticator processor is tested through a comprehensive set of tests that cover various aspects of functionality, security, and performance.

=== Testing Layers

The testing strategy includes these layers:

1. **Unit Testing**: Testing individual components in isolation
2. **Integration Testing**: Testing components working together
3. **System Testing**: Testing the processor in a NiFi environment
4. **Security Testing**: Testing security aspects specifically
5. **Performance Testing**: Testing under load and stress conditions

== Unit Testing

=== TokenValidator Testing

Unit tests for the TokenValidator component verify:

1. **Token Parsing**: Correct parsing of various token formats
2. **Signature Validation**: Proper validation of token signatures
3. **Claim Validation**: Proper validation of token claims
4. **Error Handling**: Proper handling of validation errors

For examples of token validation testing with real RS256-signed tokens, see link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorExtendedTest.java[MultiIssuerJWTTokenAuthenticatorExtendedTest], which uses `TestTokenHolder` and `InMemoryJWKSFactory` from oauth-sheriff-core test utilities to generate real key material and signed tokens.

For more details on TokenValidator implementation, see link:token-validation.adoc[Token Validation].

=== Processor Testing

Unit tests for the processor verify:

1. **Property Validation**: Correct validation of processor properties
2. **Token Extraction**: Proper extraction of tokens from different locations
3. **Flow File Routing**: Proper routing of flow files to relationships
4. **Attribute Generation**: Proper generation of output attributes

For processor unit testing examples using NiFi's TestRunner, see link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorTest.java[MultiIssuerJWTTokenAuthenticatorTest] and link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorExtendedTest.java[MultiIssuerJWTTokenAuthenticatorExtendedTest]. These tests verify property validation, token extraction, flow file routing, and attribute generation.

See link:technical-components.adoc[Technical Components] for processor implementation details.

== Integration Testing

Integration tests verify multiple components working together:

1. **TokenValidator with Real JWTs**: Testing with actual JWT tokens
2. **TokenValidator with JWKS Endpoints**: Testing with mock JWKS endpoints
3. **TokenValidator with Multiple Issuers**: Testing with multiple token issuers

For integration testing examples with multiple issuers, see link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorExtendedTest.java[MultiIssuerJWTTokenAuthenticatorExtendedTest], which tests with JWKS file-based issuer configurations and real RS256-signed tokens.

=== Integration Testing with Keycloak

For integration tests with real tokens and a real identity provider, use the cui-test-keycloak-integration library. This library provides:

* A pre-configured Keycloak test realm (`oauth_integration_tests`)
* Ready-to-use user (`testUser` / `drowssap`) and client (`test_client`)
* A base class for integration tests using Testcontainers and Keycloak
* Consistent constants and configuration for all tests

Add the following dependency to your test scope:

[source,xml]
----
<dependency>
    <groupId>de.cuioss.test</groupId>
    <artifactId>cui-test-keycloak-integration</artifactId>
    <scope>test</scope>
</dependency>
----

For full usage details and advanced configuration, see link:../library/cui-test-keycloak-integration/README.adoc[cui-test-keycloak-integration documentation].

You can find example integration tests in the KeycloakITBaseTest class linked from the documentation.

For more details on integration patterns, see link:integration-patterns.adoc[Integration Patterns].

== System Testing

System tests verify the processor in a real NiFi environment:

1. **Deployment Testing**: Testing deployment in a NiFi instance
2. **Configuration Testing**: Testing configuration through the UI
3. **Flow Testing**: Testing in a complete flow with other processors
4. **Flow Pipeline Testing**: End-to-end HTTP request/response testing through a pre-configured NiFi flow

For flow pipeline testing with JWT authentication and role-based authorization, see xref:integration-testing.adoc[Integration Testing — Flow Pipeline Design].

For more details on system testing approach, see link:configuration-ui.adoc[UI Configuration].

== Security Testing

Security tests focus on security aspects of the processor:

1. **Token Attack Testing**: Testing with malformed or malicious tokens
2. **Algorithm Attack Testing**: Testing with weak or forbidden algorithms
3. **Resource Attack Testing**: Testing with very large tokens or high request rates
4. **JWKS Security Testing**: Testing JWKS endpoint security

Security testing for token size limits and related attack scenarios is covered in link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorTest.java[MultiIssuerJWTTokenAuthenticatorTest] and link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorExtendedTest.java[MultiIssuerJWTTokenAuthenticatorExtendedTest].

For more details on security considerations, see link:security.adoc[Security].

== Performance Testing

Performance tests verify the processor under load:

1. **Throughput Testing**: Testing with high flow file rates
2. **Token Size Testing**: Testing with various token sizes
3. **Concurrent Processing Testing**: Testing with multiple threads
4. **Cache Performance Testing**: Testing JWKS caching efficiency

Performance testing patterns follow the same TestRunner approach used in link:../../nifi-cuioss-processors/src/test/java/de/cuioss/nifi/processors/auth/MultiIssuerJWTTokenAuthenticatorExtendedTest.java[MultiIssuerJWTTokenAuthenticatorExtendedTest], creating multiple flow files and measuring processing throughput.

== Test Data Generation

Test data for JWT validation is best generated using the oauth-sheriff-core test utilities. These utilities provide:

* Easy creation of valid and invalid JWT tokens
* In-memory key material and JWKS generation (no filesystem required)
* Token tampering utilities for negative testing
* Support for multiple algorithms (RS256, RS384, RS512)

For full documentation, see link:../library/oauth-sheriff/unit-testing.adoc[JWT Validation Test Utilities].

=== Example: Creating Test Tokens

[source,java]
----
// Create a valid signed JWT with default claims
String token = TestTokenProducer.validSignedEmptyJWT();

// Create a valid signed JWT with custom claims
String tokenWithClaims = TestTokenProducer.validSignedJWTWithClaims("path/to/claims.json");

// Create a valid signed JWT with custom expiration
String tokenWithExpiration = TestTokenProducer.validSignedJWTExpireAt(Instant.now().plus(1, ChronoUnit.HOURS));
----

=== Example: In-Memory JWKS and Key Material

[source,java]
----
// Get default private/public key for RS256
PrivateKey privateKey = InMemoryKeyMaterialHandler.getDefaultPrivateKey();
PublicKey publicKey = InMemoryKeyMaterialHandler.getDefaultPublicKey();

// Create JWKS content for the default RS256 key
String jwks = InMemoryKeyMaterialHandler.createDefaultJwks();

// Create a JwksLoader for the default RS256 key
JwksLoader jwksLoader = InMemoryKeyMaterialHandler.createDefaultJwksLoader();
----

=== Example: Tampering with Tokens

[source,java]
----
// Create a tampered token with modified claims
String tamperedToken = JwtTokenTamperingUtil.tamperWithClaim(originalToken, "sub", "modified-subject");

// Create a token with an invalid signature
String invalidSignatureToken = JwtTokenTamperingUtil.invalidateSignature(originalToken);
----

== MockWebServer-based Testing

The project uses the cui-test-mockwebserver-junit5 extension for robust HTTP/HTTPS endpoint simulation in tests. This extension provides:

* Easy annotation-based setup for HTTP/HTTPS servers
* Context-aware mock responses with @MockResponseConfig
* Flexible request handling with @ModuleDispatcher
* Built-in support for HTTPS and custom certificates
* Parameter injection for MockWebServer, URIBuilder, and SSLContext

For details, see:

* link:../library/cui-test-mockwebserver-junit5/README.adoc[MockWebServer JUnit5 Extension Overview]
* link:../library/cui-test-mockwebserver-junit5/MockResponse.adoc[Working with @MockResponse]
* link:../library/cui-test-mockwebserver-junit5/ModuleDispatcher.adoc[Working with @ModuleDispatcher]
* link:../library/cui-test-mockwebserver-junit5/HttpsSupport.adoc[HTTPS Support and Certificates]

=== Example: Simulating a JWKS Endpoint

Instead of manual WireMock or custom server code, use the extension as follows:

[source,java]
----
@EnableMockWebServer(useHttps = true)
@MockResponseConfig(
    path = "/.well-known/jwks.json",
    method = HttpMethodMapper.GET,
    status = 200,
    jsonContentKeyValue = "keys=[{kty=RSA,kid=key1,alg=RS256,n=...,e=AQAB}]"
)
class JwksEndpointTest {
    @Test
    void shouldFetchJwks(URIBuilder uriBuilder, SSLContext sslContext) {
        // Use uriBuilder to get the JWKS endpoint URL
        String jwksUrl = uriBuilder.addPathSegments(".well-known", "jwks.json").build().toString();
        // Pass jwksUrl to your processor or validator under test
        // ...
    }
}
----

For more advanced scenarios (dynamic responses, custom dispatchers, HTTPS certs), see the linked documentation above.

For advanced JWKS endpoint simulation and HTTP/HTTPS testing, see the MockWebServer-based Testing section above and the detailed documentation in doc/library/cui-test-mockwebserver-junit5/.

== Test Coverage

The test suite aims for high coverage across all areas:

1. **Java Line Coverage**: 80% minimum
2. **JavaScript Coverage**: 80% lines, 75% branches, 78% functions

Test coverage is measured and reported during the build process.

== Test Execution

Tests are run automatically as part of the build process:

1. **Unit Tests**: Run during `mvn test`
2. **Integration Tests**: Run during `mvn verify`
3. **Performance Tests**: Run manually or on demand

== See Also

* link:token-validation.adoc[Token Validation]
* link:configuration.adoc[Configuration]
* link:security.adoc[Security]
* link:technical-components.adoc[Technical Components]
* xref:integration-testing.adoc[Integration Testing — Flow Pipeline Design]
* link:../Requirements.adoc#NIFI-AUTH-14[Unit Testing Requirements]
* link:../Specification.adoc[Back to Main Specification]

== JWT Validation Test Utilities

For detailed documentation on the oauth-sheriff-core test utilities, see link:../library/oauth-sheriff/unit-testing.adoc[JWT Validation Test Utilities].
