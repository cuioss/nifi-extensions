// filepath: /home/oliver/git/nifi-extensions/doc/implement-end-to-end.adoc
= MultiIssuerJWTTokenAuthenticator: End-to-End Testing Implementation Guide
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

link:Specification.adoc[Back to Main Specification]

== Overview

This document provides a step-by-step implementation guide for setting up end-to-end testing for the MultiIssuerJWTTokenAuthenticator processor. It serves as an actionable plan to implement the testing approach described in the link:specification/end-to-end-testing.adoc[End-to-End Testing Specification].

The implementation follows a phased approach, allowing incremental deployment and verification of the testing infrastructure and test cases.

== Prerequisites

Before beginning implementation, ensure the following prerequisites are met:

* Java Development Kit (JDK) 11 or higher
* Apache Maven 3.8.0 or higher
* Node.js 16.x or higher
* Docker 24.x or higher with docker-compose
* Git for source control
* IDE with JavaScript/TypeScript support (VSCode recommended)

== Current Implementation Status

As of June 2025, the following phases have been completed:

* âœ… **Phase 1: Environment Setup** - Complete with Docker-based test environment
* âœ… **Phase 2: Cypress Setup** - Complete with full project structure and custom commands
* âœ… **Phase 3: Basic Test Implementation** - Complete with comprehensive test suites
* âœ… **Phase 4: CI/CD Integration** - Complete with GitHub Actions workflow, frontend toolchain unification, and Node.js cleanup

The `e-2-e-cypress` module is now ready for production use with:

* 15+ custom Cypress commands for NiFi UI automation
* Self-verification tests ensuring command reliability
* Comprehensive test coverage for processor configuration, token validation, and error scenarios
* Console error monitoring with allowlist management
* Maven integration for CI/CD pipelines
* ESLint and Prettier configuration matching project standards
* **Complete CI/CD pipeline** with GitHub Actions, automated testing, and artifact collection

=== Next Steps

With Phases 1-4 complete and CI/CD integration deployed, we are now ready to proceed with Phase 5: Advanced Test Implementation. This phase includes optional enhancements:

* **Phase 5.1: Metrics and Statistics Tests** - Test processor metrics display and verification
* **Phase 5.2: Internationalization Tests** - Verify UI language switching and localization  
* **Phase 5.3: Cross-Browser Tests** - Extend testing across multiple browsers
* **Phase 5.4: Accessibility Tests** - Implement automated accessibility validation
* **Phase 5.5: Visual Testing** - Add visual regression testing capabilities

These enhancements are optional and can be implemented incrementally based on project priorities.

== Implementation Summary

The End-to-End Testing implementation for the MultiIssuerJWTTokenAuthenticator processor has been successfully completed through Phase 4. The implementation provides a robust, maintainable testing framework with full CI/CD integration and the following key achievements:

=== âœ… Completed Features

* **Complete Cypress Testing Framework**: Fully functional `e-2-e-cypress` module with Maven integration
* **15+ Custom Commands**: Comprehensive Cypress commands for NiFi UI automation, including login, navigation, processor management, and token validation
* **Self-Verification System**: Automated testing of custom commands to ensure reliability
* **Console Error Monitoring**: Advanced error tracking with allowlist management for expected warnings
* **Comprehensive Test Coverage**: 
  - 3 self-verification test suites
  - 4 end-to-end test suites covering processor configuration, token validation, JWKS validation, and error handling
  - 25+ individual test scenarios
* **Code Quality Standards**: ESLint and Prettier configuration matching project standards
* **Complete CI/CD Pipeline**: GitHub Actions workflow with automated testing, reporting, artifact collection, and Node.js infrastructure cleanup
* **Frontend Toolchain Unification**: Unified Node.js v20.12.2, npm 10.5.0, and latest dependency versions across modules
* **Documentation**: Complete setup and usage documentation with troubleshooting guides

=== ðŸ—ï¸ Technical Architecture

The implementation follows the specified architecture with:

* **Module Structure**: Standalone `e-2-e-cypress` Maven module with Node.js integration
* **Test Organization**: Clear separation between self-tests, E2E tests, and support utilities
* **Configuration Management**: Environment-specific configurations for different test scenarios
* **Error Handling**: Graceful error handling and detailed reporting
* **CI/CD Ready**: Prepared for integration with GitHub Actions and other CI/CD systems

=== ðŸ“Š Test Statistics

* **Total Test Files**: 7 test files (3 self-tests + 4 E2E tests)
* **Custom Commands**: 15 commands across 4 categories
* **Test Scenarios**: 25+ individual test cases
* **Code Coverage**: Support files covered by self-verification tests
* **Configuration Files**: 6 configuration files for different aspects

=== ðŸš€ Ready for Use

The implementation is production-ready with full CI/CD integration and can be used immediately:

```bash
# Quick start
cd e-2-e-cypress
npm install
./verify-setup.sh

# Run tests (requires test environment)
npm run cypress:selftests  # Self-verification
npm run cypress:run        # Full E2E tests
npm run cypress:open       # Interactive mode

# CI/CD pipeline automatically runs on:
# - Push to main, develop, feature/end-to-end-testing branches
# - Pull requests to main, develop branches
# - Changes to e-2-e-cypress/, nifi-cuioss-processors/, nifi-cuioss-ui/, integration-testing/, or pom.xml
```

=== ðŸ“‹ Future Enhancements

While the core implementation with CI/CD is complete, the following optional enhancements can be added:

* **Phase 5**: Advanced features (accessibility testing, visual testing, cross-browser support)
* **Additional processors**: Extend commands for other NiFi processors
* **Performance testing**: Add performance benchmarks and monitoring

The current implementation provides a solid foundation that can be extended as needed while maintaining the established patterns and quality standards.

== Implementation Plan

=== Phase 1: Environment Setup âœ…

[cols="1,3,1", options="header"]
|===
|Task |Description |Status

|1.1
|Set up Docker-based test environment with NiFi and Keycloak
|âœ… Complete

|1.2
|Configure self-signed certificates for HTTPS
|âœ… Complete

|1.3
|Set up Keycloak realm with test users and clients
|âœ… Complete

|1.4
|Verify connectivity between containers
|âœ… Complete

|1.5
|Create helper scripts for starting/stopping environment
|âœ… Complete
|===

[NOTE]
====
Refer to the link:specification/end-to-end-testing.adoc#_containerized_testing_environment[Containerized Testing Environment] section in the specification for detailed requirements.
====

==== Implementation Status

Phase 1 has been completed with the implementation in the \`integration-testing\` directory. The environment provides:

1. Docker Compose configuration in \`integration-testing/src/main/docker/docker-compose.yml\` with NiFi and Keycloak containers
2. Helper scripts for environment management:
* \`run-test-container.sh\`: Builds NAR, checks certificates, starts containers
* \`stop-test-container.sh\`: Stops and removes containers
* \`copy-deployment.sh\`: Builds NAR and copies to deployment location
* \`redeploy-nifi.sh\`: Rebuilds and redeploys during development
3. Security configuration:
* Self-signed certificates for HTTPS generated with \`maintenance/generate-certificates.sh\`
* NiFi configured with \`SingleUserLoginIdentityProvider\` (admin/adminadminadmin)
* Keycloak with pre-configured realm \`oauth_integration_tests\`
4. Test user credentials in Keycloak:
* Admin: admin/admin
* Test user: testUser/drowssap
* Test client: test_client with secret

All components can communicate with each other, and the environment is ready for end-to-end testing.

For details, see the link:../integration-testing/README.adoc[Integration Testing README].

=== Phase 2: Cypress Setup

[cols="1,3,1", options="header"]
|===
|Task |Description |Status

|2.1
|Initialize Cypress project structure
|âœ… Complete

|2.2
|Configure Cypress for cross-browser testing
|âœ… Complete

|2.3
|Set up console error monitoring system
|âœ… Complete

|2.4
|Create basic page objects and utilities
|âœ… Complete

|2.5
|Implement token generation utilities
|âœ… Complete
|===

[NOTE]
====
Refer to the link:specification/end-to-end-testing.adoc#_cypress_ui_tests[Cypress UI Tests] section for detailed implementation patterns.
====

==== Implementation Status

Phase 2 has been completed with the following implementations:

1. âœ… **Cypress Project Initialized**: Created `e-2-e-cypress` module with proper Maven and Node.js structure
2. âœ… **Project Structure**: Implemented directory structure as specified with `cypress/`, `fixtures/`, `e2e/`, `support/`, and `selftests/` directories
3. âœ… **Configuration Files**: Added ESLint, Prettier, and Cypress configurations matching `nifi-cuioss-ui` standards
4. âœ… **Custom Commands**: Implemented comprehensive custom commands for login, navigation, processor management, and token validation
5. âœ… **Console Error Monitoring**: Created console error tracking system with allowlist for expected warnings
6. âœ… **Test Fixtures**: Added JWT token examples and JWKS test data for validation scenarios
7. âœ… **Self-Verification Tests**: Implemented self-tests for all custom commands to ensure reliability
8. âœ… **Maven Integration**: Configured frontend-maven-plugin to run self-tests before actual E2E tests

The module is now ready for end-to-end testing with a solid foundation of custom commands and verification systems.

==== e-2-e-cypress Module Structure

The `e-2-e-cypress` module will be created as a standalone Maven module with the following structure:

[source]
----
e-2-e-cypress/
â”œâ”€â”€ pom.xml                     # Maven configuration
â”œâ”€â”€ package.json                # Node/Cypress dependencies
â”œâ”€â”€ cypress.config.js           # Cypress configuration
â”œâ”€â”€ cypress/
â”‚   â”œâ”€â”€ fixtures/               # Test data
â”‚   â”‚   â”œâ”€â”€ tokens/             # JWT token examples
â”‚   â”‚   â””â”€â”€ jwks/               # JWKS examples
â”‚   â”œâ”€â”€ e2e/                    # End-to-end test suites
â”‚   â”‚   â”œâ”€â”€ processor-config/   # Processor configuration tests
â”‚   â”‚   â”œâ”€â”€ token-validation/   # Token validation tests
â”‚   â”‚   â””â”€â”€ error-handling/     # Error handling tests
â”‚   â”œâ”€â”€ support/                # Support files
â”‚   â”‚   â”œâ”€â”€ commands/           # Custom commands
â”‚   â”‚   â”‚   â”œâ”€â”€ login.js        # Login commands
â”‚   â”‚   â”‚   â”œâ”€â”€ navigation.js   # Navigation commands
â”‚   â”‚   â”‚   â”œâ”€â”€ processor.js    # Processor configuration commands
â”‚   â”‚   â”‚   â””â”€â”€ validation.js   # Validation-specific commands
â”‚   â”‚   â”œâ”€â”€ commands.js         # Main commands file
â”‚   â”‚   â”œâ”€â”€ e2e.js              # e2e support file
â”‚   â”‚   â””â”€â”€ console-error-tracking.js # Console error handler
â”‚   â””â”€â”€ selftests/              # Self-verification tests for commands
â”‚       â”œâ”€â”€ login-commands.cy.js # Tests for login commands
â”‚       â”œâ”€â”€ navigation-commands.cy.js # Tests for navigation commands
â”‚       â””â”€â”€ processor-commands.cy.js # Tests for processor commands
â””â”€â”€ tests-report/               # Test report output directory
----

==== Cypress Custom Commands with Self-Verification

The module will implement a comprehensive set of Cypress custom commands that abstract common operations in the NiFi UI. Each command will have corresponding self-verification tests that run during the build process to ensure the commands themselves function correctly.

===== Command Categories

1. *Login Commands*
   * `cy.nifiLogin(username, password)` - Login to NiFi UI
   * `cy.keycloakLogin(username, password)` - Login to Keycloak
   * `cy.verifyLoggedIn()` - Verify successful login state

2. *Navigation Commands*
   * `cy.navigateToCanvas()` - Navigate to NiFi canvas
   * `cy.navigateToProcessorConfig(processorId)` - Open processor configuration
   * `cy.navigateToControllerServices()` - Navigate to controller services

3. *Processor Commands*
   * `cy.addProcessor(type, position)` - Add processor to canvas
   * `cy.configureProcessor(processorId, config)` - Configure processor settings
   * `cy.verifyProcessorProperties(processorId, expectedProps)` - Verify processor properties

4. *JWT Token Commands*
   * `cy.generateToken(claims)` - Generate JWT token with specific claims
   * `cy.verifyTokenValidation(tokenId)` - Verify token validation results

===== Self-Verification Tests

Each custom command will have a corresponding self-verification test in the `cypress/selftests/` directory. These tests will:

1. Run against the same test infrastructure as the actual end-to-end tests
2. Verify that the commands operate correctly in isolation
3. Be executed during the Maven build process before running the actual end-to-end tests
4. Generate detailed reports to identify any command failures early

[source,javascript]
----
// Example self-verification test structure (cypress/selftests/login-commands.cy.js)
describe('Login Commands Self-Verification', () => {
  beforeEach(() => {
    // Setup test environment
  });

  it('should login to NiFi UI successfully', () => {
    cy.nifiLogin('admin', 'adminadminadmin');
    cy.verifyLoggedIn();
  });

  it('should handle failed login attempts', () => {
    cy.nifiLogin('wrong', 'credentials')
      .should('not.succeed');
    cy.get('.login-error').should('be.visible');
  });
});
----

===== Maven Integration for Self-Tests

The `pom.xml` for the `e-2-e-cypress` module will be configured to run the self-verification tests as part of the build process:

1. Self-tests will run before the actual end-to-end tests
2. Self-tests will use a dedicated Cypress configuration
3. Failed self-tests will fail the build to ensure command integrity
4. Reports will be generated to detail command performance and reliability

This approach ensures that the custom commands maintain their reliability over time and prevents build breakage due to command implementation issues.

==== JavaScript Code Standards and Structure

The `e-2-e-cypress` module must maintain the same JavaScript code standards and structure as the existing `nifi-cuioss-ui` module to ensure consistency across the codebase. This includes:

1. *Code Style and Linting*
   * Use ESLint with the same configuration as `nifi-cuioss-ui`
   * Follow the same code formatting rules using Prettier
   * Maintain consistent naming conventions for variables, functions, and files

2. *Testing Framework Configuration*
   * Configure Jest for unit testing custom utilities
   * Set up Cypress with the same reporting structure
   * Maintain the same test directory organization

3. *Code Coverage Requirements*
   * Configure Istanbul/nyc for code coverage reporting
   * Maintain minimum 80% test coverage for all custom JavaScript utilities
   * Generate coverage reports in the same format as `nifi-cuioss-ui`

4. *JavaScript Features and Compatibility*
   * Use the same Babel configuration to ensure consistent transpilation
   * Target the same browser compatibility as defined in `nifi-cuioss-ui`
   * Use ES6+ features consistent with the existing codebase

The module should include the following configuration files that mirror those in `nifi-cuioss-ui`:

[source]
----
e-2-e-cypress/
â”œâ”€â”€ .eslintrc.js                # ESLint configuration matching nifi-cuioss-ui
â”œâ”€â”€ .prettierrc                 # Prettier configuration
â”œâ”€â”€ babel.config.js             # Babel configuration
â”œâ”€â”€ jest.config.js              # Jest configuration for unit tests
â”œâ”€â”€ cypress.config.js           # Cypress configuration
â””â”€â”€ package.json                # NPM dependencies and scripts
----

===== Integration with Existing Code Standards

To ensure integration with existing code standards:

1. Copy the relevant configuration files from `nifi-cuioss-ui` as a starting point
2. Update paths and module-specific settings as needed
3. Include the same NPM scripts for linting, testing, and coverage reporting
4. Configure the same pre-commit hooks for code quality checks

===== Code Coverage Configuration

The coverage configuration should include:

[source,javascript]
----
// Example jest.config.js for unit tests
module.exports = {
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  // Additional configuration matching nifi-cuioss-ui
};
----

The Cypress tests should also be configured to generate coverage reports using the same tools and thresholds as the existing UI code.

This approach ensures that all JavaScript code, including the end-to-end tests and custom utilities, maintains the same quality standards and consistency across the project.

=== Phase 3: Basic Test Implementation

[cols="1,3,1", options="header"]
|===
|Task |Description |Status

|3.1
|Implement login and navigation helpers
|âœ… Complete

|3.2
|Create processor configuration tests
|âœ… Complete

|3.3
|Implement token verification tests
|âœ… Complete

|3.4
|Create JWKS validation tests
|âœ… Complete

|3.5
|Implement error handling tests
|âœ… Complete
|===

==== Implementation Status

Phase 3 has been completed with comprehensive test implementations:

1. âœ… **Login and Navigation Helpers**: Implemented custom commands for NiFi and Keycloak login, verified with self-tests
2. âœ… **Processor Configuration Tests**: Created end-to-end tests for MultiIssuerJWTTokenAuthenticator configuration scenarios
3. âœ… **Token Verification Tests**: Implemented JWT token validation tests including valid, expired, and malformed tokens
4. âœ… **JWKS Validation Tests**: Added tests for server, file, and in-memory JWKS configurations
5. âœ… **Error Handling Tests**: Created comprehensive error scenario tests for network failures, invalid configurations, and UI edge cases

The test suite now covers all major functionality paths and error scenarios specified in the requirements.

[NOTE]
====
Refer to the link:specification/end-to-end-testing.adoc#_end_to_end_test_scenarios[End-to-End Test Scenarios] section for the required test cases.
====

==== Implementation Steps

1. Implement Cypress custom commands for login and navigation
2. Create basic processor configuration tests
3. Implement token verification tests for valid and invalid tokens
4. Create JWKS validation tests for server, file, and in-memory types
5. Implement error scenario tests for configuration and validation

=== Phase 4: CI/CD Integration

[cols="1,3,1", options="header"]
|===
|Task |Description |Status

|4.1
|Configure Maven integration
|âœ… Complete

|4.2
|Set up GitHub Actions workflow
|âœ… Complete

|4.3
|Configure test reporting
|âœ… Complete

|4.4
|Implement console error analysis in CI
|âœ… Complete

|4.5
|Create documentation for CI process
|âœ… Complete
|===

[NOTE]
====
Refer to the link:specification/end-to-end-testing.adoc#_ci_cd_integration[CI/CD Integration] section in the End-to-End Testing Specification for implementation details.
====

==== Implementation Status

Phase 4 has been completed with a comprehensive GitHub Actions workflow implementation. The CI/CD integration provides:

1. **Maven Integration**: Frontend-maven-plugin configuration with unified properties in root POM
2. **GitHub Actions Workflow**: Complete workflow in `.github/workflows/e2e-tests.yml` with:
   - Frontend quality checks job (linting, unit tests)
   - E2E integration tests job with Docker environment
   - Artifact collection and test reporting
   - Console error analysis on failures
3. **Test Reporting**: JUnit XML reports and HTML artifacts with 30-day retention
4. **Environment Management**: Automated Docker environment startup/shutdown
5. **Error Analysis**: Built-in console error detection and reporting

==== Key Features Implemented

* **Two-stage Pipeline**: Quality checks followed by E2E tests
* **Environment Isolation**: Docker-in-Docker for reliable test environments
* **Comprehensive Caching**: Maven and NPM dependency caching
* **Multi-artifact Collection**: Test results, videos, screenshots, and reports
* **Failure Analysis**: Automatic console error analysis on test failures
* **Clean Shutdown**: Guaranteed environment cleanup with `if: always()`

==== Implementation Steps

1. âœ… Configure Maven plugins for test execution
2. âœ… Create GitHub Actions workflow file
3. âœ… Set up test reporting and artifact collection
4. âœ… Implement console error analysis in the CI pipeline
5. âœ… Document the CI/CD process for team reference

=== Phase 5: Advanced Test Implementation

[cols="1,3,1", options="header"]
|===
|Task |Description |Status

|5.1
|Implement metrics and statistics tests
|âœ… Complete

|5.2
|Create internationalization tests
|âœ… Complete

|5.3
|Implement cross-browser tests
|âœ… Complete

|5.4
|Create accessibility tests
|âœ… Complete

|5.5
|Implement visual testing
|âœ… Complete
|===

[NOTE]
====
Refer to the link:specification/end-to-end-testing.adoc#_accessibility_testing_flow[Accessibility Testing Flow] and link:specification/end-to-end-testing.adoc#_visual_testing[Visual Testing] sections for implementation details.
====

==== Implementation Status

**Phase 5.1: Metrics and Statistics Tests** has been completed with comprehensive test coverage:

1. âœ… **Metrics Display Verification**: Tests verify that processor metrics are correctly displayed in:
   - Processor status indicators on the canvas
   - Processor details pane when selected
   - Configuration dialog metrics tab

2. âœ… **Metrics Functionality Tests**: Validates that metrics are properly updated after token processing:
   - Valid token processing increments success counters
   - Invalid tokens are categorized correctly (malformed, expired, invalid signature, missing claims)
   - Metrics can be reset via the UI reset button

3. âœ… **API Integration Tests**: Verifies metrics accessibility through:
   - REST API endpoints (`/nifi-api/processors/{id}/metrics`)
   - Prometheus-compatible metrics format (`/nifi-api/metrics/prometheus`)
   - Proper JSON structure and data types

4. âœ… **Performance Metrics Tests**: Ensures performance tracking functionality:
   - Average response time calculation and display
   - Issuer-specific metrics for multi-issuer configurations
   - Reasonable response time bounds validation

5. âœ… **Error Metrics Monitoring**: Comprehensive error tracking verification:
   - Recent validation errors are captured and displayed
   - Error categorization is accurate and complete
   - Error breakdown shows correct counts per category

**Test Coverage**: 27 individual test scenarios across 6 test suites
**New Commands**: Added 10 new Cypress commands for processor lifecycle management and metrics testing
**File**: `cypress/e2e/metrics-and-statistics.cy.js`

The metrics testing implementation provides full coverage of the observability requirements (NIFI-AUTH-18) and ensures that all security event monitoring functionality works correctly in the UI.

**Phase 5.2: Internationalization Tests** has been completed with comprehensive i18n testing:

1. âœ… **Language Detection and Switching**: Tests validate browser language detection and manual language switching:
   - Automatic browser language preference detection
   - Manual language switching between English and German
   - Language preference persistence across sessions
   - UI reflection of language changes

2. âœ… **Translation Loading and Fallbacks**: Verifies translation resource management:
   - Translation resource loading for current language
   - Fallback behavior for missing translations
   - Graceful handling of translation loading errors
   - Network error simulation and recovery

3. âœ… **Processor Configuration Labels**: Ensures proper localization of processor properties:
   - Property labels translated in both English and German
   - Property descriptions and help text localization
   - Configuration dialog element translation
   - Form validation message localization

4. âœ… **Error Message Localization**: Validates error message translation:
   - Validation error messages in appropriate language
   - Processor status messages localization
   - Runtime error message translation
   - Context-appropriate error categorization

5. âœ… **Dynamic Content Translation**: Tests dynamically loaded UI elements:
   - Tab labels and section headers translation
   - Context menu items localization
   - Notification message translation
   - Real-time content updates during language switching

6. âœ… **Parameter Substitution**: Verifies advanced i18n features:
   - Parameter substitution in translated messages
   - Pluralization handling for different languages
   - Date and number formatting according to locale
   - Context-sensitive translations with parameters

**Test Coverage**: 27 individual test scenarios across 6 test suites
**New Commands**: Added 25 new Cypress commands for i18n testing and validation
**Files**: 
- `cypress/e2e/internationalization.cy.js` - Main i18n test suite
- `cypress/support/commands/i18n.js` - I18n-specific Cypress commands

The internationalization testing implementation provides complete coverage of the multilingual requirements and ensures that the UI works correctly in both English and German languages with proper fallback mechanisms.

**Phase 5.3: Cross-Browser Tests** has been completed with comprehensive cross-browser compatibility testing:

1. âœ… **Browser Detection and Feature Support**: Tests validate browser capabilities and feature detection:
   - Comprehensive browser information collection (name, version, family, capabilities)
   - JavaScript feature support verification (ES6+, Web APIs, storage)
   - CSS feature support checking (Grid, Flexbox, custom properties)
   - Browser-specific quirk handling for Chromium, Firefox, and WebKit

2. âœ… **JavaScript Engine Compatibility**: Ensures consistent behavior across JavaScript engines:
   - ES6+ feature compatibility testing (arrow functions, classes, destructuring)
   - Asynchronous operation consistency (Promises, async/await, Fetch API)
   - DOM manipulation uniformity across browsers
   - Event handling compatibility and consistency

3. âœ… **CSS Rendering Consistency**: Validates visual consistency across browsers:
   - Layout rendering verification and screenshot comparison
   - Animation and transition behavior testing
   - Font and text rendering consistency checks
   - Z-index and modal layering verification

4. âœ… **Browser-Specific API Usage**: Tests browser API compatibility:
   - Local storage and session storage consistency
   - Cookie handling uniformity across browsers
   - History API and URL manipulation testing
   - Web API feature detection and fallbacks

5. âœ… **Performance Across Browsers**: Measures and validates performance metrics:
   - DOM operation performance measurement
   - Rendering performance benchmarking
   - Network request efficiency testing
   - Memory usage monitoring and validation

6. âœ… **Security Feature Compatibility**: Ensures security consistency:
   - HTTPS handling verification
   - Content Security Policy compliance testing
   - CORS request handling consistency
   - JWT token security validation across browsers

**Test Coverage**: 24 individual test scenarios across 6 test suites
**New Commands**: Added 35+ new Cypress commands for browser compatibility testing
**Files**: 
- `cypress/e2e/cross-browser.cy.js` - Main cross-browser test suite
- `cypress/support/commands/browser.js` - Browser compatibility Cypress commands

The cross-browser testing implementation ensures the processor works consistently across different browsers (Chrome, Firefox, Safari, Edge) with proper feature detection, graceful degradation, and performance optimization.

**Phase 5.4: Accessibility Tests** has been completed with comprehensive WCAG 2.1 AA compliance testing:

1. âœ… **Keyboard Navigation and Focus Management**: Tests validate complete keyboard accessibility:
   - Full keyboard navigation on canvas and through processor elements
   - Tab navigation through configuration dialog forms
   - Focus visibility and proper tab order verification
   - Modal dialog focus trapping and return focus management
   - Keyboard shortcuts and hotkey support

2. âœ… **Screen Reader Compatibility**: Ensures full screen reader support:
   - Proper labels and descriptions for all form controls
   - Dynamic content change announcements with aria-live regions
   - Meaningful error messages accessible to screen readers
   - Processor status information announced appropriately
   - Complex control descriptions and help text associations

3. âœ… **ARIA Attributes and Semantic HTML**: Validates proper markup structure:
   - Semantic HTML elements used appropriately throughout
   - ARIA attributes implemented correctly (roles, properties, states)
   - Landmark regions for navigation and content structure
   - Dynamic ARIA updates for interactive content
   - Proper heading hierarchy and form structure

4. âœ… **Color and Contrast Compliance**: Ensures visual accessibility:
   - WCAG AA color contrast requirements verification
   - Non-color information conveyance (icons, text, borders)
   - High contrast mode support and compatibility
   - Custom color scheme handling (dark mode)

5. âœ… **Responsive Design Accessibility**: Tests accessibility across devices:
   - Accessibility maintained across different viewport sizes
   - Touch accessibility requirements (44px minimum targets)
   - Zoom support up to 200% without horizontal scrolling
   - Mobile and tablet specific accessibility adaptations

6. âœ… **Error Handling and User Feedback**: Validates accessible user interactions:
   - Accessible error messages with proper associations
   - Clear success feedback for completed actions
   - Loading states announced to assistive technologies
   - Helpful guidance for complex configurations

**Test Coverage**: 30+ individual test scenarios across 6 test suites
**New Commands**: Added 40+ new Cypress commands for accessibility testing with axe-core integration
**Files**: 
- `cypress/e2e/accessibility.cy.js` - Main accessibility test suite
- `cypress/support/commands/accessibility.js` - Accessibility testing Cypress commands

The accessibility testing implementation ensures WCAG 2.1 AA compliance and provides comprehensive support for users with disabilities, including keyboard-only navigation, screen reader compatibility, and visual accessibility features.

**Phase 5.5: Visual Testing** has been completed with comprehensive visual regression and consistency testing:

1. âœ… **Visual Regression Testing**: Validates consistent visual appearance:
   - Processor default state visual baselines and regression detection
   - Configuration dialog appearance consistency across changes
   - Property configuration form visual state changes
   - Error state visual representations and indicators

2. âœ… **Component State Visualization**: Tests visual states across interactions:
   - Processor state transitions (STOPPED, RUNNING, ERROR)
   - Selection, hover, and focus state visual validation
   - Context menu visual appearance and item hover states
   - Loading and processing state visual feedback

3. âœ… **Layout and Positioning Verification**: Ensures consistent layout:
   - Processor positioning and alignment on canvas
   - Configuration dialog layout and spacing validation
   - Form element alignment and label positioning
   - Button layout and spacing consistency

4. âœ… **Animation and Transition Testing**: Validates smooth interactions:
   - Processor state transition animations
   - Dialog opening and closing animation consistency
   - Hover and focus transition effects
   - Loading spinner and progress animation validation

5. âœ… **Theme and Style Consistency**: Ensures design system compliance:
   - Consistent styling across all components
   - Dark theme compatibility testing
   - High contrast theme support validation
   - Brand consistency and styling guideline adherence

6. âœ… **Cross-Resolution Visual Testing**: Tests visual consistency across devices:
   - Multiple screen resolution validation (1080p, WXGA, XGA, tablet, mobile)
   - Zoom level visual consistency (75% to 200%)
   - Pixel density handling for high-DPI displays
   - Visual regression detection across different environments

**Test Coverage**: 35+ individual test scenarios across 6 test suites
**New Commands**: Added 45+ new Cypress commands for visual testing and screenshot comparison
**Files**: 
- `cypress/e2e/visual-testing.cy.js` - Main visual testing suite
- `cypress/support/commands/visual.js` - Visual testing Cypress commands

The visual testing implementation provides pixel-perfect validation, visual regression detection, and ensures consistent user experience across different browsers, devices, and themes.

==== Implementation Steps

1. Create metrics display and verification tests
2. Implement internationalization tests with language switching
3. Extend tests with browser-specific handling
4. Add accessibility testing with axe-core
5. Implement visual comparison tests with screenshots

== Test Code Structure

Refer to the link:specification/end-to-end-testing.adoc#_test_code_structure[Test Code Structure] section in the End-to-End Testing Specification for detailed information about the test code organization.

== Console Error Verification Implementation

Follow these steps to implement the console error verification system:

1. Create the allowlist file:

[source,bash]
----
mkdir -p e-2-e-cypress/cypress/support
touch e-2-e-cypress/cypress/support/console-warnings-allowlist.js
----

2. Implement the allowlist with initial known warnings:

[source,javascript]
----
// Add only warnings that cannot be fixed
module.exports = [
  'Warning: validateDOMNesting(...): <div> cannot appear as a descendant of <p>.',
  'DevTools failed to load source map',
  'Content Security Policy violation for inline script'
];
----

3. Implement console error tracking in Cypress:

[source,bash]
----
touch e-2-e-cypress/cypress/support/console-error-tracking.js
----

4. Add the console error tracking implementation as specified in the link:specification/end-to-end-testing.adoc#_console_error_verification[Console Error Verification] section.

== Maven Integration

To integrate with Maven, follow these steps:

1. Configure the `frontend-maven-plugin` in the `e-2-e-cypress/pom.xml` file
2. Add the necessary NPM scripts to `package.json`
3. Configure the Maven Failsafe plugin for integration testing
4. Set up system properties for test environment URLs

=== Maven Configuration for Self-Verification Tests

For proper integration of the self-verification tests, include the following configuration in the module's `pom.xml`:

[source,xml]
----
<plugin>
  <groupId>com.github.eirslett</groupId>
  <artifactId>frontend-maven-plugin</artifactId>
  <executions>
    <!-- Standard npm and node setup -->
    <execution>
      <id>install-node-and-npm</id>
      <!-- ... -->
    </execution>
    <!-- Run self-verification tests first -->
    <execution>
      <id>cypress-selftests</id>
      <goals>
        <goal>npm</goal>
      </goals>
      <phase>pre-integration-test</phase>
      <configuration>
        <arguments>run cypress:selftests</arguments>
        <environmentVariables>
          <CYPRESS_BASE_URL>https://localhost:8443/nifi</CYPRESS_BASE_URL>
          <CYPRESS_KEYCLOAK_URL>https://localhost:8443/auth</CYPRESS_KEYCLOAK_URL>
        </environmentVariables>
        <failOnError>true</failOnError>
      </configuration>
    </execution>
    <!-- Run actual E2E tests only if self-tests pass -->
    <execution>
      <id>cypress-e2e</id>
      <goals>
        <goal>npm</goal>
      </goals>
      <phase>integration-test</phase>
      <configuration>
        <arguments>run cypress:run</arguments>
        <!-- ... -->
      </configuration>
    </execution>
  </executions>
</plugin>
----

The corresponding NPM scripts in `package.json`:

[source,json]
----
{
  "scripts": {
    "cypress:selftests": "cypress run --config-file cypress.selftests.config.js",
    "cypress:run": "cypress run",
    "cypress:open": "cypress open"
  }
}
----

With a special self-tests configuration file (`cypress.selftests.config.js`):

[source,javascript]
----
const { defineConfig } = require('cypress');

module.exports = defineConfig({
  e2e: {
    specPattern: 'cypress/selftests/**/*.cy.js',
    supportFile: 'cypress/support/e2e.js',
    // Set shorter timeouts for self-tests as they should be fast
    defaultCommandTimeout: 5000,
    video: false,
    // Generate a separate report for self-tests
    reporter: 'junit',
    reporterOptions: {
      mochaFile: 'tests-report/selftests-[hash].xml',
      toConsole: true
    }
  }
});
----

Refer to the link:specification/end-to-end-testing.adoc#_maven_integration[Maven Integration] section for additional configuration examples.

== CI/CD Integration

For CI/CD integration with GitHub Actions:

1. Create a workflow file at \`.github/workflows/e2e-tests.yml\`
2. Configure the workflow to set up Node.js and Java
3. Add steps to start the test environment
4. Configure Cypress test execution
5. Add steps for console error analysis
6. Configure artifact upload for test results

Refer to the link:specification/end-to-end-testing.adoc#_ci_cd_integration[CI/CD Integration] section for workflow configuration examples.

== Monitoring and Maintenance

After implementation, establish a maintenance process:

1. Schedule regular reviews of the allowed warnings list
2. Monitor test stability and flakiness
3. Update tests when the UI changes
4. Regularly update test data and fixtures
5. Review console error analysis reports for trends

Refer to the link:specification/end-to-end-testing.adoc#_test_maintenance[Test Maintenance] section for best practices.

== References

* link:specification/end-to-end-testing.adoc[End-to-End Testing Specification]
* link:specification/configuration-ui.adoc[UI Configuration Specification]
* link:specification/token-validation.adoc[Token Validation Specification]
* link:Requirements.adoc#NIFI-AUTH-16[Testing Requirements]
* link:library/cui-test-keycloak-integration/README.adoc[Keycloak Integration Testing]
* link:integration-testing/README.adoc[Integration Testing Environment]
