= NiFi Docker Test Environment
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

== Overview

This document describes the Docker-based test environment for the MultiIssuerJWTTokenAuthenticator NiFi processor. The test environment provides a containerized NiFi instance with the processor installed, allowing for easy testing and validation of the processor's functionality.

== Prerequisites

To use the Docker test environment, you need to have the following installed:

* Docker
* Docker Compose
* curl (for the helper scripts)
* Maven (or use the included Maven wrapper)

== Test Environment Structure

The test environment consists of the following components:

=== Docker Configuration

The Docker configuration is located in the `nifi-cuioss-processors/src/test/docker` directory and includes:

* `Dockerfile`: Defines the NiFi container with the necessary configuration
* `docker-compose.yml`: Configures the Docker container, including port mappings and volume mounts
* Helper scripts:
** `run-test-container.sh`: Builds the NAR file and starts the Docker container
** `stop-test-container.sh`: Stops and removes the Docker container

=== NiFi Configuration

The NiFi container is configured with:

* HTTPS enabled on port 8443
* A default user for login (username: admin, password: ctsBtRBKHRAx69EqUghvvgEvjnaLjFEB)
* The MultiIssuerJWTTokenAuthenticator processor installed via a volume mount

== Using the Test Environment

=== Starting the Test Environment

To start the test environment:

1. Navigate to the project root directory
2. Run the helper script:

[source,bash]
----
./nifi-cuioss-processors/src/test/docker/run-test-container.sh
----

This script will:

1. Build the NAR file using Maven
2. Start the Docker container using Docker Compose
3. Wait for NiFi to start
4. Display information about how to access the NiFi UI

=== Accessing the NiFi UI

Once the container is running, you can access the NiFi UI at:

[source]
----
https://localhost:8443/nifi/
----

Login with the following credentials:

* Username: admin
* Password: ctsBtRBKHRAx69EqUghvvgEvjnaLjFEB

NOTE: Your browser may warn about an untrusted certificate. This is expected as the container uses a self-signed certificate. You can safely proceed.

=== Testing the Processor

To test the MultiIssuerJWTTokenAuthenticator processor:

1. Drag the processor onto the canvas
2. Configure the processor with the necessary properties
3. Connect it to other processors as needed
4. Start the flow and observe the results

=== Stopping the Test Environment

To stop the test environment:

1. Navigate to the project root directory
2. Run the helper script:

[source,bash]
----
./nifi-cuioss-processors/src/test/docker/stop-test-container.sh
----

This script will stop and remove the Docker container.

== Troubleshooting

=== Container Fails to Start

If the container fails to start, check the Docker logs:

[source,bash]
----
docker-compose -f nifi-cuioss-processors/src/test/docker/docker-compose.yml logs
----

=== NAR File Not Found

If the NAR file is not found, ensure that the build process completed successfully:

[source,bash]
----
./mvnw clean package -DskipTests
----

=== Cannot Access NiFi UI

If you cannot access the NiFi UI:

1. Check that the container is running:

[source,bash]
----
docker ps | grep nifi
----

2. Check the container logs for any errors:

[source,bash]
----
docker-compose -f nifi-cuioss-processors/src/test/docker/docker-compose.yml logs
----

3. Ensure that port 8443 is not being used by another application.

== Development Workflow

For development and testing:

1. Make changes to the processor code
2. Build the NAR file:

[source,bash]
----
./mvnw clean package -DskipTests
----

3. The changes will be automatically available in the running container due to the volume mount

If you need to restart the container:

[source,bash]
----
./nifi-cuioss-processors/src/test/docker/stop-test-container.sh
./nifi-cuioss-processors/src/test/docker/run-test-container.sh
----

== See Also

* link:Specification.adoc[Main Specification]
* link:Requirements.adoc[Requirements]
* link:specification/testing.adoc[Testing Specification]
* link:plan.adoc[Implementation Plan]