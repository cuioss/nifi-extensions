services:
  nifi:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "9094:9094"
    environment:
      - NIFI_WEB_HTTP_PORT=9094
      - NIFI_WEB_HTTP_HOST=0.0.0.0
      - NIFI_WEB_HTTPS_PORT=
      - NIFI_WEB_HTTPS_HOST=
      - NIFI_REMOTE_INPUT_SECURE=false
      - NIFI_REMOTE_INPUT_HTTP_ENABLED=false
      - NIFI_CLUSTER_PROTOCOL_IS_SECURE=false
      - NIFI_HOME=/opt/nifi/nifi-current
      - NIFI_LOG_DIR=/opt/nifi/nifi-current/logs
      - NIFI_BOOTSTRAP_CONF=/opt/nifi/nifi-current/conf/bootstrap.conf
      - NIFI_CONF_DIR=/opt/nifi/nifi-current/conf
    volumes:
      - ../../../target/nifi-deploy:/opt/nifi/nifi-current/nar_extensions
      - ./nifi/conf:/opt/nifi/nifi-current/conf
    healthcheck:
      test: ["CMD", "curl", "--fail", "--retry", "5", "--retry-delay", "10", "--max-time", "15", "http://localhost:9094/nifi/"]
      interval: 60s
      timeout: 30s
      retries: 10
    networks:
      - nifi-keycloak-network

  # Uncomment below for HTTPS NiFi (comment out the HTTP nifi service above)
  # nifi-https:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   ports:
  #     - "9095:9095"
  #   environment:
  #     - NIFI_WEB_HTTP_PORT=
  #     - NIFI_WEB_HTTP_HOST=
  #     - NIFI_WEB_HTTPS_PORT=9095
  #     - NIFI_WEB_HTTPS_HOST=0.0.0.0
  #     - NIFI_REMOTE_INPUT_SECURE=true
  #     - NIFI_REMOTE_INPUT_HTTP_ENABLED=false
  #     - NIFI_CLUSTER_PROTOCOL_IS_SECURE=true
  #     - NIFI_HOME=/opt/nifi/nifi-current
  #     - NIFI_LOG_DIR=/opt/nifi/nifi-current/logs
  #     - NIFI_BOOTSTRAP_CONF=/opt/nifi/nifi-current/conf/bootstrap.conf
  #     - NIFI_CONF_DIR=/opt/nifi/nifi-current/conf
  #   volumes:
  #     - ../../../target/nifi-deploy:/opt/nifi/nifi-current/nar_extensions
  #     - ./nifi/conf:/opt/nifi/nifi-current/conf
  #     - ./certificates:/opt/nifi/nifi-current/conf/certs
  #   healthcheck:
  #     test: ["CMD", "curl", "-k", "--fail", "--retry", "5", "--retry-delay", "10", "--max-time", "15", "https://localhost:9095/nifi/"]
  #     interval: 60s
  #     timeout: 30s
  #     retries: 10
  #   networks:
  #     - nifi-keycloak-network

  keycloak:
    image: quay.io/keycloak/keycloak:26.0.1
    ports:
      - "9080:8080"
      - "9085:8443"
      - "9086:9000"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HEALTH_ENABLED=true
      - KC_DB=dev-mem
      - KC_HTTPS_CERTIFICATE_FILE=/opt/keycloak/data/import/certificates/localhost.crt
      - KC_HTTPS_CERTIFICATE_KEY_FILE=/opt/keycloak/data/import/certificates/localhost.key
    volumes:
      - ./keycloak:/opt/keycloak/data/import
    command: 
      - start-dev
      - --import-realm
      - --https-certificate-file=/opt/keycloak/data/import/certificates/localhost.crt
      - --https-certificate-key-file=/opt/keycloak/data/import/certificates/localhost.key
    healthcheck:
      test: ["CMD", "curl", "-k", "--fail", "--max-time", "10", "http://localhost:8080/health"]
      interval: 30s
      timeout: 15s
      retries: 10
    networks:
      - nifi-keycloak-network

networks:
  nifi-keycloak-network:
    driver: bridge
