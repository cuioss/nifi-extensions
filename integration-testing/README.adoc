= NiFi Docker Test Environment
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

Docker-based test environment for the MultiIssuerJWTTokenAuthenticator NiFi processor.
Provides containerized NiFi (HTTPS) and Keycloak instances for testing with real JWT tokens.

== Prerequisites

* Docker with Compose plugin (`docker compose`)
* curl (for health check scripts)
* Maven (or use the included `./mvnw` wrapper)

== Quick Start

[source,bash]
----
# 1. Build NAR and start containers (Keycloak + NiFi)
./integration-testing/src/main/docker/run-and-deploy.sh

# 2. Access services
#    NiFi UI:       https://localhost:9095/nifi/  (testUser / drowssap)
#    Keycloak HTTP:  http://localhost:9080/admin/  (admin / admin)
#    Keycloak HTTPS: https://localhost:9085/admin/ (admin / admin)

# 3. Stop containers
./integration-testing/src/main/docker/stop-test-container.sh
----

== Service Configuration

=== NiFi

[cols="1,2"]
|===
|Setting |Value

|URL
|`https://localhost:9095/nifi/`

|API
|`https://localhost:9095/nifi-api/`

|Protocol
|HTTPS (self-signed certificate, port 8443 internal -> 9095 host)

|Authentication
|SingleUserLoginIdentityProvider

|Credentials
|`testUser` / `drowssap`

|Base image
|`apache/nifi:2.7.2`

|NAR mount
|`target/nifi-deploy/` -> `/opt/nifi/nifi-current/nar_extensions`
|===

Custom configuration files are copied from `src/main/docker/nifi/conf/` into the container at build time.

=== Keycloak

[cols="1,2"]
|===
|Setting |Value

|HTTP Admin
|`http://localhost:9080` (port 8080 internal)

|HTTPS
|`https://localhost:9085` (port 8443 internal)

|Health endpoint
|`http://localhost:9086/health/ready` (port 9000 internal)

|Admin credentials
|`admin` / `admin`

|Image
|`quay.io/keycloak/keycloak:26.2.5`

|Database
|In-memory (`KC_DB=dev-mem`)
|===

==== Pre-configured Realm: `oauth_integration_tests`

[cols="1,2"]
|===
|Setting |Value

|Test users
|`testUser` / `drowssap` (roles: `user`, `read`), `limitedUser` / `drowssap` (roles: `user`)

|Test client ID
|`test_client`

|Client secret
|`yTKslWLtf4giJcWCaoVJ20H8sy6STexM`

|JWKS endpoint (from host)
|`http://localhost:9080/realms/oauth_integration_tests/protocol/openid-connect/certs`

|JWKS endpoint (container-to-container)
|`http://keycloak:8080/realms/oauth_integration_tests/protocol/openid-connect/certs`
|===

The realm is imported automatically from `src/main/docker/keycloak/oauth_integration_tests-realm.json`.

==== Pre-configured Realm: `other_realm`

Separate realm with its own RSA key pair, used for invalid-signature testing.

[cols="1,2"]
|===
|Setting |Value

|Test user
|`otherUser` / `drowssap` (roles: `user`)

|Test client ID
|`other_client`

|Client secret
|`otherClientSecretValue123456789`

|JWKS endpoint (from host)
|`http://localhost:9080/realms/other_realm/protocol/openid-connect/certs`
|===

The realm is imported automatically from `src/main/docker/keycloak/other_realm-realm.json`.

== Scripts

All scripts are in `src/main/docker/`. They can be run from any directory.

=== Lifecycle Scripts

[cols="1,3"]
|===
|Script |Description

|`run-and-deploy.sh`
|Full startup: builds NAR (`mvnw package`), copies to deploy dir, starts Keycloak (with health wait), starts NiFi (with health wait)

|`start-nifi.sh`
|Starts Keycloak first, then NiFi. Waits for both to be healthy (2-minute timeout). Does NOT build/deploy the NAR.

|`start-keycloak.sh`
|Starts Keycloak only and waits for health check via `http://localhost:9086/health/ready` (60-second timeout)

|`stop-test-container.sh`
|Runs `docker compose down` to stop and remove all containers

|`redeploy-nifi.sh`
|Rebuilds NAR, copies to deploy dir, restarts NiFi container (`docker compose restart nifi`)

|`copy-deployment.sh`
|Builds NAR with `./mvnw package -DskipTests -pl '!e-2-e-playwright'` and copies to `target/nifi-deploy/`
|===

=== Diagnostic Scripts

[cols="1,3"]
|===
|Script |Description

|`check-status.sh`
|Fast health check of Docker containers and HTTP endpoints. Supports `--timeout`, `--quiet`, `--verbose` flags.

|`debug-containers.sh`
|Prints Docker system info, container status, logs, and resource usage

|`debug-nar-deployment.sh`
|Checks NAR file existence and deployment status in both host and container
|===

=== Maintenance Scripts (in `maintenance/`)

[cols="1,3"]
|===
|Script |Description

|`generate-certificates.sh`
|Generates self-signed certificates for NiFi (PKCS12) and Keycloak (PEM)

|`verify-certificates.sh`
|Validates certificate files and their usage

|`verify-login.sh`
|Tests NiFi authentication flow

|`setup-credentials.sh`
|Sets NiFi SingleUser credentials via `nifi.sh set-single-user-credentials`
|===

== Directory Structure

[source]
----
src/main/docker/
├── Dockerfile                     # NiFi container (based on apache/nifi:2.7.2)
├── docker-compose.yml             # NiFi + Keycloak orchestration
├── certificates/                  # Generated TLS certificates
│   ├── keystore.p12              #   NiFi keystore
│   ├── truststore.p12            #   NiFi truststore
│   ├── localhost.crt             #   Keycloak certificate
│   └── localhost.key             #   Keycloak private key
├── nifi/conf/                     # NiFi configuration (copied into container)
│   ├── nifi.properties           #   Main config (HTTPS on 8443)
│   ├── login-identity-providers.xml  # SingleUser: testUser/drowssap
│   ├── authorizers.xml           #   SingleUser authorizer
│   ├── keystore.p12 / truststore.p12 # TLS keystores
│   ├── flow.xml.gz               #   Pre-configured flow
│   └── bootstrap.conf / logback.xml / state-management.xml
├── keycloak/
│   ├── oauth_integration_tests-realm.json  # Primary realm import
│   └── other_realm-realm.json              # Secondary realm (signature testing)
├── maintenance/                   # Certificate and credential utilities
├── run-and-deploy.sh             # Full build + start
├── start-nifi.sh                 # Start Keycloak + NiFi
├── start-keycloak.sh             # Start Keycloak only
├── stop-test-container.sh        # Stop all containers
├── redeploy-nifi.sh              # Rebuild + restart NiFi
├── copy-deployment.sh            # Build + copy NAR
├── check-status.sh               # Health check
├── debug-containers.sh           # Container diagnostics
└── debug-nar-deployment.sh       # NAR deployment diagnostics
----

== Development Workflow

=== Initial Setup

[source,bash]
----
# Build NAR and start everything
./integration-testing/src/main/docker/run-and-deploy.sh
----

=== Code Change Cycle

[source,bash]
----
# After modifying processor code or UI:
./integration-testing/src/main/docker/redeploy-nifi.sh
----

This rebuilds the NAR, copies it to the deploy directory, and restarts the NiFi container.

=== Testing the Processor

1. Open NiFi at https://localhost:9095/nifi/ and log in with `testUser` / `drowssap`
2. Drag a processor onto the canvas, search for `MultiIssuerJWTTokenAuthenticator`
3. Configure the JWKS URL: `http://keycloak:8080/realms/oauth_integration_tests/protocol/openid-connect/certs`
4. Obtain a test token from Keycloak:
+
[source,bash]
----
curl -s -X POST http://localhost:9080/realms/oauth_integration_tests/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'grant_type=password&client_id=test_client&client_secret=yTKslWLtf4giJcWCaoVJ20H8sy6STexM&username=testUser&password=drowssap'
----

== Certificate Configuration

Self-signed certificates for localhost with 1-year validity:

* *NiFi*: PKCS12 format (`keystore.p12`, `truststore.p12`), password: `password`
* *Keycloak*: PEM format (`localhost.crt`, `localhost.key`)

Certificates are checked into the repository. Regenerate if needed:

[source,bash]
----
./integration-testing/src/main/docker/maintenance/generate-certificates.sh
----

== Troubleshooting

=== Check Service Status

[source,bash]
----
# Quick health check
./integration-testing/src/main/docker/check-status.sh

# Container status
docker compose -f integration-testing/src/main/docker/docker-compose.yml ps
----

=== View Logs

[source,bash]
----
# NiFi logs
docker compose -f integration-testing/src/main/docker/docker-compose.yml logs nifi

# Follow NiFi application log
docker compose -f integration-testing/src/main/docker/docker-compose.yml exec nifi \
  tail -f /opt/nifi/nifi-current/logs/nifi-app.log

# Keycloak logs
docker compose -f integration-testing/src/main/docker/docker-compose.yml logs keycloak
----

=== Common Issues

[cols="1,2"]
|===
|Issue |Resolution

|Port conflict on 9080, 9085, 9086, or 9095
|Stop other services using those ports, or check with `lsof -i :9095`

|NiFi fails to start
|Check logs; ensure certificates exist in `nifi/conf/`; run `debug-containers.sh`

|Keycloak health check fails
|Verify port 9086 is reachable: `curl http://localhost:9086/health/ready`

|NAR not loaded
|Run `debug-nar-deployment.sh`; verify `target/nifi-deploy/` contains the NAR file

|Certificate errors in browser
|Expected with self-signed certs — accept the warning. Regenerate with `maintenance/generate-certificates.sh` if expired.
|===

== See Also

* link:../doc/Specification.adoc[Specification]
* link:../doc/Requirements.adoc[Requirements]
* link:../doc/specification/testing.adoc[Testing Specification]
* link:../doc/specification/integration-testing.adoc[Integration Testing — Flow Pipeline Design]
* link:../doc/library/cui-test-keycloak-integration/README.adoc[Keycloak Integration]
* link:../e-2-e-playwright/README.adoc[E2E Playwright Tests]
