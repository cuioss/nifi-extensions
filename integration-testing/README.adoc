= NiFi Docker Test Environment
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

== Overview

This document describes the Docker-based test environment for the MultiIssuerJWTTokenAuthenticator NiFi processor. The environment provides containerized NiFi and Keycloak instances for testing and validating the processor with real JWT tokens.

== Prerequisites

* Docker
* Docker Compose
* curl (for helper scripts)
* Maven (or use the included Maven wrapper)

== Quick Start

1. Generate certificates (first time only, they are actually checked-in):
+
[source,bash]
----
cd integration-testing/src/main/docker
./maintenance/generate-certificates.sh
cd ../../..
----

2. Start the environment:
+
[source,bash]
----
./integration-testing/src/main/docker/start-nifi.sh
----

3. Access services:
* NiFi UI: https://localhost:9095/nifi/ (admin/adminadminadmin)
* Keycloak Admin HTTP: http://localhost:9080/admin/ (admin/admin)
* Keycloak Admin HTTPS: https://localhost:9085/admin/ (admin/admin)

4. Stop the environment:
+
[source,bash]
----
docker compose down
----

== Environment Components

=== Docker Configuration

Located in `src/main/docker`:

* `Dockerfile`: NiFi container configuration
* `docker-compose.yml`: Container orchestration with HTTP NiFi (HTTPS variant available as comments)
* Helper scripts:
** `start-nifi.sh`: Starts containers and waits for services to be ready
** `stop-test-container.sh`: Stops and removes containers
** `copy-deployment.sh`: Builds NAR and copies to deployment location
** `redeploy-nifi.sh`: Builds NAR, copies to deployment location, and restarts NiFi
* Maintenance scripts (in `maintenance/`):
** `generate-certificates.sh`: Creates certificates for NiFi and Keycloak
** `verify-certificates.sh`: Validates certificate usage
** `verify-login.sh`: Tests NiFi authentication
** `setup-credentials.sh`: Sets up NiFi credentials

=== NiFi Configuration

* HTTP on port 9094 (optimized for testing and development)
* Authentication with SingleUserLoginIdentityProvider
* Credentials: admin/adminadminadmin
* MultiIssuerJWTTokenAuthenticator processor mounted via volume
* Configuration files in `src/main/docker/nifi/conf/`

=== Keycloak Configuration

* HTTP on port 9080, HTTPS on port 9085
* Admin credentials: admin/admin
* Pre-configured realm (`oauth_integration_tests`) with:
** Test user: testUser/drowssap
** Test client: test_client/yTKslWLtf4giJcWCaoVJ20H8sy6STexM

=== Certificate Configuration

* Self-signed certificate for localhost (1 year validity)
* Generated by `maintenance/generate-certificates.sh`
* NiFi: PKCS12 format (keystore.p12, truststore.p12)
* Keycloak: PEM format (localhost.crt, localhost.key)

=== Storage Configuration

* Ephemeral storage for most data
* Only NiFi configuration and NAR deployment preserved between restarts
* Keycloak uses in-memory database

== Using HTTPS for NiFi

If you need HTTPS for production-like testing or security requirements:

1. Edit `docker-compose.yml`:
   * Comment out the `nifi` service (lines with HTTP configuration)
   * Uncomment the `nifi-https` service (remove `#` from those lines)

2. Update the service name in scripts if needed:
+
[source,bash]
----
# Change docker compose commands from 'nifi' to 'nifi-https'
docker compose logs nifi-https
docker compose restart nifi-https
----

3. Access NiFi via HTTPS:
   * NiFi UI: https://localhost:9095/nifi/ (admin/adminadminadmin)
   * Accept the self-signed certificate in your browser

4. Update JWKS URLs in processor configuration:
   * Use HTTPS Keycloak endpoint: `https://keycloak:9085/realms/oauth_integration_tests/protocol/openid-connect/certs`

=== HTTPS Configuration Details

* HTTPS on port 9095
* Self-signed certificates (suitable for testing)
* All SSL/TLS security features enabled
* Certificate files mounted from `./certificates/` directory

== Testing the Processor

1. Drag the processor onto the NiFi canvas
2. Configure the JWKS URL:
   * For HTTP NiFi: `http://keycloak:9080/realms/oauth_integration_tests/protocol/openid-connect/certs`
   * For HTTPS NiFi: `https://keycloak:9085/realms/oauth_integration_tests/protocol/openid-connect/certs`
3. Obtain a token from Keycloak:
+
[source,bash]
----
curl -X POST \
  http://localhost:9080/realms/oauth_integration_tests/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'grant_type=password&client_id=test_client&client_secret=yTKslWLtf4giJcWCaoVJ20H8sy6STexM&username=testUser&password=drowssap'
----
4. Use the token in your NiFi flow
5. Start the flow and observe results

== Development Workflow

1. Make changes to processor code
2. Build the NAR file:
+
[source,bash]
----
./mvnw clean package -DskipTests
----
3. Changes are automatically available in the running container

== Troubleshooting

=== Container Issues

* Check container status: `docker ps | grep nifi` or `docker ps | grep keycloak`
* View logs: `docker compose logs nifi`
* Ensure ports 9080, 9085, and 9094 are available

=== Certificate Issues

* Verify certificates: `./integration-testing/src/main/docker/maintenance/verify-certificates.sh`
* Ensure OpenSSL is installed: `which openssl && openssl version`
* Regenerate certificates if needed

=== Viewing Logs

[source,bash]
----
# View application log
docker compose exec nifi cat /opt/nifi/nifi-current/logs/nifi-app.log

# Follow logs
docker compose exec nifi tail -f /opt/nifi/nifi-current/logs/nifi-app.log
----

== See Also

* link:../doc/Specification.adoc[Main Specification]
* link:../doc/Requirements.adoc[Requirements]
* link:../doc/specification/testing.adoc[Testing Specification]
* link:../doc/plan.adoc[Implementation Plan]
* link:../doc/library/cui-test-keycloak-integration/README.adoc[Keycloak Integration]
