= NiFi Docker Test Environment
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

== Overview

This document describes the Docker-based test environment for the MultiIssuerJWTTokenAuthenticator NiFi processor. The test environment provides containerized NiFi and Keycloak instances, allowing for easy testing and validation of the processor's functionality with real JWT tokens.

== Prerequisites

To use the Docker test environment, you need to have the following installed:

* Docker
* Docker Compose
* curl (for the helper scripts)
* Maven (or use the included Maven wrapper)

== Test Environment Structure

The test environment consists of the following components:

=== Docker Configuration

The Docker configuration is located in the `src/main/docker` directory and includes:

* `Dockerfile`: Defines the NiFi container with the necessary configuration
* `docker-compose.yml`: Configures the Docker containers, including port mappings, volume mounts, and networking
* Helper scripts:
** `run-test-container.sh`: Creates necessary directories, builds the NAR file, checks for required certificates, and starts the Docker containers
** `stop-test-container.sh`: Stops and removes the Docker containers
** `generate-certificates.sh`: Generates a local certificate for localhost that is used by both NiFi and Keycloak
** `verify-certificates.sh`: Verifies that both NiFi and Keycloak are using the generated certificates
* NiFi configuration:
** `nifi/conf/`: Directory containing NiFi configuration files
*** `nifi.properties`: Main NiFi configuration file
*** `authorizers.xml`: Defines how users are authorized
*** `bootstrap.conf`: Configuration for the bootstrap process
*** `logback.xml`: Logging configuration
*** `login-identity-providers.xml`: Defines how users authenticate
*** `state-management.xml`: Defines how state is managed
* Keycloak configuration:
** `keycloak/oauth_integration_tests-realm.json`: Realm configuration for Keycloak

=== NiFi Configuration

The NiFi container is configured with:

* HTTPS enabled on port 9095
* A default user for login (username: admin, password: adminadminadmin)
* The MultiIssuerJWTTokenAuthenticator processor installed via a volume mount
* Custom configuration files mounted from `src/main/docker/nifi/conf/` to `/opt/nifi/nifi-current/conf/` in the container

==== Configuration Files

The following configuration files are provided:

* `nifi.properties`: The main configuration file for NiFi. It defines core properties, repository locations, web server settings, security settings, and more.
* `authorizers.xml`: Defines how users are authorized in NiFi. For the test environment, we use the single-user-authorizer.
* `bootstrap.conf`: Configuration for the bootstrap process, including JVM settings and memory allocation.
* `logback.xml`: Logging configuration, including log levels, appenders, and log file locations.
* `login-identity-providers.xml`: Defines how users authenticate in NiFi. For the test environment, we use the single-user-provider with the admin user.
* `state-management.xml`: Defines how state is managed in NiFi, including local and cluster state providers.

==== Customizing the Configuration

To customize the NiFi configuration:

1. Modify the files in the `src/main/docker/nifi/conf/` directory
2. Restart the containers using the helper scripts:

[source,bash]
----
./integration-testing/src/main/docker/stop-test-container.sh
./integration-testing/src/main/docker/run-test-container.sh
----

Common customizations include:

* Changing memory settings in `bootstrap.conf`
* Adjusting log levels in `logback.xml`
* Modifying security settings in `nifi.properties`
* Adding or changing users in `login-identity-providers.xml`

=== Keycloak Configuration

The Keycloak container is configured with:

* HTTP enabled on port 9080
* HTTPS enabled on port 9085 (using the same certificate as NiFi)
* Admin console access (username: admin, password: admin)
* A pre-configured realm (`oauth_integration_tests`) with:
** A test user (username: testUser, password: drowssap)
** A test client (client ID: test_client, client secret: yTKslWLtf4giJcWCaoVJ20H8sy6STexM)

=== Certificate Configuration

Both NiFi and Keycloak use the same locally generated certificate for HTTPS:

* The certificate is generated by the `generate-certificates.sh` script
* It's a self-signed certificate for localhost with a validity period of 1 year
* For NiFi, the certificate is stored in PKCS12 format (keystore.p12 and truststore.p12)
* For Keycloak, the certificate is exported to PEM format (localhost.crt and localhost.key)
* The certificate must be manually generated by running `generate-certificates.sh` before starting the containers
* You can verify the certificate usage with `verify-certificates.sh`

==== Manual Certificate Generation

Before starting the containers, you must manually generate the certificates:

1. Navigate to the Docker directory:
+
[source,bash]
----
cd integration-testing/src/main/docker
----

2. Run the certificate generation script:
+
[source,bash]
----
./generate-certificates.sh
----

3. Verify that the certificates were generated correctly:
+
[source,bash]
----
ls -la certificates/
ls -la nifi/conf/keystore.p12 nifi/conf/truststore.p12
ls -la keycloak/certificates/
----

The certificates are valid for 1 year from the date of generation. You will need to regenerate them when they expire.

=== Persistent Storage

The test environment is configured with minimal persistent storage. Only the NiFi configuration and NAR deployment are preserved between container restarts, simplifying the setup and reducing resource usage.

==== NiFi Persistent Storage

NiFi does not use persistent storage for logs or repositories. Only the configuration files and NAR deployment are mounted from the host:

* `nifi/conf/`: Configuration files mounted from the host to the container
* `../../../target/nifi-deploy`: NAR files mounted from the host to the container's lib directory

NOTE: Since logs are not persisted, you'll need to view them while the container is running:

[source,bash]
----
docker compose exec nifi ls -la /opt/nifi/nifi-current/logs
docker compose exec nifi cat /opt/nifi/nifi-current/logs/nifi-app.log
----

==== Keycloak Persistent Storage

Keycloak uses an in-memory database (`dev-mem`) and does not persist any data between container restarts. This simplifies the setup and avoids permission issues with file-based storage. Only the realm import files are mounted from the host.

== Using the Test Environment

=== Starting the Test Environment

To start the test environment:

1. Navigate to the project root directory
2. First, manually generate the certificates:

[source,bash]
----
cd integration-testing/src/main/docker
./generate-certificates.sh
cd ../../..
----

3. Run the run-test-container script:

[source,bash]
----
./integration-testing/src/main/docker/run-test-container.sh
----

The run-test-container script will:

1. Build the NAR file using Maven
2. Check that the required certificates exist
3. Ensure all necessary directories exist with appropriate permissions
4. Start the Docker containers using Docker Compose
5. Wait for NiFi and Keycloak to start
6. Display information about how to access the NiFi UI and Keycloak Admin Console

After the containers are running, you can verify that both NiFi and Keycloak are using the generated certificates:

[source,bash]
----
./integration-testing/src/main/docker/verify-certificates.sh
----


The containers use ephemeral storage for most data, with only the NiFi configuration and NAR deployment preserved between container restarts. This simplifies the setup and reduces resource usage.

=== Accessing the NiFi UI

Once the containers are running, you can access the NiFi UI at:

[source]
----
https://localhost:9095/nifi/
----

Login with the following credentials:

* Username: admin
* Password: adminadminadmin

NOTE: Your browser may warn about an untrusted certificate. This is expected as the container uses a self-signed certificate. You can safely proceed.

=== Accessing the Keycloak Admin Console

You can access the Keycloak Admin Console via HTTP or HTTPS:

[source]
----
http://localhost:9080/admin/
https://localhost:9085/admin/
----

Login with the following credentials:

* Username: admin
* Password: admin

NOTE: When accessing Keycloak via HTTPS, your browser may warn about an untrusted certificate. This is expected as the container uses a self-signed certificate. You can safely proceed.

=== Testing the Processor with Keycloak

To test the MultiIssuerJWTTokenAuthenticator processor with Keycloak:

1. Drag the processor onto the canvas
2. Configure the processor with the following properties:
   * Set the JWKS URL to one of the following:
     ** HTTP: `http://keycloak:9080/realms/oauth_integration_tests/protocol/openid-connect/certs`
     ** HTTPS: `https://keycloak:9085/realms/oauth_integration_tests/protocol/openid-connect/certs`
   * Configure other properties as needed
3. Obtain a token from Keycloak using one of the following methods:
   * Use the Keycloak Admin Console to create a token
   * Use the token endpoint directly via HTTP: `http://localhost:9080/realms/oauth_integration_tests/protocol/openid-connect/token`
   * Use the token endpoint directly via HTTPS: `https://localhost:9085/realms/oauth_integration_tests/protocol/openid-connect/token`
   * Use curl to get a token via HTTP:
+
[source,bash]
----
curl -X POST \
  http://localhost:9080/realms/oauth_integration_tests/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'grant_type=password&client_id=test_client&client_secret=yTKslWLtf4giJcWCaoVJ20H8sy6STexM&username=testUser&password=drowssap'
----
   * Use curl to get a token via HTTPS (with certificate validation disabled):
+
[source,bash]
----
curl -X POST -k \
  https://localhost:9085/realms/oauth_integration_tests/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'grant_type=password&client_id=test_client&client_secret=yTKslWLtf4giJcWCaoVJ20H8sy6STexM&username=testUser&password=drowssap'
----
4. Use the token in your NiFi flow to test the processor
5. Connect the processor to other processors as needed
6. Start the flow and observe the results

=== Stopping the Test Environment

To stop the test environment:

1. Navigate to the project root directory
2. Run the helper script:

[source,bash]
----
./integration-testing/src/main/docker/stop-test-container.sh
----

This script will stop and remove the Docker containers.

== Troubleshooting

=== Containers Fail to Start

If either container fails to start, check the Docker logs:

[source,bash]
----
docker compose -f src/main/docker/docker-compose.yml logs
----

You can also check logs for a specific service:

[source,bash]
----
docker compose -f src/main/docker/docker-compose.yml logs nifi
docker compose -f src/main/docker/docker-compose.yml logs keycloak
----

=== NAR File Not Found

If the NAR file is not found, ensure that the build process completed successfully:

[source,bash]
----
./mvnw clean package -DskipTests
----

=== Cannot Access NiFi UI

If you cannot access the NiFi UI:

1. Check that the container is running:

[source,bash]
----
docker ps | grep nifi
----

2. Check the container logs for any errors:

[source,bash]
----
docker compose -f src/main/docker/docker-compose.yml logs nifi
----

3. Ensure that port 9095 is not being used by another application.

=== Cannot Access Keycloak Admin Console

If you cannot access the Keycloak Admin Console:

1. Check that the container is running:

[source,bash]
----
docker ps | grep keycloak
----

2. Check the container logs for any errors:

[source,bash]
----
docker compose -f src/main/docker/docker-compose.yml logs keycloak
----

3. Ensure that ports 9080 and 9085 are not being used by another application.

=== Certificate-Related Issues

If you encounter certificate-related issues:

1. Verify that the certificates were generated correctly:

[source,bash]
----
./integration-testing/src/main/docker/verify-certificates.sh
----

2. Check that OpenSSL is installed and available in your PATH:

[source,bash]
----
which openssl
openssl version
----

3. If you need to regenerate the certificates, run the generate-certificates.sh script manually:

[source,bash]
----
cd integration-testing/src/main/docker
./generate-certificates.sh
cd ../../..
----

Remember that certificates must be manually generated before starting the containers. The run-test-container.sh script will check for the existence of the required certificates and will not start the containers if they are missing.

4. If you're still having issues, you can manually inspect the certificates:

[source,bash]
----
# For NiFi
keytool -list -v -keystore ./integration-testing/src/main/docker/nifi/conf/keystore.p12 -storetype PKCS12 -storepass keystorepassword
keytool -list -v -keystore ./integration-testing/src/main/docker/nifi/conf/truststore.p12 -storetype PKCS12 -storepass truststorepassword

# For Keycloak
openssl x509 -in ./integration-testing/src/main/docker/keycloak/certificates/localhost.crt -text -noout
----

=== Storage and Log Access

Since we're using ephemeral storage for most data, there are a few things to keep in mind:

1. All logs and data will be lost when the containers are stopped
2. You need to view logs while the containers are running
3. Any changes made in NiFi will be lost when the container is restarted

To view logs while the containers are running:

[source,bash]
----
# List all log files
docker compose exec nifi ls -la /opt/nifi/nifi-current/logs/

# View the application log
docker compose exec nifi cat /opt/nifi/nifi-current/logs/nifi-app.log

# View the bootstrap log
docker compose exec nifi cat /opt/nifi/nifi-current/logs/nifi-bootstrap.log

# View the user log
docker compose exec nifi cat /opt/nifi/nifi-current/logs/nifi-user.log

# Follow the application log (similar to tail -f)
docker compose exec nifi tail -f /opt/nifi/nifi-current/logs/nifi-app.log
----

NOTE: The storage configuration has been simplified to only include essential host-mounted directories for NiFi configuration and NAR deployment. All other data is stored in ephemeral container storage. This approach simplifies the setup and reduces resource usage.

=== Known Issues

There are some known issues with the Docker test environment:

1. [FIXED] NiFi may fail to start properly with a NullPointerException when trying to set the single user credentials. This is related to the login identity provider configuration. The issue has been fixed by removing the environment variables SINGLE_USER_CREDENTIALS_USERNAME and SINGLE_USER_CREDENTIALS_PASSWORD from the docker-compose.yml file and relying solely on the login-identity-providers.xml file for authentication.

2. Keycloak uses an in-memory database by design, which means all data is lost when the container is stopped. This is intentional to simplify the setup and reduce resource usage.

3. Certificate generation requires OpenSSL to be installed on the host system. If you encounter issues with certificate generation, ensure that OpenSSL is installed and available in your PATH.

4. If you encounter certificate-related issues, you can run the `verify-certificates.sh` script to check if the certificates are being used correctly by both NiFi and Keycloak.

5. [FIXED] NiFi may produce access-related exceptions when starting. This was due to missing or inaccessible repository directories. The issue has been fixed by configuring NiFi to use ephemeral storage.

6. [FIXED] NiFi may produce a `java.lang.reflect.InaccessibleObjectException` related to `sun.nio.ch.FileChannelImpl.setUninterruptible()`. This is due to Java module system restrictions in Java 9+ that prevent reflective access to internal JDK classes. The issue has been fixed by adding the `--add-opens=java.base/sun.nio.ch=ALL-UNNAMED` JVM argument to the bootstrap.conf file.

These issues are being investigated and will be addressed in a future update.

=== Cleaning Up

Since we're using ephemeral storage for most data, cleaning up is much simpler:

[source,bash]
----
# Stop the containers
./integration-testing/src/main/docker/stop-test-container.sh
----

This will stop and remove the containers. Since we're not using Docker volumes for persistent storage, all data will be automatically removed when the containers are stopped.

NOTE: Both NiFi and Keycloak use ephemeral storage, so all data is automatically cleared when the containers are stopped.

TIP: If you want to remove any Docker images that are no longer needed, you can use `docker system prune` to clean up unused Docker resources.

=== Realm Import Issues

If the Keycloak realm is not imported correctly:

1. Check the Keycloak logs for import errors:

[source,bash]
----
docker compose -f src/main/docker/docker-compose.yml logs keycloak
----

2. Verify that the realm configuration file is correctly formatted:

[source,bash]
----
cat src/main/docker/keycloak/oauth_integration_tests-realm.json
----

3. Try importing the realm manually through the Keycloak Admin Console.

=== Cannot Obtain Token from Keycloak

If you cannot obtain a token from Keycloak:

1. Verify that the Keycloak container is running and the realm is imported correctly
2. Check that you're using the correct client ID and secret
3. Verify that the user credentials are correct
4. Try accessing the token endpoint directly in a browser to see any error messages

== Development Workflow

For development and testing:

1. Make changes to the processor code
2. Build the NAR file:

[source,bash]
----
./mvnw clean package -DskipTests
----

3. The changes will be automatically available in the running container due to the volume mount

If you need to restart the container:

[source,bash]
----
# Stop the containers
./integration-testing/src/main/docker/stop-test-container.sh

# If you need to regenerate the certificates (optional)
cd integration-testing/src/main/docker
./generate-certificates.sh
cd ../../..

# Start the containers again
./integration-testing/src/main/docker/run-test-container.sh
----

NOTE: Remember that certificates must be manually generated before starting the containers. If you've already generated certificates and they haven't expired, you don't need to regenerate them.

== See Also

* link:../doc/Specification.adoc[Main Specification]
* link:../doc/Requirements.adoc[Requirements]
* link:../doc/specification/testing.adoc[Testing Specification]
* link:../doc/plan.adoc[Implementation Plan]
* link:../doc/library/cui-test-keycloak-integration/README.adoc[Keycloak Integration]
